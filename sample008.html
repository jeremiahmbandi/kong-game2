<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Kong (Treasure Hunt) Slot Machine</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Andada+Pro:ital,wght@0,400..840;1,400..840&family=Chakra+Petch:ital,wght@0,300;0,400;0,500;0,600;0,700;1,300;1,400;1,500;1,600;1,700&family=Noto+Serif:ital,wght@0,100..900;1,100..900&family=Victor+Mono:ital,wght@0,100..700;1,100..700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css" integrity="sha512-Evv84Mr4kqVGRNSgIGL/F/aIDqQb7xQ2vcrdIwxfjThSH8CSR7PBEakCr51Ck+w+/U6swU2Im1vVX0SVk9ABhg==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    
    <style>
        body {
            margin: 0;
            padding: 0;
            overflow: hidden;
            background: #2c2c2c;
            touch-action: manipulation;
            font-family: 'Victor Mono', monospace;
            font-optical-sizing: auto;
            font-weight: normal;
            font-style: normal;
        }
        @font-face {
            font-family: 'aldo';
            src: url('aldo_the_apache') format('truetype');
        }

        #game-container {
            width: 100%;
            height: 100vh;
            max-height: 100vh;
            display: flex;
            flex-direction: column;
            font-family: 'aldo', sans-serif;
        }
        .game-canvas-container {
            flex: 1;
            position: relative;
            height: 100%;
            width: 96%;
            margin: auto;
            overflow: hidden;
            z-index: 888;
        }
        .game-controls {
            margin: 0px !important;
            padding: 0px !important;
            width: 100%;
            background-image: url('assets/img/wood.png');
            border-radius: 12px 12px 0 0;
            z-index: 1000;
            bottom: 0 !important;
        }
        .control-group {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .spin-button, .autoplay-button {
            cursor: pointer;
            width: 100%;
            text-align: center;
            padding: 12px;
        }
        /* Responsive adjustments */
        @media (max-height: 600px) {
            .game-controls {
                padding: 5px;
            }
            .control-group {
                gap: 5px;
            }
            .input-group {
                margin-bottom: 5px;
            }
        }
        /* Prevent text selection */
        * {
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }
        /* Allow input in number fields */
        input[type="number"] {
            -webkit-user-select: auto;
            -moz-user-select: auto;
            -ms-user-select: auto;
            user-select: auto;
        }
        #jdb_overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: black;
            z-index: 2002;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        #kong_overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: url('assets/img/kong_bg.jpg');
            background-size: cover;
            background-repeat: repeat;
            background-color: black;
            z-index: 2001;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        /* Stake button and overlay styles */
        .overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 1);
            z-index: 2000;
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        .overlay-content {
            border-radius: 12px;
            width: 90%;
            max-width: 400px;
            padding: 20px;
            margin-top: 100px;
        }
        .overlay-content-stake {
            border-radius: 12px;
            width: 100%;
            max-width: 400px;
            padding: 20px;
            margin-top: 100px;
        }
        .overlay-header {
            color: #e4d594;
            text-align: center;
            margin-bottom: 20px;
            font-size: 1.5rem;
            font-weight: bold;
        }
        .options-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
        }
        .option-button {
            background: linear-gradient(to bottom, #353333, #272525);
            color: white;
            border: none;
            border-radius: 8px;
            padding: 15px 0;
            font-size: 1.2rem;
            cursor: pointer;
            transition: all 0.2s;
        }
        .option-button:hover, .option-button.selected {
            background-color: #25282b;
            box-shadow: 
                inset 0 0 0 2px rgba(0, 0, 0, 0.15),
                0 0 0 2px rgba(0, 0, 0, 0.15),
                inset 0 0 0.875rem #FCEAAC,
                0 0 0.875rem #FCEAAC;
        }
        .overlay-footer {
            width: inherit;
            display: flex;
            justify-content: space-around;
            margin-top: 20px;
            padding-bottom: 50px;
            bottom: 0;
            position: absolute;
        }
        .overlay-footer-stake {
            margin-top: 20px;
            padding-bottom: 50px;
            bottom: 0;
            position: absolute;
        }
        .overlay-footer button {
            padding: 8px 16px;
            border-radius: 4px;
            border: none;
            cursor: pointer;
        }
        .cancel-button {
            background-color: #333;
            color: white;
        }
        .confirm-button {
            background-color: #333;
            box-shadow: 0 0 4px #e4d594;
            color: white;
        }
        .divider-container {
            color: #e4d594;
        }
        .divider {
            height: 2px;
            background-color: #e4d594;
            width: 30vw;
        }
        .divider-text {
            margin: 0 10px;
        }
        .divider-wrapper {
            display: flex;
            justify-content: center;
            align-items: center;
            width: 100%;
            margin: 16px 0;
        }
        .check-icon {
            display: inline-block;
            width: 16px;
            height: 16px;
            margin-left: 4px;
            position: relative;
        }
        .check-icon:before {
            content: '';
            position: absolute;
            width: 8px;
            height: 12px;
            border-right: 2px solid white;
            border-bottom: 2px solid white;
            transform: rotate(45deg);
            top: 0;
            left: 4px;
        }
        
        .victor-mono {
            font-family: "Victor Mono", monospace;
            font-optical-sizing: auto;
            font-weight: normal;
            font-style: normal;
        }

        /* Settings overlay styles */
        .sound-option {
            color: white;
        }
        .icon-container {
            font-size: 1.5rem;
            display: inline-block;
            width: 30px;
            text-align: center;
        }
        .loader-container {
            height: 10px;
            background: rgba(0, 0, 0, 0.1);
            border-radius: 12px;
        }
        .loader-bar {
            height: 100%;
            width: 0;
            transition: width 0.3s ease;
        }
        .glowing-button {
            position: absolute; /* Ensure ::after is positioned relative to this */
            bottom: 9%;
            padding: 6px 50px;
            font-size: 18px;
            font-weight: bold;
            color: white;
            cursor: pointer;
            border-radius: 12px;
            border-width: 5px;
            border-style: solid;
            border-color: #c09c0e;
            background-color: #fada60;
            font-weight: bold;
            text-shadow: 
                -1px -1px 0 orange,  
                1px -1px 0 orange,
                -1px  1px 0 orange,
                1px  1px 0 orange;
            overflow: hidden; /* Prevents the light effect from overflowing */
        }

        /* Light reflection effect */
        .glowing-button::after {
            content: "";
            position: absolute;
            top: 0;
            left: -100%;
            width: 200%; /* Reduce width to prevent excessive overflow */
            height: 100%;
            background: linear-gradient(
                100deg,
                rgba(255, 255, 255, 0) 40%,
                rgba(255, 255, 255, 0.4) 50%,
                rgba(255, 255, 255, 0) 60%
            );
            animation: light-sweep 2s infinite linear;
        }

        @keyframes light-sweep {
            0% {
                left: -100%;
            }
            100% {
                left: 100%;
            }
        }

        /* Free spins indicator */
        .free-spins-indicator {
            position: absolute;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            background-color: rgba(192, 156, 14, 0.8);
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 1.0rem;
            font-weight: bold;
            z-index: 100;
            display: none;
        }

        /* Win message */
        .win-message {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: rgba(0, 0, 0, 0.7);
            color: #fada60;
            padding: 15px 30px;
            border-radius: 10px;
            text-align: center;
            font-size: 1.5rem;
            font-weight: bold;
            animation: bounce 1s infinite;
            z-index: 100;
            display: none;
        }

        .mobile-wrapper {
            max-width: 100vw;
            max-height: 100vh;
        }
        .autoplay-button, .stake-button{
            height: 70px;
            width: 70px;
        }
        .spin-img{
            height: 55px;
            width: 55px;
        }
        .spin-button{
            height: 85px;
            width: 85px;
        }
        .autospininner-img{
            height: 30px;
            width: 30px;
        }
        .autospininnerimgstop{
            height: 25px;
            width: 25px;
        }
        .totalbetinner-img{
            height: 25px;
        }
        .current-stake{
            font-size: 1.2rem;
            color: #f6d64e;
        }
        #playground{
            height: 35vh;
        }
        .fs-text-image{
            max-height: 25px;
        }
        #remaining_fs_holder, #total_fs_holder{
            color: #8cc904;
            font-size: 2.0rem;
            font-weight: bold;
        }

        @media screen and (min-width: 900px) {
            .sunburst-container {
                position: absolute;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                width: 80vw;
                max-width: 600px;
                height: 80vw;
                max-height: 600px;
                z-index: 10; /* Higher than coins */
                display: flex;
                align-items: center;
                justify-content: center;
                overflow: visible;
                pointer-events: none;
            }
            #jdb_overlay {
                max-width: 320px;
                max-height: 5100px;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                left: 50%;
                transform: translate(-50%, -0%);
                background-color: black;
                z-index: 2002;
                flex-direction: column;
                align-items: center;
                justify-content: center;
            }
            #kong_overlay {
                max-width: 320px;
                max-height: 5100px;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                left: 50%;
                transform: translate(-50%, -0%);
                background-image: url('assets/img/kong_bg.jpg');
                background-size: contain;
                background-repeat: no-repeat;
                background-color: black;
                z-index: 2001;
                flex-direction: column;
                align-items: center;
                justify-content: center;
            }
            .overlay {
                position: absolute;
                max-width: 320px;
                max-height: 5100px;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                left: 50%;
                transform: translate(-50%, -0%);
                background-color: rgba(0, 0, 0, 1);
                z-index: 2000;
                display: none;
                flex-direction: column;
                align-items: center;
                justify-content: center;
            }
            #playground{
                max-height: 200px;
                width: 100%;
            }
            .mobile-wrapper {
                max-width: 320px;
                max-height: 490px;
            }
            .autoplay-button, .stake-button{
                height: 55px;
                width: 55px;
            }
            .spin-img{
                height: 45px;
                width: 45px;
            }
            .spin-button{
                height: 70px;
                width: 70px;
            }
            .autospininner-img{
                height: 30px;
                width: 30px;
            }
            .autospininnerimgstop{
                height: 25px;
                width: 25px;
            }
            .totalbetinner-img{
                height: 21px
            }
            .current-stake{
                font-size: 1.0rem;
                color: #f6d64e;
            }
            .fs-text-image{
                max-height: 20px;
            }
            #remaining_fs_holder, #total_fs_holder{
                color: #8cc904;
                font-size: 1.5rem;
                font-weight: bold;
            }
        }

        .btn-gold {
            background-color: #b8860b;
            color: white;
            border: none;
            font-weight: bold;
            transition: background-color 0.3s;
        }

        .btn-gold:hover {
            background-color: #a67c00;
            color: white;
        }

        #winOverlay{
            position: absolute;
            width: 100%;
            min-height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            z-index: 2000;
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        #closeBtn {
            position: absolute;
            top: 20px;
            right: 20px;
            background: none;
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
            padding: 8px;
            z-index: 20;
        }

        .win-content {
            position: relative;
            text-align: center;
            z-index: 15;
        }

        /* Rotating sunburst effect */
        .sunburst-container {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 100vw;
            max-width: 600px;
            height: 80vw;
            max-height: 600px;
            z-index: 10; /* Higher than coins */
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: visible;
            pointer-events: none;
        }

        .sunburst {
            width: 100%;
            height: 100%;
            background-image: url('assets/img/effects/sunburst.png');
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
            animation: rotate 10s linear infinite;
        }

        /* Colored overlays for different win levels */
        .big-win-color {
            filter: none;
        }

        .mega-win-color {
            filter: none; /* Original gold/yellow color */
        }

        .ultra-win-color {
            filter: none;
        }

        @keyframes rotate {
            0% {
                transform: rotate(0deg);
            }
            100% {
                transform: rotate(360deg);
            }
        }

        .win-text {
            font-size: calc(2rem + 2vw);
            font-weight: bold;
            margin-bottom: 16px;
            text-shadow: 0 0 10px currentColor, 0 0 20px currentColor;
            animation: text-flicker 2s infinite;
            transition: color 0.5s, transform 0.5s;
            position: relative;
            z-index: 20;
        }

        .counter-text {
            font-size: calc(0.5rem + 2vw);
            font-weight: bold;
            color: #a67c00;
            text-shadow: 0 0 10px rgba(255, 215, 0, 0.7), 0 0 20px rgba(255, 215, 0, 0.5);
            animation: pulse 1.5s infinite;
            position: relative;
            z-index: 20;
        }

        #coinsContainer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            pointer-events: none;
            z-index: 5; /* Lower than sunburst */
        }

        .coin {
            position: absolute;
            filter: drop-shadow(0 0 5px rgba(255, 215, 0, 0.7));
            transition: transform 0.05s ease-out;
            z-index: 5; /* Lower than sunburst */
        }

        /* Win level styles */
        .big-win {
            color: #ffd700;
        }

        .mega-win {
            color: #ffd700;
        }

        .ultra-win {
            color: #ffd700;
        }

        @keyframes text-flicker {
            0%, 100% {
                opacity: 1;
                text-shadow: 0 0 10px currentColor, 0 0 20px currentColor;
            }
            50% {
                opacity: 0.9;
                text-shadow: 0 0 15px currentColor, 0 0 25px currentColor;
            }
        }

        @keyframes pulse {
            0%, 100% {
                transform: scale(1);
            }
            50% {
                transform: scale(1.05);
            }
        }

        @keyframes scale-in {
            0% {
                transform: scale(0.5);
                opacity: 0;
            }
            100% {
                transform: scale(1);
                opacity: 1;
            }
        }

        .scale-in {
            animation: scale-in 0.5s forwards;
        }

        /* Game info overlay */
        #gameinfo_overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: black;
            z-index: 2002;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            overflow: auto;
            display: none;
        }

        /* Features overlay */
        #featuresOverlay {
            display: none;
            z-index: 9999;
            position: absolute;
            height: 100%;
            width: 100%;
            background-color: rgb(0,0,0,0.8);
        }

        /* Device overlay */
        #device_overlay {
            display: none;
        }

        /* Free spins overlay */
        #freespinsoverlay {
            display: none;
            position: absolute;
            top: 0;
            left: 0;
            background-color: rgba(0, 0, 0, 0.8);
            height: 100%;
            width: 100%;
            z-index: 999999;
        }

        /* Start free spins overlay */
        #startfreespinsoverlay {
            display: none;
            position: absolute;
            top: 0;
            left: 0;
            height: 100%;
            width: 100%;
            z-index: 999999;
        }

        /* Canvas styles */
        canvas {
            display: block;
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }
    </style>
</head>
<body class="w-100">
<div style="background-image: url('assets/img/jungle-bg.jpg'); background-size: cover; height: 100vh; padding: 0 !important;">
    <div style="z-index: 3; position: absolute;">
        <button id="featuresButton" class="btn btn-warning mt-5 mb-2 mx-3">
            Feature
        </button>
    </div>
    <div id="featuresOverlay">
       <div style="height: 100%; width: 100%; font-weight: bold;" class="d-flex justify-content-center align-items-center">
            <div class="mx-auto">
                <div class="mx-auto">
                    <button onclick="setDemoFeature('big spin')" class="btn btn-warning btn-lg my-2 mb-2 mx-3">
                        Feature 1
                    </button>
                </div>
                <div class="mx-auto">
                    <button onclick="setDemoFeature('big win')" class="btn btn-warning btn-lg my-2 mx-3">
                        Feature 2
                    </button>
                </div>
                <div class="mx-auto">
                    <button onclick="setDemoFeature('free spins')" class="btn btn-warning btn-lg my-2 mb-2 mx-3">
                        Feature 3
                    </button>
                </div>
            </div>
       </div>
    </div>

    <div id="gameinfo_overlay" class="mx-auto">
        <div class="divider-container">
            <div class="divider-wrapper">
                <div class="divider-text h3">GAME RULE</div>
            </div>
        </div>
        <div class="d-flex justify-content-center align-items-center">
            <div style="width: 90%; background-color: #e4d594; height: 5px;"></div>
        </div>
        <div class="" style="color: white;">
            <div style="border: 1px; border-color: #e4d594; font-size: 1.0rem; border-style: solid;" class="py-4 mx-3 d-flex justify-content-center align-items-around my-3">
                <div class="px-2">
                    <span style="color: #e4d594;"> Denomination:</span> 0.01
                </div>
                <div class="px-2">
                    <span style="color: #e4d594;">Bet Multiplier:</span> 1
                </div>
            </div>
            <div class="row px-3">
                <div class="col-lg-3 col-md-12 col-sm-12 text-center px-4" style="font-weight: bold;">
                    <img src="assets/img/symbols/wild.png" style="max-width: 100px;" alt="">
                    <div class="h3">WILD</div>
                </div>
                <div class="col-lg-9 col-md-12 col-lg-12" style="font-weight: bold;">
                    ONLY APPEARS ON REELS 2,3,4 AND 5.
                    <br>
                    <br>
                    <div class="d-flex justify-content-start align-items-center">
                        SUBSTITUTES FOR ALL SYMBOLS EXCEPT <img style="width: 40px; height: auto;" src="assets/img/symbols/scatter.png" alt="">
                    </div>
                </div>
            </div>

            <div class="row px-3 my-3">
                <div class="col-lg-3 col-md-12 col-sm-12 text-center px-4 mb-3">
                    <img src="assets/img/symbols/scatter.png" style="max-width: 100px;" alt="">
                    <div class="h3">FREE SPIN BONUS</div>
                </div>
                <div class="col-lg-9 col-md-12 col-lg-12" style="font-weight: bold;">
                    APPEARS ON ALL REELS
                    <br>
                    <div class="">
                        IF ATLEAST ONE <img style="width: 40px; height: auto;" src="assets/img/symbols/scatter.png" alt=""> APPEARS ON ALL REELS FREE SPIN BONUS WITH 13 FREE SPINS AND A BONUS MULTIPLIER WILL BE TRIGGERED 
                    </div>

                    <div class="mt-4">
                        <div class="my-1">
                            5 <img style="width: 40px; height: auto;" class="px-1" src="assets/img/symbols/scatter.png" alt=""> AWARD 3X BONUS MULTIPLIER
                        </div>
                        <div class="my-1">
                            6 <img style="width: 40px; height: auto;" class="px-1" src="assets/img/symbols/scatter.png" alt=""> AWARD 6X BONUS MULTIPLIER
                        </div>
                        <div class="my-1">
                            7 <img style="width: 40px; height: auto;" class="px-1" src="assets/img/symbols/scatter.png" alt=""> AWARD 12X BONUS MULTIPLIER
                        </div>
                        <div class="my-1">
                            8 <img style="width: 40px; height: auto;" class="px-1" src="assets/img/symbols/scatter.png" alt=""> AWARD 24X BONUS MULTIPLIER
                        </div>
                        <div class="my-1">
                            9 <img style="width: 40px; height: auto;" class="px-1" src="assets/img/symbols/scatter.png" alt=""> AWARD 36X BONUS MULTIPLIER
                        </div>
                        <div class="my-1">
                            10 <img style="width: 40px; height: auto;" class="px-1" src="assets/img/symbols/scatter.png" alt=""> AWARD 72X BONUS MULTIPLIER
                        </div>
                    </div>
                </div>
            </div>

            <div class="divider-container">
                <div class="divider-wrapper">
                    <div class="divider-text h2" style="font-weight: bold;">PAYTABLE</div>
                </div>
            </div>

            <div class="d-flex justify-content-center align-items-center">
                <div style="width: 90%; background-color: white; height: 2px;"></div>
            </div>

            <div class="row my-4" style="font-size: 1.1rem; font-weight: bold;">
                <div class="my-3 col-12 col-lg-4 col-dm-4 col-sm-12 d-flex justify-content-center align-items-center align-items-center mx-2">
                    <img src="assets/img/symbols/treasure.png" style="max-width: 100px;" alt="">
                    <div class="px-4">
                        <div class="my-1">
                            <span style="color: #e4d594; font-weight: bold;">5 - </span> 250
                        </div>
                        <div class="my-1">
                            <span style="color: #e4d594; font-weight: bold;">4 - </span> 100
                        </div>
                        <div class="my-1">
                            <span style="color: #e4d594; font-weight: bold;">3 - </span> 40
                        </div>
                    </div>
                </div>
                <div class="col-12 my-3 col-lg-4 col-dm-4 col-sm-12 d-flex justify-content-center align-items-center align-items-center mx-2">
                    <img src="assets/img/symbols/explorer.png" style="max-width: 100px;" alt="">
                    <div class="px-4">
                        <div class="my-1">
                            <span style="color: #e4d594; font-weight: bold;">5 - </span> 200
                        </div>
                        <div class="my-1">
                            <span style="color: #e4d594; font-weight: bold;">4 - </span> 80
                        </div>
                        <div class="my-1">
                            <span style="color: #e4d594; font-weight: bold;">3 - </span> 30
                        </div>
                    </div>
                </div>
                <div class="col-12 my-3 col-lg-4 col-dm-4 col-sm-12 d-flex justify-content-center align-items-center align-items-center mx-2">
                    <img src="assets/img/symbols/compass.png" style="max-width: 100px;" alt="">
                    <div class="px-4">
                        <div class="my-1">
                            <span style="color: #e4d594; font-weight: bold;">5 - </span> 175
                        </div>
                        <div class="my-1">
                            <span style="color: #e4d594; font-weight: bold;">4 - </span> 60
                        </div>
                        <div class="my-1">
                            <span style="color: #e4d594; font-weight: bold;">3 - </span> 25
                        </div>
                    </div>
                </div>
            </div>

            <div class="text-center py-3 w-100" style="position: fixed; bottom: 0; background-color: #191818; color: white; font-size: 1.0rem; z-index: 9999; margin: 0 !important;">
                <div>
                    MALFUNCTION VOIDS ALL PLAYS AND PAYS.
                </div>
                <div class="my-2 d-flex justify-content-center align-items-center">
                    <div class="d-flex justify-content-center align-items-center" style="height: 45px; width: 45px; border-radius: 50%; border-color: white; border-style: solid;">
                        <i id="close_info_button" class="fa fa-arrow-left fa-2x py-2 px-2"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="mobile-wrapper mx-auto">
        <div id="device_overlay">
            <div class="d-flex flex-column justify-content-center align-items-center text-center p-4" 
                style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.99); color: white; font-size: 1.5rem; text-align: center; z-index: 9999; display: flex;">
                <div class="container">
                    <h2 class="fw-bold">FOR AN OPTIMAL GAMING EXPERIENCE</h2>
                    <p class="lead">USE A MOBILE DEVICE</p>
                    <div class="my-3 text-center my-3">
                        <i class="fa fa-mobile-alt fa-3x"></i>
                    </div>
                </div>
            </div>
        </div>

        <div id="winOverlay" class="mobile-wrapper">
            <button id="closeBtn" class="btn-close btn-close-white" aria-label="Close"></button>
            <div id="coinsContainer"></div>
            <div class="sunburst-container">
                <div id="sunburst" class="sunburst mega-win-color"></div>
            </div>
            <div class="win-content">
                <h2 id="winText" class="win-text big-win">BIG WIN</h2>
                <div class="counter-text" id="winAmount">$0</div>
            </div>
        </div>
        
        <div id="jdb_overlay">
            <div style="height: 100%; width: 100%;" class="d-flex justify-content-center align-items-center">
                <div class="row">
                    <div class="d-flex justify-content-center align-items-center mx-auto">
                        <div>
                            <img src="assets/img/jdb_logo.png" style="max-width: 100%;" alt="mx-auto">
                            <div class="d-flex justify-content-center mx-auto">
                                <div class="loader-container" style="width: 50%; border-style: solid; border-width: 1px; border-radius: 12px;">
                                    <div class="loader-bar" style="border-radius: 12px;" id="loader-bar"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    
        <div id="kong_overlay">
            <div class="d-flex justify-content-center">
                <button class="glowing-button text-white" onclick="hideKongOverlay()">START</button>
            </div>
        </div>
    
        <div id="game-container" class="victor-mono">
            <div>
                <img id="img_top" src="assets/img/top.png" style="width: 100%; height: auto;" alt="">
                <img id="img_top_volcano_part_1" src="assets/img/volcano_p1.png" style="width: 100%; height: auto; display: none;" alt="">
                <img id="img_top_volcano_part_2" src="assets/img/volcano_p2.png" style="width: 100%; height: auto; display: none;" alt="">
            </div>
            <div id="playground" style="position: relative; overflow: hidden; background: url('assets/img/jungle-bg.jpg'); min-height: 35vh; width: 100%; background-size: cover; z-index: 99; padding-top: 10px;">
                <!-- Start Free Spins Overlay -->
                <div id="startfreespinsoverlay">
                    <div class="d-flex justify-content-center align-items-center" style="height: 100%; width: 100%;">
                        <div id="startfreespinsbutton" class="py-1 px-3 text-white" style="border-radius: 6px; border: 2px white solid; font-size: 0.75rem; background-color: rgba(0, 0, 0, 0.8);">
                            PRESS REEL TO START THE BONUS
                        </div>
                    </div>
                </div>

                <!-- Free Spins Overlay -->
                <div id="freespinsoverlay">
                    <div class="py-3 px-3 d-flex justify-content-center align-items-center" style="height: 100%; width: 100%;">
                        <img class="py-2 px-2" id="freespinsoverlayimg" src="assets/img/fs_alert.png" style="width: 85%; height: auto;" alt="">
                        <img class="py-2 px-2" id="freespinsoverlayimg2" src="assets/img/fs_alert_additional.png" style="display: none; width: 85%; height: auto;" alt="">
                    </div>
                </div>

                <!-- Game Canvas Content -->
                <div class="game-canvas-container">
                    <!-- Free Spins Indicator -->
                    <div id="free-spins-indicator" class="free-spins-indicator">
                        FREE SPINS: <span id="free-spins-count">0</span> | MULTIPLIER: <span id="bonus-multiplier">0</span>x
                    </div>

                    <!-- Win Message -->
                    <div id="win-message" class="win-message">
                        <div>BIG WIN!</div>
                        <div id="win-amount">0.00</div>
                    </div>
                    
                    <!-- Canvas for the slot machine -->
                    <canvas id="slotMachine"></canvas>
                </div>
            </div>

            <!-- Controls -->
            <div class="game-controls p-2">
                <div id="results_holder" class="w-100 text-center text-white d-flex justify-content-center align-items-center" style="background-image: url('assets/img/wood.png'); background-size: cover; height: 30px; font-size: 1.3rem;">
                    <div style="margin: 5px 0px;">
                        WIN <span class="px-1" id="update_winnings">0.00</span>
                    </div>
                </div>
                <div id="freespins_display" style="display: none; justify-content: center; align-items: center; padding-top: 2px; max-width: 100%; height: 100px;">
                    <img class="fs-text-image" src="assets/img/fs_text.png" alt="">
                    <span class="px-3" id="remaining_fs_holder">0</span>
                    <img class="fs-text-image" src="assets/img/of_text.png" alt="">
                    <span class="px-3" id="total_fs_holder">0</span>
                </div>
                <div id="normalspins_display" style="display: flex; justify-content: center; align-items: center; padding-top: 2px">
                    <div id="autoPlayButton" class="rounded-circle d-flex justify-content-center align-items-center autoplay-button" style="background-image: url('assets/img/button_bg.png'); background-size: cover;">
                        <img src="assets/img/autospin_icon.png" class="autospininner-img" alt="">
                    </div>
                    <div id="spinButton" class="mx-4 d-flex justify-content-center align-items-center spin-button" style="border-radius: 50%; background-image: url('assets/img/button_bg.png'); background-size: cover;">
                        <div id="remainingAutoSpins" style="z-index: 2; position: absolute; color: darkorange; font-weight: bolder; font-size: 1.5rem;">
                        </div>
                        <div class="d-flex justify-content-center align-items-center spin-img" id="spin_img" style="background: url('assets/img/spin_icon.png'); background-size: cover;">
                        </div>
                    </div>
                    
                    <!-- Stake button that opens the overlay -->
                    <div id="stakeButton" class="text-center d-flex justify-content-center align-items-center stake-button" style="background-image: url('assets/img/button_bg.png'); background-size: cover; color: orange; font-size: 0.85rem; line-height: 1; font-weight: 900; border-radius: 50%;">
                        <div>
                            <div class="d-flex justify-content-center">
                                <img src="assets/img/bet_icon.png" class="totalbetinner-img" alt="">
                            </div>
                            <div class="text-center">
                                <span id="currentStake" class="current-stake">0.3</span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="container mb-2">
                    <div style="display: flex; width: 100%; position: relative; align-items: center;">
                        <div id="settingsButton" style="border-radius: 50%; width: 50px; height: 50px; background-image: url('assets/img/settings_icon.png'); background-size: cover;">
                        </div>

                        <!-- Button at the center -->
                        <div style="position: absolute; left: 50%; transform: translateX(-50%); text-align: center;">
                            <span class="text-center">
                                <span class="badge px-4 py-2 text-white" style="background-color: rgba(0,0,0,0.7);">CREDIT: <span id="balanceText">...</span></span>
                                <br>
                                <span class="text-white text-center" style="font-size: 1.0rem;">
                                    &lt; <span>DEMO GAME</span> &gt;
                                </span>
                            </span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    
        <!-- Stake Selection Overlay -->
        <div id="stakeOverlay" class="overlay" style="margin: 0 !important; padding: 0 !important;">
            <div class="divider-container">
                <div class="divider-wrapper">
                    <div class="divider"></div>
                    <div class="divider-text">TOTAL BET</div>
                    <div class="divider"></div>
                </div>
            </div>
            <div class="overlay-content-stake">
                <div class="overlay-header">FUN</div>
                <div class="options-grid mx-auto" id="stakeOptions">
                    <button class="option-button" data-value="3.0">3.0</button>
                    <button class="option-button" data-value="1.5">1.5</button>
                    <button class="option-button" data-value="0.9">0.9</button>
                    <button class="option-button" data-value="0.6">0.6</button>
                    <button class="option-button selected" data-value="0.3">0.3</button>
                </div>
                <div class="text-center text-white mt-5 pt-5">
                    <span style="margin-left: 20px;">
                        Reels: 5
                    </span>
                </div>
                <div class="overlay-footer w-100">
                    <button style="display: none;" class="cancel-button px-4" id="cancelStake">Cancel</button>
                    <button class="confirm-button px-5" id="confirmStake">OK</button>
                </div>
            </div>
        </div>
    
        <!-- Auto Spin Overlay -->
        <div id="autoSpinOverlay" class="overlay">
            <div class="divider-container">
                <div class="divider-wrapper">
                    <div class="divider"></div>
                    <div class="divider-text">AUTOPLAYS</div>
                    <div class="divider"></div>
                </div>
            </div>
            <div class="overlay-content w-100" style="margin-top: 20px !important;">
                <div class="mb-2 text-white">
                    NUMBER OF SPINS
                </div>
                <div class="options-grid" id="autoSpinOptions">
                    <button class="option-button" data-value="0"><i class="fa fa-stop"></i></button>
                    <button class="option-button" data-value="999">999</button>
                    <button class="option-button" data-value="200">200</button>
                    <button class="option-button" data-value="100">100</button>
                    <button class="option-button" data-value="30">30</button>
                </div>
                
                <div class="mt-4 mb-2 text-white">
                    LOSS LIMIT
                </div>
                <div class="options-grid" id="lossLimitOptions">
                    <button class="option-button" data-value="Infinity"><i class="fa fa-infinity"></i></button>
                    <button class="option-button" data-value="500">500<span style="font-size: 0.7rem;">x BET</span></button>
                    <button class="option-button" data-value="100">100<span style="font-size: 0.7rem;">x BET</span></button>
                    <button class="option-button" data-value="50">50<span style="font-size: 0.7rem;">x BET</span></button>
                    <button class="option-button" data-value="10">10<span style="font-size: 0.7rem;">x BET</span></button>
                </div>
                <div class="divider-container my-3">
                    <div class="divider-wrapper">
                        <div style="height: 2px; background-color: #e4d594; width: 25vw;"></div>
                        <div class="divider-text">QUICK SPIN</div>
                        <div style="height: 2px; background-color: #e4d594; width: 25vw;"></div>
                    </div>
                </div>
                <div class="d-flex justify-content-center align-items-center">
                    <img id="quickspin-toggle" src="assets/img/quickspin_toggle_off.png" style="height: 60px; width: 60px;" alt="">
                </div>
                <div class="overlay-footer">
                    <button class="cancel-button" id="cancelAutoSpin">Cancel</button>
                    <button class="confirm-button px-5" id="confirmAutoSpin">Ok</button>
                </div>
            </div>
        </div>
    
        <!-- Settings Overlay -->
        <div id="settingsOverlay" class="overlay" style="background-color: rgb(0,0,0,0.8); margin: 0 !important; padding: 0 !important;">
            <div class="overlay-content w-100" style="height: 100%; margin: 0 !important; padding: 0 !important;">
                <div>
                    <div style="display: none;">
                        <div class="d-flex justify-content-center">
                            <div id="soundEffectsOption" class="sound-option selected mx-auto">
                                <div>
                                    <span id="soundEffectsIcon" class="icon-container">🔊</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="overlay-footer" style="background-image: url('assets/img/wood.png'); background-size: cover; margin: 0 !important; padding: 0 !important;">
                <div class="w-100 mb-2">
                    <div class="d-flex justify-content-around align-items-center py-5 px-3 w-100">
                        <div id="info_button" class="sound-option selected">
                            <div class="d-flex justify-content-center align-items-center" style="color: #e4d594; width: 30px; height: 30px; border-radius: 50%; border-color: #e4d594; border-style: solid;">
                                <i class="fas fa-question" style="font-size: 1.2rem; font-weight: bold;"></i>
                            </div>
                        </div>
                        <div id="backgroundMusicOption" class="sound-option selected">
                            <div>
                                <span id="backgroundMusicIcon" class="icon-container">
                                    <i class="fa fa-volume-up" style="color: #e4d594; font-size: 1.4rem;"></i>
                                </span>
                            </div>
                        </div>
                    </div>
                    <div class="d-flex justify-content-center text-white">
                        <i class="fa fa-user px-1"></i> <span style="font-size: 0.7rem;">demo004817</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/pixi.js/7.4.0/pixi.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
    // Game configuration
    const REEL_COUNT = 5;
    const SYMBOLS_PER_REEL = 3;
    const SYMBOL_SIZE = 100;
    const REEL_WIDTH = SYMBOL_SIZE;
    const REEL_HEIGHT = SYMBOL_SIZE * SYMBOLS_PER_REEL;
    const WALL_THICKNESS = 50;
    const GAME_WIDTH = REEL_WIDTH * REEL_COUNT + WALL_THICKNESS * 2;
    const GAME_HEIGHT = REEL_HEIGHT + WALL_THICKNESS * 2;
    
    // Extra symbols to draw above and below visible area for smooth scrolling
    const EXTRA_SYMBOLS = 2;

    // Symbol definitions with colors for backgrounds
    const SYMBOLS = [
        { name: 'Treasure Chest', image: 'assets/img/symbols/treasure.png', color: '#ff5252', payouts: [0, 0, 40, 100, 250] },
        { name: 'Explorer', image: 'assets/img/symbols/explorer.png', color: '#ffeb3b', payouts: [0, 0, 30, 80, 200] },
        { name: 'Compass', image: 'assets/img/symbols/compass.png', color: '#ff9800', payouts: [0, 0, 25, 60, 175] },
        { name: 'Binoculars', image: 'assets/img/symbols/binoculars.png', color: '#9c27b0', payouts: [0, 0, 20, 50, 150] },
        { name: 'A', image: 'assets/img/symbols/A.png', color: '#f44336', payouts: [0, 0, 10, 20, 100] },
        { name: 'K', image: 'assets/img/symbols/K.png', color: '#4caf50', payouts: [0, 0, 8, 15, 90] },
        { name: 'Q', image: 'assets/img/symbols/Q.png', color: '#ffc107', payouts: [0, 0, 6, 12, 80] },
        { name: 'J', image: 'assets/img/symbols/J.png', color: '#2196f3', payouts: [0, 0, 5, 10, 70] },
        { name: 'Wild', image: 'assets/img/symbols/wild.png', color: '#00bcd4', payouts: [0, 0, 50, 125, 300] },
        { name: 'Scatter', image: 'assets/img/symbols/scatter.png', color: '#e91e63', payouts: [0, 0, 5, 20, 50] }
    ];

    // Wall colors (different backgrounds)
    const WALL_BACKGROUNDS = [
        '#3a0ca3', // top
        '#4361ee', // right
        '#4cc9f0', // bottom
        '#7209b7'  // left
    ];

    // Get canvas and context
    const canvas = document.getElementById('slotMachine');
    const ctx = canvas.getContext('2d');
    
    // Get DOM elements
    const spinButton = document.getElementById('spinButton');
    const autoPlayButton = document.getElementById('autoPlayButton');
    const stakeButton = document.getElementById('stakeButton');
    const settingsButton = document.getElementById('settingsButton');
    const featuresButton = document.getElementById('featuresButton');
    const featuresOverlay = document.getElementById('featuresOverlay');
    const remainingAutoSpins = document.getElementById('remainingAutoSpins');
    const spinButtonInnerImage = document.getElementById('spin_img');
    const balanceText = document.getElementById('balanceText');
    const currentStakeElement = document.getElementById('currentStake');
    const stakeOverlay = document.getElementById('stakeOverlay');
    const infoOverlay = document.getElementById('gameinfo_overlay');
    const closeInfoButton = document.getElementById('close_info_button');
    const infoButton = document.getElementById('info_button');
    const autoSpinOverlay = document.getElementById('autoSpinOverlay');
    const stakeOptions = document.getElementById('stakeOptions');
    const autoSpinOptions = document.getElementById('autoSpinOptions');
    const cancelStakeButton = document.getElementById('cancelStake');
    const confirmStakeButton = document.getElementById('confirmStake');
    const cancelAutoSpinButton = document.getElementById('cancelAutoSpin');
    const confirmAutoSpinButton = document.getElementById('confirmAutoSpin');
    const winMessageElement = document.getElementById('win-message');
    const winAmountElement = document.getElementById('win-amount');
    const freeSpinsIndicator = document.getElementById('free-spins-indicator');
    const freeSpinsCountElement = document.getElementById('free-spins-count');
    const bonusMultiplierElement = document.getElementById('bonus-multiplier');
    const settingsOverlay = document.getElementById('settingsOverlay');
    const soundEffectsOption = document.getElementById('soundEffectsOption');
    const backgroundMusicOption = document.getElementById('backgroundMusicOption');
    const soundEffectsIcon = document.getElementById('soundEffectsIcon');
    const backgroundMusicIcon = document.getElementById('backgroundMusicIcon');
    const startFreeSpinsOverlay = document.getElementById('startfreespinsoverlay');
    const startFreeSpinsButton = document.getElementById('startfreespinsbutton');
    const freeSpinsOverlay = document.getElementById('freespinsoverlay');
    const freeSpinsOverlayImg = document.getElementById('freespinsoverlayimg');
    const freeSpinsOverlayImg2 = document.getElementById('freespinsoverlayimg2');
    const quickspinToggleImg = document.getElementById('quickspin-toggle');
    const loaderBar = document.getElementById('loader-bar');
    const jdbOverlay = document.getElementById('jdb_overlay');
    const kongOverlay = document.getElementById('kong_overlay');
    const deviceOverlay = document.getElementById('device_overlay');
    const lossLimitOptions = document.getElementById('lossLimitOptions');

    // Game state
    let spinning = false;
    let reels = [];
    let finalResults = [];
    let winAmount = 0;
    let winAmountDisplay = 0;
    let winAnimationStartTime = 0;
    let isAnimatingWin = false;
    let symbolImages = {}; // Object to store loaded images
    let imagesLoaded = 0;
    let totalImages = SYMBOLS.length;
    let balance = 1000; // Starting balance
    let stake = 0.3; // Default bet amount
    let autoSpins = 0;
    let currentInterval;
    let selectedStake = 0.3; // Default stake value
    let selectedAutoSpins = 0; // Default auto spins value
    let initialBalance = 1000;
    let lossLimit = Infinity; // Default to no limit
    let selectedLossLimit = Infinity; // Default selected loss limit
    let autoSpinsStopped = true;
    let isQuickSpinMode = false;
    
    // Free spins state
    let freeSpinTriggeredRecently = false;
    let isFreeSpinMode = false;
    let freeSpinCount = 0;
    let remainingFreeSpinCount = 0;
    let bonusMultiplier = 0;
    let originalBetAmount = 0;
    
    // Sound control variables
    let soundEffectsEnabled = true;
    let backgroundMusicEnabled = true;
    let tempSoundEffectsEnabled = true;
    let tempBackgroundMusicEnabled = true;
    
    // Game mode
    const gameMode = {
        'mode': 'demo'
    };
    const currentDemoFeature = {
        "feature": "normal spin"
    };
    
    // Audio elements
    const backgroundMusic = new Audio();
    backgroundMusic.src = 'assets/sounds/bg_music.mp3';
    backgroundMusic.loop = true;
    backgroundMusic.volume = 0.5;
    backgroundMusic.preload = 'auto';

    const bigWinSound = new Audio();
    bigWinSound.src = 'assets/sounds/big_win.mp3';
    bigWinSound.loop = true;
    bigWinSound.volume = 0.8;

    const reelSpeedUpSound = new Audio();
    reelSpeedUpSound.src = 'assets/sounds/reel_speed_up.mp3';
    reelSpeedUpSound.loop = true;
    reelSpeedUpSound.volume = 0.9;

    const freeSpinSound = new Audio();
    freeSpinSound.src = 'assets/sounds/free_spin.mp3';
    freeSpinSound.loop = true;
    freeSpinSound.volume = 0.9;

    const spinSound = new Audio();
    spinSound.src = 'assets/sounds/spin.mp3';
    spinSound.preload = 'auto';
    
    const winSound = new Audio();
    winSound.src = 'assets/sounds/win.mp3';
    winSound.preload = 'auto';

    // Coin images for win animation
    const coinImages = [
        'assets/img/coins/coin1.png',
        'assets/img/coins/coin2.png',
        'assets/img/coins/coin3.png',
        'assets/img/coins/coin4.png'
    ];

    // Win level configurations
    const winLevels = {
        big: {
            text: 'BIG WIN',
            textClass: 'big-win',
            sunburstClass: 'big-win-color',
            threshold: 50,
            coinCount: 50
        },
        mega: {
            text: 'MEGA WIN',
            textClass: 'mega-win',
            sunburstClass: 'mega-win-color',
            threshold: 150,
            coinCount: 100
        },
        ultra: {
            text: 'ULTRA WIN',
            textClass: 'ultra-win',
            sunburstClass: 'ultra-win-color',
            threshold: Infinity,
            coinCount: 200
        }
    };

    // Resize canvas to fit container
    function resizeCanvas() {
        const container = document.querySelector('.game-canvas-container');
        canvas.width = container.clientWidth;
        canvas.height = container.clientHeight;
        
        // Redraw the game
        if (reels.length > 0) {
            drawGame();
        }
    }

    // Initialize loading screen
    function initLoading() {
        let progress = 0;

        function updateProgress() {
            progress += Math.random() * 10;

            if (progress > 100) progress = 100;

              {
            progress += Math.random() * 10;

            if (progress > 100) progress = 100;

            loaderBar.style.width = progress + "%";

            // Interpolate green from 165 (orange) to 140 (darkorange)
            let green = 165 - (progress / 100) * (165 - 140);
            loaderBar.style.backgroundColor = `rgb(255, ${green}, 0)`;

            if (progress < 100) {
                setTimeout(updateProgress, 500);
            } else {
                setTimeout(() => {
                    jdbOverlay.style.display = "none";
                }, 500);
            }
        }

        updateProgress();
    }

    }
    // Hide Kong overlay
    function hideKongOverlay() {
        kongOverlay.style.display = "none";
        // Try to play background music (will be blocked by browsers until user interaction)
        backgroundMusic.play().catch(e => console.log("Audio play failed:", e));
    }

    // Preload all symbol images
    function preloadImages() {
        SYMBOLS.forEach(symbol => {
            const img = new Image();
            img.crossOrigin = "anonymous"; // Avoid CORS issues
            img.onload = () => {
                imagesLoaded++;
                if (imagesLoaded === totalImages) {
                    // All images loaded, start the game
                    initGame();
                }
            };
            img.onerror = (err) => {
                console.error(`Error loading image for ${symbol.name}:`, err);
                // Create a fallback image with just the symbol color
                createColoredPlaceholder(symbol);
            };
            
            img.src = symbol.image;
            symbolImages[symbol.name] = img;
        });
    }

    // Create a colored placeholder image for a symbol
    function createColoredPlaceholder(symbol) {
        const placeholderCanvas = document.createElement('canvas');
        placeholderCanvas.width = SYMBOL_SIZE;
        placeholderCanvas.height = SYMBOL_SIZE;
        const placeholderCtx = placeholderCanvas.getContext('2d');
        
        // Draw colored background
        placeholderCtx.fillStyle = symbol.color;
        placeholderCtx.fillRect(0, 0, SYMBOL_SIZE, SYMBOL_SIZE);
        
        // Add some visual elements based on the symbol type
        placeholderCtx.fillStyle = 'rgba(255, 255, 255, 0.7)';
        
        // Draw text for the symbol name
        placeholderCtx.font = 'bold 20px Arial';
        placeholderCtx.textAlign = 'center';
        placeholderCtx.textBaseline = 'middle';
        placeholderCtx.fillText(symbol.name, SYMBOL_SIZE/2, SYMBOL_SIZE/2);
        
        // Create image from canvas
        const placeholderImg = new Image();
        placeholderImg.src = placeholderCanvas.toDataURL();
        symbolImages[symbol.name] = placeholderImg;
        
        imagesLoaded++;
        if (imagesLoaded === totalImages) {
            // All images loaded (including placeholders), start the game
            initGame();
        }
    }

    // Initialize the game
    function initGame() {
        // Resize canvas to fit container
        resizeCanvas();
        
        // Create initial reels
        for (let i = 0; i < REEL_COUNT; i++) {
            // Initialize each reel
            reels[i] = {
                position: 0,
                symbols: [],
                finalSymbols: [],
                isSpinning: false, // Track if this reel is currently spinning
                specialSymbols: {} // Track which symbols are special (larger with higher z-index)
            };
            
            // Generate initial symbols (visible + extra for scrolling)
            const totalSymbols = SYMBOLS_PER_REEL + EXTRA_SYMBOLS * 2;
            for (let j = 0; j < totalSymbols; j++) {
                const randomIndex = Math.floor(Math.random() * SYMBOLS.length);
                reels[i].symbols.push({
                    name: SYMBOLS[randomIndex].name,
                    isSpecial: Math.random() < 0.3, // 30% chance to be special
                    scale: Math.random() * 0.5 + 1.1 // Random scale between 1.1 and 1.6
                });
            }
            
            // Set initial final symbols (what will be shown when not spinning)
            reels[i].finalSymbols = reels[i].symbols.slice(EXTRA_SYMBOLS, EXTRA_SYMBOLS + SYMBOLS_PER_REEL);
        }
        
        // Draw initial state
        drawGame();
        
        // Update balance display
        displayBalance(balance);
        
        // Add event listeners
        spinButton.addEventListener('click', spin);
        autoPlayButton.addEventListener('click', toggleAutoPlay);
        stakeButton.addEventListener('click', showStakeOverlay);
        settingsButton.addEventListener('click', displaySettingsOverlay);
        featuresButton.addEventListener('click', showFeaturesOverlay);
        infoButton.addEventListener('click', showInfoOverlay);
        closeInfoButton.addEventListener('click', hideInfoOverlay);
        startFreeSpinsButton.addEventListener('click', startFreeSpins);
        quickspinToggleImg.addEventListener('click', toggleQuickSpin);
        
        // Add event listeners for overlays
        cancelStakeButton.addEventListener('click', hideStakeOverlay);
        confirmStakeButton.addEventListener('click', confirmStake);
        cancelAutoSpinButton.addEventListener('click', hideAutoSpinOverlay);
        confirmAutoSpinButton.addEventListener('click', confirmAutoSpin);
        
        // Add event listeners for settings
        backgroundMusicOption.addEventListener('click', toggleBackgroundMusic);
        
        // Add event listener for win overlay close button
        document.getElementById('closeBtn').addEventListener('click', closeWinAnimation);
        
        // Add window resize event listener
        window.addEventListener('resize', resizeCanvas);
        
        // Check if device is desktop
        if (window.innerWidth >= 900) {
            deviceOverlay.style.display = "none";
        }
    }

    // Display balance
    function displayBalance(amount) {
        balanceText.innerHTML = amount.toFixed(2);
    }

    // Show features overlay
    function showFeaturesOverlay() {
        featuresOverlay.style.display = "block";
    }

    // Set demo feature
    function setDemoFeature(feature) {
        isFirstSpin = true; // Set first spin to true to trigger the passed feature
        currentDemoFeature.feature = feature;
        featuresOverlay.style.display = "none";
        spin();
    }

    // Show info overlay
    function showInfoOverlay() {
        hideSettingsOverlay();
        if (!spinning && !isFreeSpinMode) {
            infoOverlay.style.display = 'block';
        }
    }

    // Hide info overlay
    function hideInfoOverlay() {
        infoOverlay.style.display = 'none';
    }

    // Show stake overlay
    function showStakeOverlay() {
        if (!spinning && !isFreeSpinMode) {
            stakeOverlay.style.display = 'block';
            
            // Highlight the currently selected stake
            const stakeOptionButtons = stakeOptions.querySelectorAll('.option-button');
            stakeOptionButtons.forEach(button => {
                const value = parseFloat(button.dataset.value);
                if (value === stake) {
                    button.classList.add('selected');
                } else {
                    button.classList.remove('selected');
                }
            });
        }
    }

    // Hide stake overlay
    function hideStakeOverlay() {
        stakeOverlay.style.display = 'none';
    }

    // Confirm stake selection
    function confirmStake() {
        stake = selectedStake;
        currentStakeElement.textContent = stake.toFixed(1);
        stakeOverlay.style.display = 'none';
    }

    // Toggle auto play
    function toggleAutoPlay() {
        if (spinning && !isFreeSpinMode) {
            if (autoSpins > 0) {
                autoSpinsStopped = true;
                updateAutoSpinStatus();
                remainingAutoSpins.innerHTML = '';
                autoSpins = 0;
            }
        }
        else if (!spinning && !isFreeSpinMode) {
            if (autoSpins > 0) {
                // Cancel auto spins
                autoSpinsStopped = true;
                updateAutoSpinStatus();
                autoSpins = 0;
            } else {
                autoSpinOverlay.style.display = 'block';
                
                // Highlight the currently selected auto spins
                const autoSpinOptionButtons = autoSpinOptions.querySelectorAll('.option-button');
                autoSpinOptionButtons.forEach(button => {
                    const value = parseInt(button.dataset.value);
                    if (value === selectedAutoSpins) {
                        button.classList.add('selected');
                    } else {
                        button.classList.remove('selected');
                    }
                });
            }
        }
    }

    // Hide auto spin overlay
    function hideAutoSpinOverlay() {
        autoSpinOverlay.style.display = 'none';
    }

    // Confirm auto spin selection
    function confirmAutoSpin() {
        if (selectedAutoSpins > 0) {
            autoSpins = selectedAutoSpins;
            lossLimit = selectedLossLimit;
            initialBalance = balance; // Store initial balance to track losses
            autoSpinOverlay.style.display = 'none';
            autoSpinsStopped = false;
            updateAutoSpinStatus();
            spin();
        }
        else {
            updateAutoSpinStatus();
            autoSpinOverlay.style.display = 'none';
        }
    }

    // Update auto spin status
    function updateAutoSpinStatus() {
        if (autoSpinsStopped) {
            selectedAutoSpins = 0;
            const autoSpinOptionButtons = autoSpinOptions.querySelectorAll('.option-button');
            autoSpinOptionButtons.forEach(button => {
                if (button.classList.contains('selected')) {
                    button.classList.remove('selected');
                }
            });
            autoPlayButton.innerHTML = `<img src="assets/img/autospin_icon.png" class="autospininner-img" alt="">`;
        }
        else {
            autoPlayButton.innerHTML = `<img src="assets/img/stop_icon.png" class="autospininnerimgstop" alt="">`;
        }
    }

    // Toggle quick spin
    function toggleQuickSpin() {
        isQuickSpinMode = !isQuickSpinMode;
        quickspinToggleImg.src = isQuickSpinMode ? 
            "assets/img/quickspin_toggle_on.png" : 
            "assets/img/quickspin_toggle_off.png";
    }

    // Display settings overlay
    function displaySettingsOverlay() {
        settingsOverlay.style.display = 'block';
    }

    // Hide settings overlay
    function hideSettingsOverlay() {
        settingsOverlay.style.display = 'none';
    }

    // Toggle background music
    function toggleBackgroundMusic() {
        backgroundMusicEnabled = !backgroundMusicEnabled;
        
        if (backgroundMusicEnabled) {
            backgroundMusicIcon.innerHTML = `<i class="fa fa-volume-up" style="color: #e4d594; font-size: 1.4rem;"></i>`;
            backgroundMusic.play();
        } else {
            backgroundMusicIcon.innerHTML = `<i class="fas fa-volume-mute" style="color: #e4d594; font-size: 1.4rem;"></i>`;
            backgroundMusic.pause();
        }
        
        settingsOverlay.style.display = 'none';
    }

    // Start free spins
    function startFreeSpins() {
        startFreeSpinsOverlay.style.display = "none";
        spin();
    }

    // Rotate spin button image
    function rotateSpinButtonImage() {
        spinButtonInnerImage.style.transition = 'transform 0.5s ease';
        spinButtonInnerImage.style.transform = 'rotate(180deg)';
    }

    // Reset spin button image
    function resetSpinButtonImage() {
        spinButtonInnerImage.style.transition = 'transform 0.5s ease';
        spinButtonInnerImage.style.transform = 'rotate(360deg)';
    }

    // Draw the game
    function drawGame() {
        // Clear canvas
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        
        // Draw the game in layers:
        // 1. Background
        drawBackground();
        
        // 2. All walls (drawn first, symbols will appear on top)
        drawWalls();
        
        // 3. Reel backgrounds
        drawReelBackgrounds();
        
        // 4. Draw spinning reels (these will appear to go under the bottom wall)
        drawSpinningReels();
        
        // 5. Draw stopped reels (these will appear on top of all walls)
        drawStoppedReels();
        
        // 6. Win display (if there's a win)
        if (winAmount > 0 && !spinning) {
            drawWinDisplay();
        }
    }

    // Draw background
    function drawBackground() {
        ctx.fillStyle = isFreeSpinMode ? '#1a237e' : '#222222';
        ctx.fillRect(0, 0, canvas.width, canvas.height);
    }

    // Draw all walls
    function drawWalls() {
        const wallThickness = Math.min(canvas.width, canvas.height) * 0.1;
        
        // Top wall
        ctx.fillStyle = WALL_BACKGROUNDS[0];
        ctx.fillRect(0, 0, canvas.width, wallThickness);
        
        // Right wall
        ctx.fillStyle = WALL_BACKGROUNDS[1];
        ctx.fillRect(canvas.width - wallThickness, 0, wallThickness, canvas.height);
        
        // Bottom wall
        ctx.fillStyle = WALL_BACKGROUNDS[2];
        ctx.fillRect(0, canvas.height - wallThickness, canvas.width, wallThickness);
        
        // Left wall
        ctx.fillStyle = WALL_BACKGROUNDS[3];
        ctx.fillRect(0, 0, wallThickness, canvas.height);
        
        // Add texture/pattern to walls
        for (let i = 0; i < 4; i++) {
            const wall = [
                { x: 0, y: 0, width: canvas.width, height: wallThickness },
                { x: canvas.width - wallThickness, y: 0, width: wallThickness, height: canvas.height },
                { x: 0, y: canvas.height - wallThickness, width: canvas.width, height: wallThickness },
                { x: 0, y: 0, width: wallThickness, height: canvas.height }
            ][i];
            
            // Add pattern to wall
            ctx.save();
            ctx.globalAlpha = 0.2;
            for (let j = 0; j < 10; j++) {
                ctx.beginPath();
                if (i % 2 === 0) { // horizontal walls
                    ctx.moveTo(wall.x + j * 70, wall.y);
                    ctx.lineTo(wall.x + j * 70 + 30, wall.y + wall.height);
                } else { // vertical walls
                    ctx.moveTo(wall.x, wall.y + j * 45);
                    ctx.lineTo(wall.x + wall.width, wall.y + j * 45 + 20);
                }
                ctx.strokeStyle = 'white';
                ctx.lineWidth = 2;
                ctx.stroke();
            }
            ctx.restore();
        }
    }

    // Draw reel backgrounds
    function drawReelBackgrounds() {
        const wallThickness = Math.min(canvas.width, canvas.height) * 0.1;
        const reelWidth = (canvas.width - wallThickness * 2) / REEL_COUNT;
        const reelHeight = canvas.height - wallThickness * 2;
        
        // Draw background for reels area
        ctx.fillStyle = isFreeSpinMode ? '#1a237e' : '#000000';
        ctx.fillRect(
            wallThickness, 
            wallThickness, 
            reelWidth * REEL_COUNT, 
            reelHeight
        );
        
        // Draw individual reel backgrounds
        for (let i = 0; i < REEL_COUNT; i++) {
            const reelX = wallThickness + i * reelWidth;
            const reelY = wallThickness;
            
            // Draw reel background
            ctx.fillStyle = isFreeSpinMode ? '#303f9f' : '#333333';
            ctx.fillRect(reelX, reelY, reelWidth, reelHeight);
            
            // Draw reel border
            ctx.strokeStyle = isFreeSpinMode ? '#5c6bc0' : '#666666';
            ctx.lineWidth = 2;
            ctx.strokeRect(reelX, reelY, reelWidth, reelHeight);
        }
        
        // Draw dividing lines between symbols
        for (let i = 1; i < SYMBOLS_PER_REEL; i++) {
            ctx.beginPath();
            ctx.moveTo(wallThickness, wallThickness + i * (reelHeight / SYMBOLS_PER_REEL));
            ctx.lineTo(wallThickness + reelWidth * REEL_COUNT, wallThickness + i * (reelHeight / SYMBOLS_PER_REEL));
            ctx.strokeStyle = 'rgba(255, 255, 255, 0.2)';
            ctx.lineWidth = 1;
            ctx.stroke();
        }
    }

    // Draw spinning reels
    function drawSpinningReels() {
        const wallThickness = Math.min(canvas.width, canvas.height) * 0.1;
        const reelWidth = (canvas.width - wallThickness * 2) / REEL_COUNT;
        const reelHeight = canvas.height - wallThickness * 2;
        const symbolHeight = reelHeight / SYMBOLS_PER_REEL;
        
        // Create clipping region for spinning reels
        ctx.save();
        ctx.beginPath();
        ctx.rect(
            wallThickness, 
            wallThickness, 
            reelWidth * REEL_COUNT, 
            reelHeight
        );
        ctx.clip();
        
        // Draw spinning reels
        for (let i = 0; i < REEL_COUNT; i++) {
            // Only draw if this reel is still spinning
            if (!reels[i].isSpinning) continue;
            
            const reelX = wallThickness + i * reelWidth;
            const reelY = wallThickness;
            
            // Draw symbols
            for (let j = 0; j < reels[i].symbols.length; j++) {
                const symbol = reels[i].symbols[j];
                const symbolData = SYMBOLS.find(s => s.name === symbol.name);
                
                // Calculate position with scrolling offset
                const symbolX = reelX;
                const symbolY = reelY - symbolHeight * EXTRA_SYMBOLS + j * symbolHeight + reels[i].position;
                
                // Only draw if near the visible area
                if (symbolY > reelY - symbolHeight && symbolY < reelY + reelHeight + symbolHeight) {
                    // Draw symbol
                    drawSymbol(symbolX, symbolY, reelWidth, symbolHeight, symbolData, symbol.isSpecial, symbol.scale);
                }
            }
        }
        
        ctx.restore();
    }

    // Draw stopped reels
    function drawStoppedReels() {
        const wallThickness = Math.min(canvas.width, canvas.height) * 0.1;
        const reelWidth = (canvas.width - wallThickness * 2) / REEL_COUNT;
        const reelHeight = canvas.height - wallThickness * 2;
        const symbolHeight = reelHeight / SYMBOLS_PER_REEL;
        
        // Draw stopped reels
        for (let i = 0; i < REEL_COUNT; i++) {
            // Only draw if this reel has stopped spinning
            if (reels[i].isSpinning) continue;
            
            const reelX = wallThickness + i * reelWidth;
            const reelY = wallThickness;
            
            // Draw symbols
            for (let j = 0; j < reels[i].finalSymbols.length; j++) {
                const symbol = reels[i].finalSymbols[j];
                const symbolData = SYMBOLS.find(s => s.name === symbol.name);
                
                // Calculate position
                const symbolX = reelX;
                const symbolY = reelY + j * symbolHeight;
                
                // Draw symbol
                drawSymbol(symbolX, symbolY, reelWidth, symbolHeight, symbolData, symbol.isSpecial, symbol.scale);
            }
        }
    }

    // Draw a symbol
    function drawSymbol(x, y, width, height, symbol, isSpecial, scale) {
        // Calculate center position
        const centerX = x + width / 2;
        const centerY = y + height / 2;
        
        // Save context for transformations
        ctx.save();
        
        // Draw symbol background
        ctx.fillStyle = symbol.color;
        ctx.fillRect(x, y, width, height);
        
        // Apply scaling transformation for special symbols
        if (isSpecial) {
            // Scale from center
            ctx.translate(centerX, centerY);
            ctx.scale(scale, scale);
            ctx.translate(-centerX, -centerY);
            
            // Add glow effect for special symbols
            ctx.shadowColor = symbol.color;
            ctx.shadowBlur = 15;
            
            // Add border for special symbols
            ctx.strokeStyle = 'white';
            ctx.lineWidth = 3;
            ctx.strokeRect(x, y, width, height);
        }
        
        // Draw the symbol image
        const img = symbolImages[symbol.name];
        if (img) {
            // Calculate image dimensions to fit within the symbol area
            const imgPadding = width * 0.05;
            const imgSize = Math.min(width, height) - imgPadding * 2;
            
            // Draw the image
            ctx.drawImage(
                img, 
                x + (width - imgSize) / 2, 
                y + (height - imgSize) / 2, 
                imgSize, 
                imgSize
            );
        }
        
        // Restore context
        ctx.restore();
    }

    // Draw win display
    function drawWinDisplay() {
        // Position in the center of the game
        const x = canvas.width / 2;
        const y = canvas.height / 2;
        
        // If we're animating the win amount, update the display value
        if (isAnimatingWin) {
            const elapsed = Date.now() - winAnimationStartTime;
            const duration = 1500; // 1.5 seconds for the animation
            
            if (elapsed < duration) {
                // Calculate progress (0 to 1)
                const progress = Math.min(elapsed / duration, 1);
                
                // Ease-out function for smoother animation
                const easedProgress = 1 - Math.pow(1 - progress, 3);
                
                // Update the display value
                winAmountDisplay = Math.floor(winAmount * easedProgress);
                
                // Request next frame
                requestAnimationFrame(drawGame);
            } else {
                // Animation complete
                winAmountDisplay = winAmount;
                isAnimatingWin = false;
            }
        }
        
        // Only draw if there's a win to display
        if (winAmountDisplay > 0) {
            // Draw background
            ctx.save();
            ctx.globalAlpha = 0.8;
            ctx.fillStyle = '#000000';
            const padding = 20;
            const width = 240;
            const height = 80;
            ctx.beginPath();
            ctx.roundRect(x - width/2, y - height/2, width, height, 15);
            ctx.fill();
            ctx.restore();
            
            // Draw win text
            ctx.fillStyle = '#ffffff';
            ctx.font = 'bold 24px Arial';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillText('WIN!', x, y - 15);
            
            // Draw win amount
            ctx.fillStyle = '#ffdd00';
            ctx.font = 'bold 36px Arial';
            ctx.fillText('$' + winAmountDisplay, x, y + 20);
            
            // Add glow effect
            ctx.shadowColor = '#ffdd00';
            ctx.shadowBlur = 15;
            ctx.fillText('$' + winAmountDisplay, x, y + 20);
            ctx.shadowBlur = 0;
        }
    }

    // Generate mock results
    function generateMockResults() {
        const newResults = [];
        
        // Check if we should trigger free spins (10% chance if not already in free spin mode)
        const triggerFreeSpins = !isFreeSpinMode && (currentDemoFeature.feature === "free spins" || Math.random() < 0.1);
        
        // Check if we should generate a big win
        const generateBigWin = currentDemoFeature.feature === "big win" || Math.random() < 0.2;
        
        // If triggering free spins, ensure at least one scatter on each reel
        if (triggerFreeSpins) {
            for (let i = 0; i < REEL_COUNT; i++) {
                const reelSymbols = [];
                
                // Add one scatter symbol
                const scatterPosition = Math.floor(Math.random() * SYMBOLS_PER_REEL);
                
                for (let j = 0; j < SYMBOLS_PER_REEL; j++) {
                    if (j === scatterPosition) {
                        reelSymbols.push({
                            name: 'Scatter',
                            isSpecial: true,
                            scale: 1.3
                        });
                    } else {
                        const randomIndex = Math.floor(Math.random() * (SYMBOLS.length - 1));
                        const symbolName = SYMBOLS[randomIndex].name === 'Scatter' ? 'A' : SYMBOLS[randomIndex].name;
                        reelSymbols.push({
                            name: symbolName,
                            isSpecial: Math.random() < 0.3,
                            scale: Math.random() * 0.5 + 1.1
                        });
                    }
                }
                newResults.push(reelSymbols);
            }
        } 
        // If generating a big win, create a line of high-value symbols
        else if (generateBigWin) {
            // Choose a high-value symbol
            const highValueSymbols = ['Treasure Chest', 'Explorer', 'Compass', 'Binoculars'];
            const selectedSymbol = highValueSymbols[Math.floor(Math.random() * highValueSymbols.length)];
            
            // Create a line of matching symbols
            for (let i = 0; i < REEL_COUNT; i++) {
                const reelSymbols = [];
                
                for (let j = 0; j < SYMBOLS_PER_REEL; j++) {
                    if (j === 1) { // Middle row for the winning line
                        reelSymbols.push({
                            name: i === 0 ? selectedSymbol : (Math.random() < 0.7 ? selectedSymbol : 'Wild'),
                            isSpecial: true,
                            scale: 1.2
                        });
                    } else {
                        const randomIndex = Math.floor(Math.random() * SYMBOLS.length);
                        reelSymbols.push({
                            name: SYMBOLS[randomIndex].name,
                            isSpecial: Math.random() < 0.3,
                            scale: Math.random() * 0.5 + 1.1
                        });
                    }
                }
                newResults.push(reelSymbols);
            }
        }
        // Normal results
        else {
            for (let i = 0; i < REEL_COUNT; i++) {
                const reelSymbols = [];
                for (let j = 0; j < SYMBOLS_PER_REEL; j++) {
                    const randomIndex = Math.floor(Math.random() * SYMBOLS.length);
                    reelSymbols.push({
                        name: SYMBOLS[randomIndex].name,
                        isSpecial: Math.random() < 0.3,
                        scale: Math.random() * 0.5 + 1.1
                    });
                }
                newResults.push(reelSymbols);
            }
        }
        
        return {
            reels: newResults,
            triggerFreeSpins: triggerFreeSpins,
            generateBigWin: generateBigWin
        };
    }

    // Calculate win amount
    function calculateWinAmount(results, isFreeSpinMode, bonusMultiplier) {
        // Extract symbol names from results for easier processing
        const symbolNames = results.reels.map(reel => 
            reel.map(symbol => symbol.name)
        );
        
        // Check for winning combinations
        let totalWin = 0;
        let winningPositions = [];
        
        // Check for matching symbols on each row
        for (let row = 0; row < SYMBOLS_PER_REEL; row++) {
            // Check each symbol (except Scatter which pays anywhere)
            for (let symbolObj of SYMBOLS) {
                if (symbolObj.name === 'Scatter') continue;
                
                let count = 0;
                let positions = [];
                
                // Count consecutive matching symbols from left to right
                for (let reel = 0; reel < REEL_COUNT; reel++) {
                    const currentSymbol = symbolNames[reel][row];
                    
                    // Match if same symbol or Wild (except first reel)
                    if (currentSymbol === symbolObj.name || (currentSymbol === 'Wild' && reel > 0)) {
                        count++;
                        positions.push({ reel, row, symbol: currentSymbol });
                    } else {
                        break;
                    }
                }
                
                // Check if we have a win (3 or more matching symbols)
                if (count >= 3) {
                    // Get payout for this symbol and count
                    const payout = symbolObj.payouts[count];
                    
                    // Calculate win amount
                    let win = payout * stake;
                    
                    // Apply bonus multiplier in free spin mode
                    if (isFreeSpinMode && bonusMultiplier > 0) {
                        win *= bonusMultiplier;
                    }
                    
                    totalWin += win;
                    winningPositions = winningPositions.concat(positions);
                }
            }
        }
        
        // Check for Scatter wins
        let scatterCount = 0;
        let scatterPositions = [];
        
        for (let reel = 0; reel < REEL_COUNT; reel++) {
            for (let row = 0; row < SYMBOLS_PER_REEL; row++) {
                if (symbolNames[reel][row] === 'Scatter') {
                    scatterCount++;
                    scatterPositions.push({ reel, row, symbol: 'Scatter' });
                }
            }
        }
        
        // Scatter pays anywhere
        if (scatterCount >= 3) {
            const scatterObj = SYMBOLS.find(s => s.name === 'Scatter');
            const payout = scatterObj.payouts[scatterCount] || 0;
            
            let win = payout * stake;
            
            // Apply bonus multiplier in free spin mode
            if (isFreeSpinMode && bonusMultiplier > 0) {
                win *= bonusMultiplier;
            }
            
            totalWin += win;
            winningPositions = winningPositions.concat(scatterPositions);
        }
        
        // If it's a big win demo, ensure a big win
        if (results.generateBigWin && totalWin < 100) {
            totalWin = 100 + Math.floor(Math.random() * 400);
        }
        
        return {
            amount: totalWin,
            positions: winningPositions
        };
    }

    // Spin animation
    function spinAnimation(callback, apiResult) {
        if (currentInterval) clearInterval(currentInterval);
        
        // Check if this is a big win (greater than 100)
        const isBigWin = apiResult && apiResult.win > 100;
        
        // Normal spin counts for each reel
        let spinCounts = [50, 57, 64, 71, 78]; 
        
        // If it's a big win, make the last reel spin longer for dramatic effect
        if (isBigWin) {
            spinCounts[4] = 90; // Increase the spin count for the last reel
        }
        
        const remainingSpins = [...spinCounts];
        let reelsStoppedCount = 0;
        let isLastReelSlowedDown = false;
        let lastReelInterval = null;
        
        // Calculate dimensions
        const wallThickness = Math.min(canvas.width, canvas.height) * 0.1;
        const reelWidth = (canvas.width - wallThickness * 2) / REEL_COUNT;
        const reelHeight = canvas.height - wallThickness * 2;
        const symbolHeight = reelHeight / SYMBOLS_PER_REEL;
        
        // Speed of symbol movement (pixels per frame)
        const scrollSpeed = isQuickSpinMode ? 40 : 30;
        
        currentInterval = setInterval(() => {
            let allStopped = true;
            
            for (let i = 0; i < REEL_COUNT; i++) {
                if (remainingSpins[i] > 0) {
                    // Move symbols downward
                    reels[i].position += scrollSpeed;
                    
                    // If position exceeds one symbol height, reset and cycle symbols
                    if (reels[i].position >= symbolHeight) {
                        reels[i].position = 0;
                        
                        // Move the first symbol to the end
                        const firstSymbol = reels[i].symbols.shift();
                        reels[i].symbols.push(firstSymbol);
                    }
                    
                    // For the last reel, check if we should slow down
                    if (i === 4 && reelsStoppedCount >= 4 && !isLastReelSlowedDown && isBigWin) {
                        // Slow down the last reel by reducing the speed of updates
                        isLastReelSlowedDown = true;
                        clearInterval(currentInterval);
                        
                        // Play reel speed up sound
                        if (soundEffectsEnabled) {
                            reelSpeedUpSound.play().catch(e => console.log("Audio play failed:", e));
                        }
                        
                        // Create a new slower interval just for the last reel
                        lastReelInterval = setInterval(() => {
                            // Move symbols downward at half speed
                            reels[4].position += scrollSpeed / 2;
                            
                            // If position exceeds one symbol height, reset and cycle symbols
                            if (reels[4].position >= symbolHeight) {
                                reels[4].position = 0;
                                
                                // Move the first symbol to the end
                                const firstSymbol = reels[4].symbols.shift();
                                reels[4].symbols.push(firstSymbol);
                            }
                            
                            remainingSpins[4]--;
                            
                            // Redraw the game
                            drawGame();
                            
                            if (remainingSpins[4] <= 0) {
                                // When the last reel is ready to stop, display final symbols
                                reels[4].finalSymbols = apiResult.reels[4];
                                reels[4].isSpinning = false;
                                
                                clearInterval(lastReelInterval);
                                
                                // Stop reel speed up sound
                                if (soundEffectsEnabled) {
                                    reelSpeedUpSound.pause();
                                    reelSpeedUpSound.currentTime = 0;
                                }
                                
                                spinning = false;
                                featuresButton.disabled = false;
                                callback();
                            }
                        }, isQuickSpinMode ? 40 : 60); // Slower interval for dramatic effect
                        
                        return;
                    }
                    
                    remainingSpins[i]--;
                    allStopped = false;
                } else if (remainingSpins[i] === 0) {
                    // When a reel is ready to stop, immediately display the final symbols
                    reels[i].finalSymbols = apiResult.reels[i];
                    reels[i].isSpinning = false;
                    remainingSpins[i] = -1; // Mark as completely stopped
                    reelsStoppedCount++;
                }
            }
            
            // Redraw the game
            drawGame();
            
            if (allStopped) {
                clearInterval(currentInterval);
                spinning = false;
                featuresButton.disabled = false;
                currentInterval = null;
                
                callback();
            }
        }, isQuickSpinMode ? 20 : 30);
    }

    // Spin function
    async function spin() {
        if (spinning || (balance < stake && !isFreeSpinMode)) return;

        // Check if loss limit has been reached
        if (autoSpins > 0 && !isFreeSpinMode) {
            const currentLoss = initialBalance - balance;
            const maxAllowedLoss = lossLimit === Infinity ? Infinity : stake * lossLimit;
            
            if (currentLoss >= maxAllowedLoss && maxAllowedLoss !== Infinity) {
                autoSpinsStopped = true;
                updateAutoSpinStatus();
                remainingAutoSpins.innerHTML = '';
                autoSpins = 0;
                alert(`Auto-spins stopped: Loss limit of ${maxAllowedLoss.toFixed(2)} reached.`);
                return;
            }
        } 
        
        if (stake <= 0 || (stake > balance && !isFreeSpinMode)) {
            alert("Invalid stake amount!");
            return;
        }

        // Rotate the spin button image before spinning
        rotateSpinButtonImage();

        // Deduct bet amount if not in free spin mode
        if (!isFreeSpinMode) {
            balance -= stake;
            displayBalance(balance);
        }

        // Play spin sound if enabled
        if (soundEffectsEnabled) {
            spinSound.play().catch(e => console.log("Audio play failed:", e));
        }
        
        spinning = true;
        featuresButton.disabled = true;

        // Hide win message
        winMessageElement.style.display = 'none';
        document.getElementById('update_winnings').innerHTML = '0.00';

        // Generate mock results
        const mockResults = generateMockResults();
        
        // Calculate win amount
        const winResult = calculateWinAmount(mockResults, isFreeSpinMode, bonusMultiplier);
        
        // Create API result object
        const apiResult = {
            reels: mockResults.reels,
            win: winResult.amount,
            winningPositions: winResult.positions,
            triggerFreeSpins: mockResults.triggerFreeSpins
        };

        // Prepare reels for spinning
        for (let i = 0; i < REEL_COUNT; i++) {
            // Reset position
            reels[i].position = 0;
            
            // Set spinning state
            reels[i].isSpinning = true;
            
            // Generate new symbols for spinning
            const totalSymbols = SYMBOLS_PER_REEL + EXTRA_SYMBOLS * 2;
            reels[i].symbols = [];
            
            // Add random symbols for the spinning effect
            for (let j = 0; j < totalSymbols; j++) {
                const randomIndex = Math.floor(Math.random() * SYMBOLS.length);
                reels[i].symbols.push({
                    name: SYMBOLS[randomIndex].name,
                    isSpecial: Math.random() < 0.3,
                    scale: Math.random() * 0.5 + 1.1
                });
            }
        }

        // Start spin animation
        spinAnimation(() => {
            // Reset the spin button image after animation completes
            resetSpinButtonImage();

            // Update win amount
            if (apiResult.win > 0) {
                updateWinnings(apiResult.win);
                
                // Update balance with winnings
                balance += apiResult.win;
                displayBalance(balance);

                // Play win sound
                if (soundEffectsEnabled) {
                    winSound.play().catch(e => console.log("Audio play failed:", e));
                }
                
                // Show big win animation for large wins
                if (apiResult.win >= 100 && !isFreeSpinMode && autoSpins === 0) {
                    setTimeout(() => {
                        showWinAnimation(apiResult.win);
                    }, 1000);
                }
            } else {
                document.getElementById('update_winnings').innerHTML = '0.00';
            }

            // Handle free spins
            if (apiResult.triggerFreeSpins && !isFreeSpinMode) {
                freeSpinTriggeredRecently = true;
                
                // Change background image to volcano
                document.getElementById('img_top').src = 'assets/img/volcano_p1.png';
                
                // Show free spins overlay
                setTimeout(() => {
                    freeSpinsOverlay.style.display = 'block';
                    
                    // Pause background music and play free spin sound
                    if (soundEffectsEnabled) {
                        backgroundMusic.pause();
                        freeSpinSound.play().catch(e => console.log("Audio play failed:", e));
                    }
                    
                    // Hide overlay after 4 seconds
                    setTimeout(() => {
                        freeSpinsOverlay.style.display = 'none';
                        
                        // Change background
                        document.getElementById("playground").style.backgroundImage = "url('assets/img/jungle-fs-bg.jpg')";
                        
                        // Free spins were just triggered
                        isFreeSpinMode = true;
                        freeSpinCount = 13;
                        bonusMultiplier = 3;
                        originalBetAmount = stake;
                        
                        // Update displays
                        document.getElementById('freespins_display').style.display = "flex";
                        document.getElementById('normalspins_display').style.display = "none";
                        
                        document.getElementById('remaining_fs_holder').innerHTML = remainingFreeSpinCount;
                        document.getElementById('total_fs_holder').innerHTML = freeSpinCount;
                        
                        // Update free spins indicator
                        freeSpinsIndicator.style.display = 'block';
                        freeSpinsCountElement.textContent = freeSpinCount;
                        bonusMultiplierElement.textContent = bonusMultiplier;
                        
                        // Show start free spins overlay
                        startFreeSpinsOverlay.style.display = "block";
                    }, 4000);
                }, 1000);
            } 
            else if (apiResult.triggerFreeSpins && isFreeSpinMode) {
                // Additional free spins during free spin mode
                setTimeout(() => {
                    freeSpinsOverlayImg.style.display = "none";
                    freeSpinsOverlayImg2.style.display = "block";
                    freeSpinsOverlay.style.display = 'block';
                    
                    // Hide overlay after 3 seconds
                    setTimeout(() => {
                        freeSpinsOverlay.style.display = 'none';
                        
                        // Add more free spins
                        freeSpinCount += 13;
                        
                        // Update displays
                        document.getElementById('remaining_fs_holder').innerHTML = remainingFreeSpinCount;
                        document.getElementById('total_fs_holder').innerHTML = freeSpinCount;
                        
                        // Update free spins indicator
                        freeSpinsCountElement.textContent = freeSpinCount;
                        
                        // Continue free spins
                        setTimeout(() => {
                            if (!spinning) {
                                spin();
                            }
                        }, 1000);
                    }, 3000);
                }, 1000);
            }
            else if (isFreeSpinMode) {
                // Already in free spin mode
                remainingFreeSpinCount += 1;
                
                // Update displays
                document.getElementById('remaining_fs_holder').innerHTML = remainingFreeSpinCount;
                
                // Check if free spins are over
                if (remainingFreeSpinCount >= freeSpinCount) {
                    // End free spins
                    if (soundEffectsEnabled) {
                        freeSpinSound.pause();
                        backgroundMusic.play().catch(e => console.log("Audio play failed:", e));
                    }
                    
                    remainingFreeSpinCount = 0;
                    isFreeSpinMode = false;
                    bonusMultiplier = 0;
                    originalBetAmount = 0;
                    freeSpinsIndicator.style.display = 'none';
                    
                    // Reset displays
                    freeSpinsOverlayImg.style.display = "block";
                    freeSpinsOverlayImg2.style.display = "none";
                    document.getElementById('freespins_display').style.display = "none";
                    document.getElementById('normalspins_display').style.display = "flex";
                    
                    document.getElementById('remaining_fs_holder').innerHTML = 0;
                    document.getElementById('total_fs_holder').innerHTML = 0;
                    
                    // Reset background
                    document.getElementById('img_top').src = 'assets/img/top.png';
                    document.getElementById("playground").style.backgroundImage = "url('assets/img/jungle-bg.jpg')";
                } else {
                    // Continue free spins
                    setTimeout(() => {
                        if (!spinning) {
                            spin();
                        }
                    }, 1500);
                }
            }

            // Update auto spins
            if (autoSpins > 0 && !isFreeSpinMode) {
                if (autoSpinsStopped) {
                    autoSpins = 0;
                    updateAutoSpinStatus();
                    remainingAutoSpins.innerHTML = ' ';
                }
                else {
                    autoSpins--;
                    if (autoSpins == 0) {
                        autoSpinsStopped = true;
                        updateAutoSpinStatus();
                        remainingAutoSpins.innerHTML = ``;
                    } else {
                        remainingAutoSpins.innerHTML = `${autoSpins}`;
                        if (autoSpins > 0 && balance >= stake) {
                            setTimeout(() => spin(), 1000);
                        }
                    }
                }
            }
            else if (!isFreeSpinMode) {
                autoSpinsStopped = true;
                updateAutoSpinStatus();
                remainingAutoSpins.innerHTML = ' ';
            }
        }, apiResult);
    }

    // Update winnings display
    function updateWinnings(targetAmount) {
        let element = document.getElementById('update_winnings');
        let currentAmount = parseFloat(element.innerHTML) || 0;
        let increment = (targetAmount - currentAmount) / 50; // Adjust speed

        let counter = setInterval(() => {
            currentAmount += increment;
            element.innerHTML = `${currentAmount.toFixed(2)}`;

            if ((increment > 0 && currentAmount >= targetAmount) || (increment < 0 && currentAmount <= targetAmount)) {
                element.innerHTML = `${targetAmount.toFixed(2)}`;
                clearInterval(counter);
            }
        }, 20); // Update every 20ms
    }

    // Function to determine win level based on amount
    function getWinLevel(amount) {
        if (amount < winLevels.big.threshold) {
            return 'big';
        } else if (amount < winLevels.mega.threshold) {
            return 'mega';
        } else {
            return 'ultra';
        }
    }

    // Function to show the win animation
    function showWinAnimation(amount) {
        // Pause background music and play big win sound
        if (backgroundMusicEnabled) {
            backgroundMusic.pause();
        }
        if (soundEffectsEnabled) {
            bigWinSound.play().catch(e => console.log("Audio play failed:", e));
        }
        
        // Set initial win level
        let currentLevel = getWinLevel(amount);
        updateWinLevel(currentLevel);
        
        // Show the overlay
        const winOverlay = document.getElementById('winOverlay');
        winOverlay.style.display = 'flex';
        
        // Start with $0
        let currentAmount = 0;
        const winAmount = document.getElementById('winAmount');
        winAmount.textContent = '$' + currentAmount.toLocaleString();
        
        // Create the coin fountain
        setTimeout(() => {
            createCoinFountain(winLevels[currentLevel].coinCount);
        }, 200);
        
        // Animate the counter
        const duration = 5000; // 5 seconds for the counter
        const fps = 60;
        const increment = amount / (duration / 1000 * fps);
        const startTime = performance.now();
        
        function updateCounter(timestamp) {
            const elapsed = timestamp - startTime;
            const progress = Math.min(elapsed / duration, 1);
            
            currentAmount = progress * amount;
            winAmount.textContent = '$' + Math.floor(currentAmount).toLocaleString();
            
            // Check if we need to upgrade the win level
            const newLevel = getWinLevel(currentAmount);
            if (newLevel !== currentLevel) {
                currentLevel = newLevel;
                updateWinLevel(currentLevel);
                
                // Add more coins for the new level
                createCoinFountain(winLevels[currentLevel].coinCount);
            }
            
            if (progress < 1) {
                requestAnimationFrame(updateCounter);
            } else {
                // Counter finished
                winAmount.textContent = '$' + amount.toLocaleString();
                
                // Auto close after 3 seconds
                setTimeout(() => {
                    closeWinAnimation();
                }, 3000);
            }
        }
        
        requestAnimationFrame(updateCounter);
    }

    // Function to update the win level visuals
    function updateWinLevel(level) {
        const winText = document.getElementById('winText');
        const sunburst = document.getElementById('sunburst');
        
        // Remove all classes
        winText.classList.remove('big-win', 'mega-win', 'ultra-win');
        sunburst.classList.remove('big-win-color', 'mega-win-color', 'ultra-win-color');
        
        // Add new classes
        winText.classList.add(winLevels[level].textClass);
        sunburst.classList.add(winLevels[level].sunburstClass);
        
        // Update text
        winText.textContent = winLevels[level].text;
    }

    // Function to close the win animation
    function closeWinAnimation() {
        const winOverlay = document.getElementById('winOverlay');
        winOverlay.style.display = 'none';
        
        // Stop big win sound and resume background music
        if (soundEffectsEnabled) {
            bigWinSound.pause();
            bigWinSound.currentTime = 0;
            
            if (backgroundMusicEnabled) {
                if (isFreeSpinMode) {
                    freeSpinSound.play().catch(e => console.log("Audio play failed:", e));
                } else {
                    backgroundMusic.play().catch(e => console.log("Audio play failed:", e));
                }
            }
        }
        
        // Clear all coins
        const coinsContainer = document.getElementById('coinsContainer');
        coinsContainer.innerHTML = '';
    }

    // Function to create the coin fountain
    function createCoinFountain(numberOfCoins) {
        const coinsContainer = document.getElementById('coinsContainer');
        
        // Create fountain of coins
        const containerWidth = coinsContainer.offsetWidth;
        const containerHeight = coinsContainer.offsetHeight;
        
        // Center bottom position
        const centerX = containerWidth / 2;
        
        // Adjust coin count based on screen size
        const isMobile = window.innerWidth < 576;
        const actualCoinCount = isMobile ? Math.floor(numberOfCoins * 0.6) : numberOfCoins;
        
        for (let i = 0; i < actualCoinCount; i++) {
            setTimeout(() => {
                // Create coin element
                const coin = document.createElement('div');
                coin.className = 'coin';
                
                // Random size between 20-40px
                const coinSize = Math.floor(Math.random() * 20) + 20;
                coin.style.width = `${coinSize}px`;
                coin.style.height = `${coinSize}px`;
                
                // Create the img element inside the coin div
                const coinImg = document.createElement('img');
                coinImg.src = coinImages[Math.floor(Math.random() * coinImages.length)];
                coinImg.style.width = '100%';
                coinImg.style.height = '100%';
                coinImg.crossOrigin = "anonymous"; // Avoid CORS issues
                coin.appendChild(coinImg);
                
                // Start at center bottom with slight random offset
                const startX = centerX + (Math.random() - 0.5) * 50;
                coin.style.left = `${startX}px`;
                coin.style.bottom = '0px';
                
                // Add to container
                coinsContainer.appendChild(coin);
                
                // Animate the coin in a fountain pattern
                animateCoinFountain(coin, startX, containerHeight);
            }, i * 40); // Stagger the coin creation
        }
    }

    // Function to animate a single coin in a fountain pattern
    function animateCoinFountain(coin, startX, containerHeight) {
        const coinsContainer = document.getElementById('coinsContainer');
        const containerWidth = coinsContainer.offsetWidth;
        
        // Random angle for the fountain spread
        const angle = ((Math.random() - 0.5) * Math.PI) / 3.0; // -60 to +60 degrees
        
        // Random initial velocity (speed)
        const initialVelocity = 15 + Math.random() * 10;
        
        // Calculate velocity components
        const vx = initialVelocity * Math.sin(angle);
        const vy = initialVelocity * Math.cos(angle);
        
        // Animation parameters
        const gravity = 0.5;
        const duration = 2000 + Math.random() * 1000;
        const fps = 60;
        const totalFrames = (duration / 1000) * fps;
        
        // Animation variables
        let currentFrame = 0;
        let x = startX;
        let y = 0;
        let velocityY = vy;
        let rotation = 0;
        
        // Animation function
        const animate = () => {
            if (!coin.parentNode) return; // Stop if coin was removed
            
            // Update position with gravity
            x += vx;
            velocityY -= gravity;
            y += velocityY;
            
            // Update rotation
            rotation += 10;
            
            // Update coin position and rotation
            coin.style.left = `${x}px`;
            coin.style.bottom = `${y}px`;
            coin.style.transform = `rotate(${rotation}deg)`;
            
            // Check if coin is still visible
            if (y < -100 || x < -100 || x > containerWidth + 100) {
                if (coin.parentNode) {
                    coin.parentNode.removeChild(coin);
                }
                return;
            }
            
            // Continue animation
            currentFrame++;
            if (currentFrame < totalFrames) {
                requestAnimationFrame(animate);
            } else {
                // Remove coin after animation completes
                if (coin.parentNode) {
                    coin.parentNode.removeChild(coin);
                }
            }
        };
        
        // Start animation
        requestAnimationFrame(animate);
    }

    // Initialize loading screen
    initLoading();
    
    // Preload images
    preloadImages();

</script>
</body>
</html>