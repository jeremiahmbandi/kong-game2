<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale: 1.0, maximum-scale: 1.0, user-scalable: no">
    <title>Kong (Treasure Hunt) Slot Machine</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Andada+Pro:ital,wght@0,400..840;1,400..840&family=Chakra+Petch:ital,wght@0,300;0,400;0,500;0,600;0,700;1,300;1,400;1,500;1,600;1,700&family=Noto+Serif:ital,wght@0,100..900;1,100..900&family=Victor+Mono:ital,wght@0,100..700;1,100..700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css" integrity="sha512-Evv84Mr4kqVGRNSgIGL/F/aIDqQb7xQ2vcrdIwxfjThSH8CSR7PBEakCr51Ck+w+/U6swU2Im1vVX0SVk9ABhg==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <script src="service.js"></script>

    <style>
        body {
            margin: 0;
            padding: 0;
            overflow: hidden;
            background: #2c2c2c;
            touch-action: manipulation;
            font-family: 'Victor Mono', monospace;
            font-optical-sizing: auto;
            font-weight: normal;
            font-style: normal;
        }
        @font-face {
            font-family: 'aldo';
            src: url('aldo_the_apache') format('truetype');
        }

        #game-container {
            width: 100%;
            height: 100vh;
            max-height: 100vh;
            display: flex;
            flex-direction: column;
            font-family: 'aldo', sans-serif;
        }
        .game-canvas-container {
            flex: 1;
            position: relative;
            height: 100%;
            width: 100%;
            margin: auto;
            overflow: hidden;
            z-index: 888;
        }
        .game-controls {
            margin: 0px !important;
            padding: 0px !important;
            width: 100%;
            background-image: url('wood.jpg');
            z-index: 1000;
            bottom: 0 !important;
        }
        .control-group {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .spin-button, .autoplay-button {
            cursor: pointer;
            width: 100%;
            text-align: center;
            padding: 12px;
        }
        /* Responsive adjustments */
        @media (max-height: 600px) {
            .game-controls {
                padding: 5px;
            }
            .control-group {
                gap: 5px;
            }
            .input-group {
                margin-bottom: 5px;
            }
        }
        /* Prevent text selection */
        * {
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }
        /* Allow input in number fields */
        input[type="number"] {
            -webkit-user-select: auto;
            -moz-user-select: auto;
            -ms-user-select: auto;
            user-select: auto;
        }
        #jdb_overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: black;
            z-index: 2002;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        #kong_overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: url('kong_bcg4.png');
            background-size: cover;
            background-repeat: repeat;
            background-color: black;
            z-index: 2001;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        /* Stake button and overlay styles */
        .overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 1);
            z-index: 2000;
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        .overlay-content {
            border-radius: 12px;
            width: 90%;
            max-width: 400px;
            padding: 20px;
            margin-top: 100px;
        }
        .overlay-content-stake {
            border-radius: 12px;
            width: 100%;
            max-width: 400px;
            padding: 20px;
            margin-top: 100px;
        }
        .overlay-header {
            color: #e4d594;
            text-align: center;
            margin-bottom: 20px;
            font-size: 1.5rem;
            font-weight: bold;
        }
        .options-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
        }
        .option-button {
            background: linear-gradient(to bottom, #353333, #272525);
            color: white;
            border: none;
            border-radius: 8px;
            padding: 15px 0;
            font-size: 1.2rem;
            cursor: pointer;
            transition: all 0.2s;
        }
        .option-button:hover, .option-button.selected {
            background-color: #25282b;
            box-shadow: 
                inset 0 0 0 2px rgba(0, 0, 0, 0.15),
                0 0 0 2px rgba(0, 0, 0, 0.15),
                inset 0 0 0.875rem #FCEAAC,
                0 0 0.875rem #FCEAAC;
        }
        .overlay-footer {
            background-color: black;
            width: inherit;
            display: flex;
            justify-content: space-around;
            margin-top: 20px;
            padding-bottom: 50px;
            bottom: 0;
            position: fixed;
        }
        .overlay-footer-stake {
            margin-top: 20px;
            padding-bottom: 50px;
            bottom: 0;
            position: absolute;
        }
        .overlay-footer button {
            padding: 8px 16px;
            border-radius: 4px;
            border: none;
            cursor: pointer;
        }
        .cancel-button {
            background-color: #333;
            color: white;
        }
        .confirm-button {
            background-color: #333;
            box-shadow: 0 0 4px #e4d594;
            color: white;
        }
        .divider-container {
            color: #e4d594;
        }
        .divider {
            height: 2px;
            background-color: #e4d594;
            width: 30vw;
        }
        .divider-text {
            margin: 0 10px;
        }
        .divider-wrapper {
            display: flex;
            justify-content: center;
            align-items: center;
            width: 100%;
            margin: 16px 0;
        }
        .check-icon {
            display: inline-block;
            width: 16px;
            height: 16px;
            margin-left: 4px;
            position: relative;
        }
        .check-icon:before {
            content: '';
            position: absolute;
            width: 8px;
            height: 12px;
            border-right: 2px solid white;
            border-bottom: 2px solid white;
            transform: rotate(45deg);
            top: 0;
            left: 4px;
        }
        
        .victor-mono {
            font-family: "Victor Mono", monospace;
            font-optical-sizing: auto;
            font-weight: normal;
            font-style: normal;
        }

        /* Settings overlay styles */
        .sound-option {
            color: white;
        }
        .icon-container {
            font-size: 1.5rem;
            display: inline-block;
            width: 30px;
            text-align: center;
        }
        .loader-container {
            height: 10px;
            background: rgba(0, 0, 0, 0.1);
            border-radius: 12px;
        }
        .loader-bar {
            height: 100%;
            width: 0;
            transition: width 0.3s ease;
        }
        .glowing-button {
            position: absolute; /* Ensure ::after is positioned relative to this */
            bottom: 9%;
            padding: 6px 50px;
            font-size: 18px;
            font-weight: bold;
            color: white;
            cursor: pointer;
            border-radius: 12px;
            border-width: 5px;
            border-style: solid;
            border-color: #c09c0e;
            background-color: #fada60;
            font-weight: bold;
            text-shadow: 
                -1px -1px 0 orange,  
                1px -1px 0 orange,
                -1px  1px 0 orange,
                1px  1px 0 orange;
            overflow: hidden; /* Prevents the light effect from overflowing */
        }

        /* Light reflection effect */
        .glowing-button::after {
            content: "";
            position: absolute;
            top: 0;
            left: -100%;
            width: 200%; /* Reduce width to prevent excessive overflow */
            height: 100%;
            background: linear-gradient(
                100deg,
                rgba(255, 255, 255, 0) 40%,
                rgba(255, 255, 255, 0.4) 50%,
                rgba(255, 255, 255, 0) 60%
            );
            animation: light-sweep 2s infinite linear;
        }

        @keyframes light-sweep {
            0% {
                left: -100%;
            }
            100% {
                left: 100%;
            }
        }

        /* Free spins indicator */
        .free-spins-indicator {
            position: absolute;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            background-color: rgba(192, 156, 14, 0.8);
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 1.0rem;
            font-weight: bold;
            z-index: 100;
            display: none;
        }

        /* Win message */
        .win-message {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: rgba(0, 0, 0, 0.7);
            color: #fada60;
            padding: 15px 30px;
            border-radius: 10px;
            text-align: center;
            font-size: 1.5rem;
            font-weight: bold;
            animation: bounce 1s infinite;
            z-index: 100;
            display: none;
        }

        .mobile-wrapper {
            max-width: 100vw;
            max-height: 100vh;
        }
        .autoplay-button, .stake-button{
            height: 70px;
            width: 70px;
        }
        .spin-img{
            height: 55px;
            width: 55px;
        }
        .spin-button{
            height: 85px;
            width: 85px;
        }
        .autospininner-img{
            height: 35px;
            width: 35px;
        }
        .autospininnerimgstop{
            height: 25px;
            width: 25px;
        }
        .totalbetinner-img{
            height: 25px;
        }
        .current-stake{
            font-size: 1.2rem;
            color: #f6d64e;
        }
        #playground{
            height: 40vh;
        }
        .fs-text-image{
            max-height: 25px;
        }
        #remaining_fs_holder, #total_fs_holder{
            color: #8cc904;
            font-size: 2.0rem;
            font-weight: bold;
        }

        @media screen and (min-width: 900px) {
            .sunburst-container {
                position: absolute;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                width: 80vw;
                max-width: 600px;
                height: 80vw;
                max-height: 600px;
                z-index: 10; /* Higher than coins */
                display: flex;
                align-items: center;
                justify-content: center;
                overflow: visible;
                pointer-events: none;
            }
            #jdb_overlay {
                max-width: 320px;
                max-height: 5100px;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                left: 50%;
                transform: translate(-50%, -0%);
                background-color: black;
                z-index: 2002;
                flex-direction: column;
                align-items: center;
                justify-content: center;
            }
            #kong_overlay {
                max-width: 320px;
                max-height: 5100px;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                left: 50%;
                transform: translate(-50%, -0%);
                background-image: url('kong_bcg5.png');
                background-size: contain;
                background-repeat: no-repeat;
                background-color: black;
                z-index: 2001;
                flex-direction: column;
                align-items: center;
                justify-content: center;
            }
            .overlay {
                position: absolute;
                max-width: 320px;
                max-height: 5100px;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                left: 50%;
                transform: translate(-50%, -0%);
                background-color: rgba(0, 0, 0, 1);
                z-index: 2000;
                display: none;
                flex-direction: column;
                align-items: center;
                justify-content: center;
            }
            #playground{
                max-height: 200px;
                width: 100%;
            }
            .mobile-wrapper {
                max-width: 320px;
                max-height: 490px;
            }
            .autoplay-button, .stake-button{
                height: 55px;
                width: 55px;
            }
            .spin-img{
                height: 45px;
                width: 45px;
            }
            .spin-button{
                height: 70px;
                width: 70px;
            }
            .autospininner-img{
                height: 30px;
                width: 30px;
            }
            .autospininnerimgstop{
                height: 25px;
                width: 25px;
            }
            .totalbetinner-img{
                height: 21px
            }
            .current-stake{
                font-size: 1.0rem;
                color: #f6d64e;
            }
            .fs-text-image{
                max-height: 20px;
            }
            #remaining_fs_holder, #total_fs_holder{
                color: #8cc904;
                font-size: 1.5rem;
                font-weight: bold;
            }
        }

        .btn-gold {
            background-color: #b8860b;
            color: white;
            border: none;
            font-weight: bold;
            transition: background-color 0.3s;
        }

        .btn-gold:hover {
            background-color: #a67c00;
            color: white;
        }

        #winOverlay{
            position: absolute;
            width: 100%;
            min-height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            z-index: 2000;
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        #closeBtn {
            position: absolute;
            top: 20px;
            right: 20px;
            background: none;
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
            padding: 8px;
            z-index: 20;
        }

        .win-content {
            position: relative;
            text-align: center;
            z-index: 15;
        }

        /* Rotating sunburst effect */
        .sunburst-container {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 100vw;
            max-width: 600px;
            height: 80vw;
            max-height: 600px;
            z-index: 10; /* Higher than coins */
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: visible;
            pointer-events: none;
        }

        .sunburst {
            width: 100%;
            height: 100%;
            background-image: url('https://hebbkx1anhila5yf.public.blob.vercel-storage.com/BigWin_FX-pnFZvgsE0rjtfTiTODDEY1oM6AHQJ4.png');
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
            animation: rotate 10s linear infinite;
        }

        /* Colored overlays for different win levels */
        .big-win-color {
            filter: none;
        }

        .mega-win-color {
            filter: none; /* Original gold/yellow color */
        }

        .ultra-win-color {
            filter: none;
        }

        @keyframes rotate {
            0% {
                transform: rotate(0deg);
            }
            100% {
                transform: rotate(360deg);
            }
        }

        .win-text {
            font-size: calc(2rem + 2vw);
            font-weight: bold;
            margin-bottom: 16px;
            text-shadow: 0 0 10px currentColor, 0 0 20px currentColor;
            animation: text-flicker 2s infinite;
            transition: color 0.5s, transform 0.5s;
            position: relative;
            z-index: 20;
        }

        .counter-text {
            font-size: calc(0.5rem + 2vw);
            font-weight: bold;
            color: #a67c00;
            text-shadow: 0 0 10px rgba(255, 215, 0, 0.7), 0 0 20px rgba(255, 215, 0, 0.5);
            animation: pulse 1.5s infinite;
            position: relative;
            z-index: 20;
        }

        #coinsContainer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            pointer-events: none;
            z-index: 5; /* Lower than sunburst */
        }

        .coin {
            position: absolute;
            filter: drop-shadow(0 0 5px rgba(255, 215, 0, 0.7));
            transition: transform 0.05s ease-out;
            z-index: 5; /* Lower than sunburst */
        }

        /* Win level styles */
        .big-win {
            color: #ffd700;
        }

        .mega-win {
            color: #ffd700;
        }

        .ultra-win {
            color: #ffd700;
        }

        @keyframes text-flicker {
            0%, 100% {
                opacity: 1;
                text-shadow: 0 0 10px currentColor, 0 0 20px currentColor;
            }
            50% {
                opacity: 0.9;
                text-shadow: 0 0 15px currentColor, 0 0 25px currentColor;
            }
        }

        @keyframes pulse {
            0%, 100% {
                transform: scale(1);
            }
            50% {
                transform: scale(1.05);
            }
        }

        @keyframes scale-in {
            0% {
                transform: scale(0.5);
                opacity: 0;
            }
            100% {
                transform: scale(1);
                opacity: 1;
            }
        }

        .scale-in {
            animation: scale-in 0.5s forwards;
        }

        /* Game info overlay */
        #gameinfo_overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: black;
            z-index: 2002;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            overflow: auto;
            display: none;
        }

        /* Features overlay */
        #featuresOverlay {
            display: none;
            z-index: 9999;
            position: absolute;
            height: 100%;
            width: 100%;
            background-color: rgb(0,0,0,0.8);
        }

        /* Device overlay */
        #device_overlay {
            display: none;
        }

        /* Free spins overlay */
        #freespinsoverlay {
            display: none;
            position: absolute;
            top: 0;
            left: 0;
            background-color: rgba(0, 0, 0, 0.8);
            height: 100%;
            width: 100%;
            z-index: 999999;
        }

        /* Canvas styles */
        canvas {
            display: block;
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }
    </style>
</head>
<body class="w-100">
<div style="background-image: url('page_bcg.png'); background-size: cover; height: 100vh; padding: 0 !important;">
    <div style="z-index: 3; position: absolute;">
        <button id="featuresButton" class="btn btn-warning mt-5 mb-2 mx-3">
            Feature
        </button>
    </div>
    <div id="featuresOverlay">
       <div style="height: 100%; width: 100%; font-weight: bold;" class="d-flex justify-content-center align-items-center">
            <div class="mx-auto">
                <div class="mx-auto">
                    <button onclick="setDemoFeature('big spin')" class="btn btn-warning btn-lg my-2 mb-2 mx-3">
                        Feature 1
                    </button>
                </div>
                <div class="mx-auto">
                    <button onclick="setDemoFeature('big win')" class="btn btn-warning btn-lg my-2 mx-3">
                        Feature 2
                    </button>
                </div>
                <div class="mx-auto">
                    <button onclick="setDemoFeature('free spins')" class="btn btn-warning btn-lg my-2 mb-2 mx-3">
                        Feature 3
                    </button>
                </div>
            </div>
       </div>
    </div>

    <div class="mobile-wrapper mx-auto">

        <div id="gameinfo_overlay" class="overlay" style="max-height: 100vh !important;overflow-y: scroll;overflow-x: hidden;">
            <div class="divider-container">
                <div class="divider-wrapper">
                    <div class="divider-text h3">GAME RULE</div>
                </div>
            </div>
            <div class="d-flex justify-content-center align-items-center">
                <div style="width: 90%;background-color: #e4d594;height: 5px;"></div>
            </div>
            <div class="" style="color: white;">
                <div style="border: 1px;border-color: #e4d594;font-size: 1.0rem;border-style: solid;" class="py-4 mx-3 d-flex justify-content-center align-items-around my-3">
                    <div class="px-2">
                        <span style="color: #e4d594;"> Denomination:</span> 0.01
                    </div>
                    <div class="px-2">
                        <span style="color: #e4d594;">Bet Multiplier:</span> 1
                    </div>
                </div>
                <div class="row px-3">
                    <div class="col-lg-3 col-md-12 col-sm-12 text-center px-4" style="font-weight: bold;">
                        <img src="wild.png" style="max-width: 100px;" alt="">
                        <div class="h3">WILD</div>
                    </div>
                    <div class="col-lg-9 col-md-12 col-lg-12" style="font-weight: bold;">
                        ONLY APPEARS ON REELS 2,3,4 AND 5.
                        <br>
                        <br>
                        <div class="d-flex justify-content-start align-items-center">
                            SUBSTITUTES FOR ALL SYMBOLS EXCEPT <img style="width: 40px;height: auto;" src="scatter.png" alt="">
                        </div>
                    </div>
                </div>
    
    
                <div class="row px-3 my-3">
                    <div class="col-lg-3 col-md-12 col-sm-12 text-center px-4 mb-3">
                        <img src="scatter.png" style="max-width: 100px;" alt="">
                        <div class="h3">FREE SPIN BONUS</div>
                    </div>
                    <div class="col-lg-9 col-md-12 col-lg-12" style="font-weight: bold;">
                        APPEARS ON ALL REELS
                        <br>
                        <div class="">
                            IF ATLEAST ONE <img style="width: 40px;height: auto;" src="scatter.png" alt=""> APPEARS ON ALL REELS FREE SPIN BONUS WITH 13 FREE SPINS AND A BONUS MULTIPLIER WILL BE TRIGGERED 
                        </div>
    
                        <div class="mt-4">
                            <div class="my-1">
                                5 <img style="width: 40px;height: auto;" class="px-1" src="scatter.png" alt=""> AWARD 3X BONUS MULTIPLIER
                            </div>
                            <div class="my-1">
                                6 <img style="width: 40px;height: auto;" class="px-1" src="scatter.png" alt=""> AWARD 6X BONUS MULTIPLIER
                            </div>
                            <div class="my-1">
                                7 <img style="width: 40px;height: auto;" class="px-1" src="scatter.png" alt=""> AWARD 12X BONUS MULTIPLIER
                            </div>
                            <div class="my-1">
                                8 <img style="width: 40px;height: auto;" class="px-1" src="scatter.png" alt=""> AWARD 24X BONUS MULTIPLIER
                            </div>
                            <div class="my-1">
                                9 <img style="width: 40px;height: auto;" class="px-1" src="scatter.png" alt=""> AWARD 36X BONUS MULTIPLIER
                            </div>
                            <div class="my-1">
                                10 <img style="width: 40px;height: auto;" class="px-1" src="scatter.png" alt=""> AWARD 72X BONUS MULTIPLIER
                            </div>
                        </div>
                    </div>
                </div>
    
                <div class="divider-container">
                    <div class="divider-wrapper">
                        <div class="divider-text h2" style="font-weight: bold;" >PAYTABLE</div>
                    </div>
                </div>
    
                <div class="d-flex justify-content-center align-items-center">
                    <div style="width: 90%;background-color: white;height: 2px;"></div>
                </div>
    
                <div class="row my-4" style="font-size: 1.1rem;font-weight: bold;">
                    <div class="my-3 col-12 col-lg-4 col-dm-4 col-sm-12 d-flex justify-content-center align-items-center align-items-center mx-2">
                        <img src="treasurechest.png" style="max-width: 100px;" alt="">
                        <div class="px-4">
                            <div class="my-1">
                                <span style="color: #e4d594;font-weight: bold;">5 - </span> 250
                            </div>
                            <div class="my-1">
                                <span style="color: #e4d594;font-weight: bold;">4 - </span> 100
                            </div>
                            <div class="my-1">
                                <span style="color: #e4d594;font-weight: bold;">3 - </span> 40
                            </div>
                        </div>
                    </div>
                    <div class="col-12 my-3 col-lg-4 col-dm-4 col-sm-12 d-flex justify-content-center align-items-center align-items-center mx-2">
                        <img src="explorer.png" style="max-width: 100px;" alt="">
                        <div class="px-4">
                            <div class="my-1">
                                <span style="color: #e4d594;font-weight: bold;">5 - </span> 200
                            </div>
                            <div class="my-1">
                                <span style="color: #e4d594;font-weight: bold;">4 - </span> 80
                            </div>
                            <div class="my-1">
                                <span style="color: #e4d594;font-weight: bold;">3 - </span> 30
                            </div>
                        </div>
                    </div>
                    <div class="col-12 my-3 col-lg-4 col-dm-4 col-sm-12 d-flex justify-content-center align-items-center align-items-center mx-2">
                        <img src="compass.png" style="max-width: 100px;" alt="">
                        <div class="px-4">
                            <div class="my-1">
                                <span style="color: #e4d594;font-weight: bold;">5 - </span> 175
                            </div>
                            <div class="my-1">
                                <span style="color: #e4d594;font-weight: bold;">4 - </span> 60
                            </div>
                            <div class="my-1">
                                <span style="color: #e4d594;font-weight: bold;">3 - </span> 25
                            </div>
                        </div>
                    </div>
                </div>
                <div class="row my-4" style="font-size: 1.1rem;font-weight: bold;">
                    <div class="my-3 col-12 col-lg-4 col-dm-4 col-sm-12 d-flex justify-content-center align-items-center align-items-center mx-2">
                        <img src="binoculars.png" style="max-width: 100px;" alt="">
                        <div class="px-4">
                            <div class="my-1">
                                <span style="color: #e4d594;font-weight: bold;">5 - </span> 150
                            </div>
                            <div class="my-1">
                                <span style="color: #e4d594;font-weight: bold;">4 - </span> 50
                            </div>
                            <div class="my-1">
                                <span style="color: #e4d594;font-weight: bold;">3 - </span> 20
                            </div>
                        </div>
                    </div>
                    <div class="my-3 col-12 col-lg-4 col-dm-4 col-sm-12 d-flex justify-content-center align-items-center align-items-center mx-2">
                        <img src="a.png" style="max-width: 100px;" alt="">
                        <div class="px-4">
                            <div class="my-1">
                                <span style="color: #e4d594;font-weight: bold;">5 - </span> 100
                            </div>
                            <div class="my-1">
                                <span style="color: #e4d594;font-weight: bold;">4 - </span> 20
                            </div>
                            <div class="my-1">
                                <span style="color: #e4d594;font-weight: bold;">3 - </span> 10
                            </div>
                        </div>
                    </div>
                    <div class="my-3 col-12 col-lg-4 col-dm-4 col-sm-12 d-flex justify-content-center align-items-center align-items-center mx-2">
                        <img src="k.png" style="max-width: 100px;" alt="">
                        <div class="px-4">
                            <div class="my-1">
                                <span style="color: #e4d594;font-weight: bold;">5 - </span> 90
                            </div>
                            <div class="my-1">
                                <span style="color: #e4d594;font-weight: bold;">4 - </span> 15
                            </div>
                            <div class="my-1">
                                <span style="color: #e4d594;font-weight: bold;">3 - </span> 8
                            </div>
                        </div>
                    </div>
                </div>
                <div class="row my-4" style="font-size: 1.1rem;font-weight: bold;">
                    <div class="my-3 col-12 col-lg-4 col-dm-4 col-sm-12 d-flex justify-content-center align-items-center align-items-center mx-2">
                        <img src="q.png" style="max-width: 100px;" alt="">
                        <div class="px-4">
                            <div class="my-1">
                                <span style="color: #e4d594;font-weight: bold;">5 - </span> 80
                            </div>
                            <div class="my-1">
                                <span style="color: #e4d594;font-weight: bold;">4 - </span> 12
                            </div>
                            <div class="my-1">
                                <span style="color: #e4d594;font-weight: bold;">3 - </span> 6
                            </div>
                        </div>
                    </div>
                    <div class="my-3 col-12 col-lg-4 col-dm-4 col-sm-12 d-flex justify-content-center align-items-center align-items-center mx-2">
                        <img src="j.png" style="max-width: 100px;" alt="">
                        <div class="px-4">
                            <div class="my-1">
                                <span style="color: #e4d594;font-weight: bold;">5 - </span> 70
                            </div>
                            <div class="my-1">
                                <span style="color: #e4d594;font-weight: bold;">4 - </span> 10
                            </div>
                            <div class="my-1">
                                <span style="color: #e4d594;font-weight: bold;">3 - </span> 5
                            </div>
                        </div>
                    </div>
                    <div class="my-3 col-12 col-lg-4 col-dm-4 col-sm-12 d-flex justify-content-center align-items-center align-items-center mx-2" style="visibility: hidden;">
                        
                    </div>
                </div>
    
                <div style="font-size: 1.0rem;" class="text-center">
                    <div class="my-1">
                        ALL WINS PAY LEFTMOST TO RIGHT, EXCEPT <img src="scatter.png" style="max-width: 40px;" alt="">
                    </div>
                    <div class="my-1">
                        PAYTABLE WINS ARE SHOWN FOR BET MULTIPLIER X1.
                    </div>
                    <div class="my-1">
                        PAYTABLE WINS ARE SHOWN IN CREDITS
                    </div>
                </div>
    
                <div class="divider-container mt-5">
                    <div class="divider-wrapper">
                        <div class="divider-text h2" style="font-weight: bold;">FREE SPIN BONUS</div>
                    </div>
                </div>
    
                <div class="d-flex justify-content-center align-items-center">
                    <div style="width: 90%;background-color: white;height: 2px;"></div>
                </div>
                
    
                <div style="font-size: 1.0rem;border: 1px;border-style: solid;border-color: white;" class="px-4 my-3 mx-3 py-2">
                    IF AT LEAST ONE <img style="max-width: 40px;" src="scatter.png" alt=""> APPEARS ON EACH REEL, ADDITIONAL 13 FREE SPINS ARE AWARDED, TO A MAXIMUM OF 100 FREE SPINS IN A SINGLE BOUGHT GAME. RETRIGGER OF FREE SPIN BONUS WILL NOT CHANGE THE BONUS MULTIPLIER OF THE FREE SPIN BONUS. 
                    <br>
                    DURING FREE SPIN BONUS, THE WINS ARE MULTIPLIED BY THE BONUS MULTIPLIER AND ADDED TO THE WIN METER
                </div>
    
                <div style="border: 1px;border-color: #e4d594;font-size: 1.0rem;border-style: solid;" class="py-4 mx-3 d-flex justify-content-center align-items-around my-3">
                    <div class="px-2">
                        <span style="color: #e4d594;"> Denomination:</span> 0.01
                    </div>
                    <div class="px-2">
                        <span style="color: #e4d594;">Bet Multiplier:</span> 1
                    </div>
                </div>

                <div class="row px-3">
                    <div class="col-lg-3 col-md-12 col-sm-12 text-center px-4" style="font-weight: bold;">
                        <img src="wild.png" style="max-width: 100px;" alt="">
                        <div class="h3">WILD</div>
                    </div>
                    <div class="col-lg-9 col-md-12 col-lg-12" style="font-weight: bold;">
                        ONLY APPEARS ON REELS 2,3,4 AND 5.
                        <br>
                        <br>
                        <div class="d-flex justify-content-start align-items-center">
                            SUBSTITUTES FOR ALL SYMBOLS EXCEPT <img style="width: 40px;height: auto;" src="scatter.png" alt="">
                        </div>
                    </div>
                </div>

                <div class="row px-3 my-3">
                    <div class="col-lg-3 col-md-12 col-sm-12 text-center px-4 mb-3">
                        <img src="scatter.png" style="max-width: 100px;" alt="">
                        <div class="h3">FREE SPIN BONUS</div>
                    </div>
                    <div class="col-lg-9 col-md-12 col-lg-12" style="font-weight: bold;">
                        APPEARS ON ALL REELS
                    </div>
                </div>
    
    
                <div class="row my-4" style="font-size: 1.1rem;font-weight: bold;">
                    <div class="my-3 col-12 col-lg-4 col-dm-4 col-sm-12 d-flex justify-content-center align-items-center align-items-center mx-2">
                        <img src="treasurechest.png" style="max-width: 100px;" alt="">
                        <div class="px-4">
                            <div class="my-1">
                                <span style="color: #e4d594;font-weight: bold;">5 - </span> 250
                            </div>
                            <div class="my-1">
                                <span style="color: #e4d594;font-weight: bold;">4 - </span> 100
                            </div>
                            <div class="my-1">
                                <span style="color: #e4d594;font-weight: bold;">3 - </span> 40
                            </div>
                        </div>
                    </div>
                    <div class="col-12 my-3 col-lg-4 col-dm-4 col-sm-12 d-flex justify-content-center align-items-center align-items-center mx-2">
                        <img src="explorer.png" style="max-width: 100px;" alt="">
                        <div class="px-4">
                            <div class="my-1">
                                <span style="color: #e4d594;font-weight: bold;">5 - </span> 200
                            </div>
                            <div class="my-1">
                                <span style="color: #e4d594;font-weight: bold;">4 - </span> 80
                            </div>
                            <div class="my-1">
                                <span style="color: #e4d594;font-weight: bold;">3 - </span> 30
                            </div>
                        </div>
                    </div>
                    <div class="col-12 my-3 col-lg-4 col-dm-4 col-sm-12 d-flex justify-content-center align-items-center align-items-center mx-2">
                        <img src="compass.png" style="max-width: 100px;" alt="">
                        <div class="px-4">
                            <div class="my-1">
                                <span style="color: #e4d594;font-weight: bold;">5 - </span> 175
                            </div>
                            <div class="my-1">
                                <span style="color: #e4d594;font-weight: bold;">4 - </span> 60
                            </div>
                            <div class="my-1">
                                <span style="color: #e4d594;font-weight: bold;">3 - </span> 25
                            </div>
                        </div>
                    </div>
                </div>
                <div class="row my-4" style="font-size: 1.1rem;font-weight: bold;">
                    <div class="my-3 col-12 col-lg-4 col-dm-4 col-sm-12 d-flex justify-content-center align-items-center align-items-center mx-2">
                        <img src="binoculars.png" style="max-width: 100px;" alt="">
                        <div class="px-4">
                            <div class="my-1">
                                <span style="color: #e4d594;font-weight: bold;">5 - </span> 150
                            </div>
                            <div class="my-1">
                                <span style="color: #e4d594;font-weight: bold;">4 - </span> 50
                            </div>
                            <div class="my-1">
                                <span style="color: #e4d594;font-weight: bold;">3 - </span> 20
                            </div>
                        </div>
                    </div>
                    <div class="my-3 col-12 col-lg-4 col-dm-4 col-sm-12 d-flex justify-content-center align-items-center align-items-center mx-2">
                        <img src="a.png" style="max-width: 100px;" alt="">
                        <div class="px-4">
                            <div class="my-1">
                                <span style="color: #e4d594;font-weight: bold;">5 - </span> 100
                            </div>
                            <div class="my-1">
                                <span style="color: #e4d594;font-weight: bold;">4 - </span> 20
                            </div>
                            <div class="my-1">
                                <span style="color: #e4d594;font-weight: bold;">3 - </span> 10
                            </div>
                        </div>
                    </div>
                    <div class="my-3 col-12 col-lg-4 col-dm-4 col-sm-12 d-flex justify-content-center align-items-center align-items-center mx-2">
                        <img src="k.png" style="max-width: 100px;" alt="">
                        <div class="px-4">
                            <div class="my-1">
                                <span style="color: #e4d594;font-weight: bold;">5 - </span> 90
                            </div>
                            <div class="my-1">
                                <span style="color: #e4d594;font-weight: bold;">4 - </span> 15
                            </div>
                            <div class="my-1">
                                <span style="color: #e4d594;font-weight: bold;">3 - </span> 8
                            </div>
                        </div>
                    </div>
                </div>
                <div class="row my-4" style="font-size: 1.1rem;font-weight: bold;">
                    <div class="my-3 col-12 col-lg-4 col-dm-4 col-sm-12 d-flex justify-content-center align-items-center align-items-center mx-2">
                        <img src="q.png" style="max-width: 100px;" alt="">
                        <div class="px-4">
                            <div class="my-1">
                                <span style="color: #e4d594;font-weight: bold;">5 - </span> 80
                            </div>
                            <div class="my-1">
                                <span style="color: #e4d594;font-weight: bold;">4 - </span> 12
                            </div>
                            <div class="my-1">
                                <span style="color: #e4d594;font-weight: bold;">3 - </span> 6
                            </div>
                        </div>
                    </div>
                    <div class="my-3 col-12 col-lg-4 col-dm-4 col-sm-12 d-flex justify-content-center align-items-center align-items-center mx-2">
                        <img src="j.png" style="max-width: 100px;" alt="">
                        <div class="px-4">
                            <div class="my-1">
                                <span style="color: #e4d594;font-weight: bold;">5 - </span> 70
                            </div>
                            <div class="my-1">
                                <span style="color: #e4d594;font-weight: bold;">4 - </span> 10
                            </div>
                            <div class="my-1">
                                <span style="color: #e4d594;font-weight: bold;">3 - </span> 5
                            </div>
                        </div>
                    </div>
                    <div class="my-3 col-12 col-lg-4 col-dm-4 col-sm-12 d-flex justify-content-center align-items-center align-items-center mx-2" style="visibility: hidden;">
                        
                    </div>
                </div>
    
                <div style="font-size: 1.0rem;" class="text-center">
                    <div class="my-1">
                        ALL WINS PAY LEFTMOST TO RIGHT, EXCEPT <img src="scatter.png" style="max-width: 40px;" alt="">
                    </div>
                    <div class="my-1">
                        PAYTABLE WINS ARE SHOWN FOR BET MULTIPLIER X1.
                    </div>
                    <div class="my-1">
                        PAYTABLE WINS ARE SHOWN IN CREDITS
                    </div>
                </div>
    
                <div class="divider-container mt-5">
                    <div class="divider-wrapper">
                        <div class="divider-text" style="font-weight: bold;">243 WAYS</div>
                    </div>
                </div>
    
                <div class="d-flex justify-content-center align-items-center">
                    <div style="width: 90%;background-color: white;height: 2px;"></div>
                </div>
    
                <div class="row px-3 my-3">
                    <div class="col-lg-3 col-md-12 col-sm-12 text-center px-4">
                        <img src="tick.png" class="mx-5" style="max-width: 70%;" alt="">
                    </div>
                    <div class="col-lg-9 col-md-12 col-lg-12">
                        REELS = 5
                        <div class="d-flex justify-content-start align-items-center">
                            PLAY 5 REELS WITH MINIMUM BET 30 MULTIPLIED BY DENOMINATION.
                        </div>
                    </div>
                </div>
                <div>
                    <div style="width: 90%;margin-bottom: 140px;" class="mx-auto mt-3 pb-3">
                        <div>
                            ALL WINNING COMBINATIONS PAY FROM LEFT TO RIGHT ON ADJACENT REELS BEGINNING FROM LEFTMOST EXCEPT <img src="scatter.png" style="width: 40px;" alt="">
                        </div>
                        <div>
                            ALL WINS ARE MULTIPLIED BY THE BET MULTIPLIER. ONLY THE HIGHEST WINNING COMBINATION IS PAID ON EACH PAY WAY.
                        </div>
                    </div>
                </div>
            </div>
    
            <div class="text-center py-3 w-100" style="position: fixed;bottom: 0;background-color: #191818;color: white;font-size: 1.0rem;z-index: 9999;margin: 0 !important;">
                <div>
                    MALFUNCTION VOIDS ALL PLAYS AND PAYS.
                </div>
                <div class="my-2 d-flex justify-content-center align-items-center">
                    <div class="d-flex justify-content-center align-items-center" style="height: 45px;width: 45px;border-radius: 50%;border-color: white;border-style: solid;">
                        <i id="close_info_button" class="fa fa-arrow-left fa-2x py-2 px-2"></i>
                    </div>
                </div>
            </div>
        </div>


        <div id="device_overlay">
            <div class="d-flex flex-column justify-content-center align-items-center text-center p-4" 
                style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.99); color: white; font-size: 1.5rem; text-align: center; z-index: 9999; display: flex;">
                <div class="container">
                    <h2 class="fw-bold">FOR AN OPTIMAL GAMING EXPERIENCE</h2>
                    <p class="lead">USE A MOBILE DEVICE</p>
                    <div class="my-3 text-center my-3">
                        <i class="fa fa-mobile-alt fa-3x"></i>
                    </div>
                </div>
            </div>
        </div>

        <div id="winOverlay" class="mobile-wrapper">
            <button id="closeBtn" class="btn-close btn-close-white" aria-label="Close"></button>
            <div id="coinsContainer"></div>
            <div class="sunburst-container">
                <div id="sunburst" class="sunburst mega-win-color"></div>
            </div>
            <div class="win-content">
                <h2 id="winText" class="win-text big-win">BIG WIN</h2>
                <div class="counter-text" id="winAmount">$0</div>
            </div>
        </div>
        
        <div id="jdb_overlay" style="display: none;">
            <div style="height: 100%; width: 100%;" class="d-flex justify-content-center align-items-center">
                <div class="row">
                    <div class="d-flex justify-content-center align-items-center mx-auto">
                        <div>
                            <img src="jdb_logo.png" style="max-width: 100%;" alt="mx-auto">
                            <div class="d-flex justify-content-center mx-auto">
                                <div class="loader-container" style="width: 50%; border-style: solid; border-width: 1px; border-radius: 12px;">
                                    <div class="loader-bar" style="border-radius: 12px;" id="loader-bar"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    
        <div id="kong_overlay" style="display: none;">
            <div class="d-flex justify-content-center">
                <button class="glowing-button text-white" onclick="hideKongOverlay()">START</button>
            </div>
        </div>
    
        <div id="game-container" class="victor-mono">
            <div>
                <img id="img_top" src="bg-top6.gif" style="width: 100%;height: auto;" alt="">
                <img id="img_top_volcano_part_1" src="volcano.gif" style="width: 100%;height: auto;display: none;" alt="">
                <img id="img_top_volcano_part_2" src="volcano-part-2-complete.gif" style="width: 100%;height: auto;display: none;" alt="">
            </div>
            <div id="playground" style="position: relative; overflow: hidden;min-height: 35vh; width: 100%; background-size: cover; z-index: 99;">
                <!-- Start Free Spins Overlay -->
                <div id="startfreespinsoverlay" style="display: none; position: absolute; top: 0; left: 0; height: 100%; width: 100%; z-index: 999999;">
                    <div class="d-flex justify-content-center align-items-center" style="height: 100%; width: 100%;">
                        <div id="startfreespinsbutton" onclick="startFreeSpins()" class="py-1 px-3 text-white" style="border-radius: 6px; border: 2px white solid; font-size: 0.75rem; background-color: rgba(0, 0, 0, 0.8);">
                            PRESS REEL TO START THE BONUS
                        </div>
                    </div>
                </div>

                <!-- Free Spins Overlay -->
                <div id="freespinsoverlay" style="display: none; position: absolute; top: 0; left: 0; background-color: rgba(0, 0, 0, 0.8); height: 100%; width: 100%; z-index: 999999;">
                    <div class="py-3 px-3 d-flex justify-content-center align-items-center" style="height: 100%;width:100%;">
                        <img class="py-2 px-2" id="freespinsoverlayimg" src="freespinsoverlay.png" style="width: 85%; height: auto;" alt="">
                        <img class="py-2 px-2" id="freespinsoverlayimg2" src="additionalfreespins.png" style="display: none; width: 85%; height: auto;" alt="">
                    </div>
                </div>

                <!-- Game Canvas Content -->
                <div class="game-canvas-container">
                    <!-- Free Spins Indicator -->
                    <div id="free-spins-indicator" class="free-spins-indicator">
                        FREE SPINS: <span id="free-spins-count">0</span> | MULTIPLIER: <span id="bonus-multiplier">0</span>x
                    </div>

                    <!-- Win Message -->
                    <div id="win-message" class="win-message">
                        <div>BIG WIN!</div>
                        <div id="win-amount">0.00</div>
                    </div>
                    
                    <!-- Canvas for the slot machine -->
                    <canvas id="slotMachine"></canvas>
                </div>
            </div>

            <!-- Controls -->
            <div class="game-controls p-2">
                <div id="results_holder" class="w-100 text-center text-white d-flex justify-content-center align-items-center" style="margin-top: -25px;height: 25px; font-size: 1.3rem;">
                    <div style="margin: 5px 0px;">
                        WIN <span class="px-1" id="update_winnings">0.00</span>
                    </div>
                </div>
                <div id="freespins_display" style="display: none; justify-content: center; align-items: center; padding-top: 2px;max-width: 100%;height: 100px;">
                    <img class="fs-text-image"  src="freespin_part_a.png" alt="">
                    <span class="px-3" id="remaining_fs_holder" >0</span>
                    <img class="fs-text-image" src="freespin_part_b.png"  alt="">
                    <span class="px-3" id="total_fs_holder">0</span>
                </div>
                <div id="normalspins_display" style="display: flex; justify-content: center; align-items: center; padding-top: 2px">
                    <div id="autoPlayButton" class="rounded-circle d-flex justify-content-center align-items-center autoplay-button" style="background-image: url('autospinbcg.png');background-size: cover;">
                        <img src="autospininnerimg.png" class="autospininner-img"  alt="">
                    </div>
                    <div id="spinButton" class="mx-4 d-flex justify-content-center align-items-center spin-button" style="border-radius: 50%;background-image: url('spinbcg.png');background-size: cover;">
                        <div id="remainingAutoSpins" style="z-index: 2;position: absolute;color: darkorange;font-weight:bolder;font-size: 1.5rem;">
                        </div>
                        <div class="d-flex justify-content-center align-items-center spin-img" id="spin_img" style="background: url('spininnerimg.png');background-size: cover;">
                            
                        </div>
                    </div>
                    
                    <!-- Stake button that opens the overlay -->
                    <div id="stakeButton" class="text-center d-flex justify-content-center align-items-center stake-button" style="background-image: url('totalbetbcg.png');background-size: cover;color: orange;font-size: 0.85rem;line-height: 1;font-weight: 900;border-radius: 50%;">
                        <div>
                            <div class="d-flex justify-content-center">
                                <img src="totalbetinnerimg.png" class="totalbetinner-img"  alt="">
                            </div>
                            <div class="text-center">
                                <span id="currentStake" class="current-stake">0.3</span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="container mb-2">
                    <div style="display: flex; width: 100%; position: relative; align-items: center;">
                        <div onclick="displaySettingsOverlay2()" id="settingsButton" style="border-radius: 50%;width: 50px; height: 50px;background-image: url('settings.png');background-size: cover;">
                        </div>

                        <script>
                            function displaySettingsOverlay2() {
                                settingsOverlay.style.display = 'block';
                            };
                        </script>

                        <!-- Button at the center -->
                        <div style="position: absolute; left: 50%; transform: translateX(-50%); text-align: center;">
                            <span class="text-center">
                                <span class="badge px-4 py-2 text-white" style="background-color: rgba(0,0,0,0.7);">CREDIT: <span id="balanceText">...</span></span>
                                <br>
                                <span class="text-white text-center" style="font-size: 1.0rem;">
                                    &lt; <span>DEMO GAME</span> &gt;
                                </span>
                            </span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    
        <!-- Stake Selection Overlay -->
        <div id="stakeOverlay" class="overlay" style="margin: 0 !important;padding: 0 !important;">
            <div class="divider-container">
                <div class="divider-wrapper">
                    <div class="divider"></div>
                    <div class="divider-text">TOTAL BET</div>
                    <div class="divider"></div>
                </div>
            </div>
            <div class="overlay-content-stake ">
                <div class="overlay-header">FUN</div>
                <div class="options-grid mx-auto" id="stakeOptions">
                    <button class="option-button" data-value="3.0">3.0</button>
                    <button class="option-button" data-value="1.5">1.5</button>
                    <button class="option-button" data-value="0.9">0.9</button>
                    <button class="option-button" data-value="0.6">0.6</button>
                    <button class="option-button selected" data-value="0.3">0.3</button>
                </div>
                <div class="text-center text-white mt-5 pt-5">
                    <span style="margin-left: 20px;">
                        Reels: 5
                    </span>
                </div>
                <div class="overlay-footer w-100">
                    <button style="display: none;" class="cancel-button px-4" id="cancelStake">Cancel</button>
                    <button class="confirm-button px-5" id="confirmStake">OK</button>
                </div>
            </div>
        </div>
    
        <!-- Auto Spin Overlay -->
        <div id="autoSpinOverlay" class="overlay">
            <div class="divider-container">
                <div class="divider-wrapper">
                    <div class="divider"></div>
                    <div class="divider-text">AUTOPLAYS</div>
                    <div class="divider"></div>
                </div>
            </div>
            <div class="overlay-content w-100" style="margin-top: 20px !important;">
                <div class="mb-2 text-white">
                    NUMBER OF SPINS
                </div>
                <div class="options-grid" id="autoSpinOptions">
                    <button class="option-button" data-value="0"><i class="fa fa-stop"></i></button>
                    <button class="option-button" data-value="999">999</button>
                    <button class="option-button" data-value="200">200</button>
                    <button class="option-button" data-value="100">100</button>
                    <button class="option-button" data-value="30">30</button>
                </div>
                
<div class="mt-4 mb-2 text-white">
    LOSS LIMIT
</div>
<div class="options-grid" id="lossLimitOptions">
    <button class="option-button" data-value="Infinity"><i class="fa fa-infinity"></i></button>
    <button class="option-button" data-value="500">500<span style="font-size: 0.7rem;">x BET</span></button>
    <button class="option-button" data-value="100">100<span style="font-size: 0.7rem;">x BET</span></button>
    <button class="option-button" data-value="50">50<span style="font-size: 0.7rem;">x BET</span></button>
    <button class="option-button" data-value="10">10<span style="font-size: 0.7rem;">x BET</span></button>
</div>
                <div class="divider-container my-3">
                    <div class="divider-wrapper">
                        <div style="height: 2px;background-color: #e4d594;width: 25vw;"></div>
                        <div class="divider-text" >QUICK SPIN</div>
                        <div style="height: 2px;background-color: #e4d594;width: 25vw;"></div>
                    </div>
                </div>
                <div class="d-flex justify-content-center align-items-center">
                    <img id="quickspin-toggle" src="quickspin-a.png" style="height: 60px;width: 60px;" alt="">
                </div>
                <div class="overlay-footer">
                    <button class="cancel-button" id="cancelAutoSpin">Cancel</button>
                    <button class="confirm-button px-5" id="confirmAutoSpin">Ok</button>
                </div>
            </div>
        </div>
    
        <!-- Settings Overlay -->
        <div id="settingsOverlay" class="overlay" style="background-color: rgb(0,0,0,0.8); margin: 0 !important; padding: 0 !important;">
            <div onclick="hideSettingsOverlay()" class="overlay-content w-100" style="height: 100%; margin: 0 !important; padding: 0 !important;">
                <div>
                    <div style="display: none;">
                        <div class="d-flex justify-content-center">
                            <div id="soundEffectsOption" class="sound-option selected mx-auto">
                                <div>
                                    <span id="soundEffectsIcon" class="icon-container"></span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="overlay-footer" style="background-image: url('bcg-settings.png');background-size: cover;margin: 0 !important;padding: 0 !important;">
                <div class="w-100 mb-2">
                    <div class="d-flex justify-content-around align-items-center py-5 px-3 w-100">
                        <div id="info_button" class="sound-option selected">
                            <div class="d-flex justify-content-center align-items-center" style="color: #e4d594; width: 30px; height: 30px; border-radius: 50%; border-color: #e4d594; border-style: solid;">
                                <i class="fas fa-question" style="font-size: 1.2rem; font-weight: bold;"></i>
                            </div>
                        </div>
                        <div id="backgroundMusicOption" class="sound-option selected">
                            <div>
                                <span id="backgroundMusicIcon" class="icon-container">
                                    <i class="fa fa-volume-up" style="color: #e4d594; font-size: 1.4rem;"></i>
                                </span>
                            </div>
                        </div>
                    </div>
                    <div class="d-flex justify-content-center text-white">
                        <i class="fa fa-user px-1"></i> <span style="font-size: 0.7rem;">demo004817</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/pixi.js/7.4.0/pixi.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
    // Game configuration
    const REEL_COUNT = 5;
    const SYMBOLS_PER_REEL = 3;
    const SYMBOL_SIZE = 100;
    const REEL_WIDTH = SYMBOL_SIZE;
    const REEL_HEIGHT = SYMBOL_SIZE * SYMBOLS_PER_REEL;
    // Individual wall thickness for each wall (top, right, bottom, left)
    const WALL_THICKNESS = {
        top: 20,
        right: 7,
        bottom: 25,
        left: 7
    };
    const GAME_WIDTH = REEL_WIDTH * REEL_COUNT + WALL_THICKNESS.left + WALL_THICKNESS.right;
    const GAME_HEIGHT = REEL_HEIGHT + WALL_THICKNESS.top + WALL_THICKNESS.bottom;
    
    // Extra symbols to draw above and below visible area for smooth scrolling
    const EXTRA_SYMBOLS = 2;

    const SYMBOLS = [
        { name: 'Treasure Chest', image: 'treasurechest.png', color: '#ff5252', payouts: [0, 0, 40, 100, 250], normal_scale: 1.2, z_index: 10 },
        { name: 'Explorer', image: 'explorer.png', color: '#ffeb3b', payouts: [0, 0, 30, 80, 200], normal_scale: 1.2, z_index: 5 },
        { name: 'Compass', image: 'compass.png', color: '#ff9800', payouts: [0, 0, 25, 60, 175], normal_scale: 1.15, z_index: 4 },
        { name: 'Binoculars', image: 'binoculars.png', color: '#9c27b0', payouts: [0, 0, 20, 50, 150], normal_scale: 1.15, z_index: 4 },
        { name: 'A', image: 'A.png', color: '#f44336', payouts: [0, 0, 10, 20, 100], normal_scale: 1.10, z_index: 3 },
        { name: 'K', image: 'K.png', color: '#4caf50', payouts: [0, 0, 8, 15, 90], normal_scale: 1.10, z_index: 3 },
        { name: 'Q', image: 'Q.png', color: '#ffc107', payouts: [0, 0, 6, 12, 80], normal_scale: 1.10, z_index: 3 },
        { name: 'J', image: 'J.png', color: '#2196f3', payouts: [0, 0, 5, 10, 70], normal_scale: 1.10, z_index: 3 },
        { name: 'Wild', image: 'wild.png', color: '#00bcd4', payouts: [0, 0, 50, 125, 300], normal_scale: 1.25, z_index: 10 },
        { name: 'Scatter', image: 'scatter.png', color: '#e91e63', payouts: [0, 0, 5, 20, 50], normal_scale: 1.30, z_index: 11 }
    ];

    
    const SYMBOL_SCALE_MAP = {
        'Treasure Chest': 1.4,
        'Explorer': 1.3,
        'Compass': 1.3,
        'Binoculars': 1.3,
        'A': 1.2,
        'K': 1.2,
        'Q': 1.2,
        'J': 1.2,
        'Wild': 1.55,
        'Scatter': 1.8
    };


    // Wall colors (different backgrounds)
    const WALL_BACKGROUNDS = [
        '#3a0ca3', // top
        '#4361ee', // right
        '#4cc9f0', // bottom
        '#7209b7'  // left
    ];

    // Global variables for animations
    let activeAnimations = {};
    let wildFrameImages = [];
    let loadedWildFrames = 0;
    const wildFrameCount = 33;


    // Load individual reel background images
    const reelBackgroundImages = [];
    const reelBackgroundLoaded = [];

    for (let i = 0; i < REEL_COUNT; i++) {
        reelBackgroundImages[i] = new Image();
        reelBackgroundImages[i].src = `reel-bg.jpg`; // Replace with your image paths
        reelBackgroundImages[i].crossOrigin = "anonymous"; // Avoid CORS issues
        reelBackgroundLoaded[i] = false;
        
        reelBackgroundImages[i].onload = () => {
            reelBackgroundLoaded[i] = true;
        };
    }

    // Get canvas and context
    const canvas = document.getElementById('slotMachine');
    const ctx = canvas.getContext('2d');
    
    // Get DOM elements
    const spinButton = document.getElementById('spinButton');
    const autoPlayButton = document.getElementById('autoPlayButton');
    const stakeButton = document.getElementById('stakeButton');
    const settingsButton = document.getElementById('settingsButton');
    const featuresButton = document.getElementById('featuresButton');
    const featuresOverlay = document.getElementById('featuresOverlay');
    const remainingAutoSpins = document.getElementById('remainingAutoSpins');
    const spinButtonInnerImage = document.getElementById('spin_img');
    const balanceText = document.getElementById('balanceText');
    const currentStakeElement = document.getElementById('currentStake');
    const stakeOverlay = document.getElementById('stakeOverlay');
    const infoOverlay = document.getElementById('gameinfo_overlay');
    const closeInfoButton = document.getElementById('close_info_button');
    const infoButton = document.getElementById('info_button');
    const autoSpinOverlay = document.getElementById('autoSpinOverlay');
    const stakeOptions = document.getElementById('stakeOptions');
    const autoSpinOptions = document.getElementById('autoSpinOptions');
    const cancelStakeButton = document.getElementById('cancelStake');
    const confirmStakeButton = document.getElementById('confirmStake');
    const cancelAutoSpinButton = document.getElementById('cancelAutoSpin');
    const confirmAutoSpinButton = document.getElementById('confirmAutoSpin');
    const winMessageElement = document.getElementById('win-message');
    const winAmountElement = document.getElementById('win-amount');
    const freeSpinsIndicator = document.getElementById('free-spins-indicator');
    const freeSpinsCountElement = document.getElementById('free-spins-count');
    const bonusMultiplierElement = document.getElementById('bonus-multiplier');
    const settingsOverlay = document.getElementById('settingsOverlay');
    const soundEffectsOption = document.getElementById('soundEffectsOption');
    const backgroundMusicOption = document.getElementById('backgroundMusicOption');
    const soundEffectsIcon = document.getElementById('soundEffectsIcon');
    const backgroundMusicIcon = document.getElementById('backgroundMusicIcon');
    const startFreeSpinsOverlay = document.getElementById('startfreespinsoverlay');
    const startFreeSpinsButton = document.getElementById('startFreeSpinsbutton');
    const freeSpinsOverlay = document.getElementById('freespinsoverlay');
    const freeSpinsOverlayImg = document.getElementById('freespinsoverlayimg');
    const freeSpinsOverlayImg2 = document.getElementById('freespinsoverlayimg2');
    const quickspinToggleImg = document.getElementById('quickspin-toggle');
    const loaderBar = document.getElementById('loader-bar');
    const jdbOverlay = document.getElementById('jdb_overlay');
    const kongOverlay = document.getElementById('kong_overlay');
    const deviceOverlay = document.getElementById('device_overlay');
    const lossLimitOptions = document.getElementById('lossLimitOptions');

    // Game state
    let spinning = false;
    let reels = [];
    let finalResults = [];
    let winAmount = 0;
    let winAmountDisplay = 0;
    let winAnimationStartTime = 0;
    let isAnimatingWin = false;
    let symbolImages = {}; // Object to store loaded images
    let imagesLoaded = 0;
    let totalImages = SYMBOLS.length;
    let balance = 0; // Starting balance
    let stake = 0.3; // Default bet amount
    let autoSpins = 0;
    let currentInterval;
    let selectedStake = 0.3; // Default stake value
    let selectedAutoSpins = 0; // Default auto spins value
    let initialBalance = 0;
    let lossLimit = Infinity; // Default to no limit
    let selectedLossLimit = Infinity; // Default selected loss limit
    let autoSpinsStopped = true;
    let isQuickSpinMode = false;
    
    // Free spins state
    let freeSpinTriggeredRecently = false;
    let isFreeSpinMode = false;
    let freeSpinCount = 0;
    let remainingFreeSpinCount = 0;
    let bonusMultiplier = 0;
    let originalBetAmount = 0;
    
    // Sound control variables
    let soundEffectsEnabled = true;
    let backgroundMusicEnabled = true;
    let tempSoundEffectsEnabled = true;
    let tempBackgroundMusicEnabled = true;
    
    // Game mode
    const gameMode = {
        'mode': 'live'
    };
    const currentDemoFeature = {
        "feature": "normal spin"
    };

    
    
    // Audio elements
    const backgroundMusic = new Audio();
    backgroundMusic.src = 'gameaudio.mp3';
    backgroundMusic.loop = true;
    backgroundMusic.volume = 0.5;
    backgroundMusic.preload = 'auto';

    const bigWinSound = new Audio();
    bigWinSound.src = 'sounds/SE_BigWin.mp3';
    bigWinSound.loop = true;
    bigWinSound.volume = 0.8;

    const reelSpeedUpSound = new Audio();
    reelSpeedUpSound.src = 'sounds/SE_ReelSpeedUp.mp3';
    reelSpeedUpSound.loop = true;
    reelSpeedUpSound.volume = 0.9;

    const freeSpinSound = new Audio();
    freeSpinSound.src = 'sounds/SE_Free_BG.mp3';
    freeSpinSound.loop = true;
    freeSpinSound.volume = 0.9;

    const spinSound = new Audio();
    spinSound.src = 'sounds/spin.mp3';
    spinSound.preload = 'auto';
    
    const winSound = new Audio();
    winSound.src = 'win.mp3';
    winSound.preload = 'auto';

    // Coin images for win animation
    coinImages = [
        "coins/0_BigWin_SS.png", "coins/1_BigWin_SS.png", "coins/2_BigWin_SS.png", "coins/3_BigWin_SS.png",
        "coins/4_BigWin_SS.png", "coins/5_BigWin_SS.png", "coins/6_BigWin_SS.png", "coins/7_BigWin_SS.png",
        "coins/8_BigWin_SS.png", "coins/9_BigWin_SS.png", "coins/10_BigWin_SS.png", "coins/11_BigWin_SS.png",
        "coins/12_BigWin_SS.png", "coins/13_BigWin_SS.png", "coins/14_BigWin_SS.png", "coins/15_BigWin_SS.png",
        "coins/16_BigWin_SS.png", "coins/17_BigWin_SS.png", "coins/18_BigWin_SS.png", "coins/19_BigWin_SS.png",
        "coins/20_BigWin_SS.png", "coins/21_BigWin_SS.png", "coins/22_BigWin_SS.png", "coins/23_BigWin_SS.png",
        "coins/24_BigWin_SS.png", "coins/25_BigWin_SS.png", "coins/26_BigWin_SS.png", "coins/27_BigWin_SS.png",
        "coins/28_BigWin_SS.png", "coins/29_BigWin_SS.png", "coins/30_BigWin_SS.png"
    ];

    // Win level configurations
    const winLevels = {
        big: {
            text: 'BIG WIN',
            textClass: 'big-win',
            sunburstClass: 'big-win-color',
            threshold: 50,
            coinCount: 50
        },
        mega: {
            text: 'MEGA WIN',
            textClass: 'mega-win',
            sunburstClass: 'mega-win-color',
            threshold: 150,
            coinCount: 100
        },
        ultra: {
            text: 'ULTRA WIN',
            textClass: 'ultra-win',
            sunburstClass: 'ultra-win-color',
            threshold: Infinity,
            coinCount: 200
        }
    };

    // Resize canvas to fit container
    function resizeCanvas() {
        const container = document.querySelector('.game-canvas-container');
        canvas.width = container.clientWidth;
        canvas.height = container.clientHeight;
        
        // Redraw the game
        if (reels.length > 0) {
            drawGame();
        }
    }

    // Initialize loading screen
    function initLoading() {
        let progress = 0;

        function updateProgress() {
            progress += Math.random() * 10;

            if (progress > 100) progress = 100;

            loaderBar.style.width = progress + "%";

            // Interpolate green from 165 (orange) to 140 (darkorange)
            let green = 165 - (progress / 100) * (165 - 140);
            loaderBar.style.backgroundColor = `rgb(255, ${green}, 0)`;

            if (progress < 100) {
                setTimeout(updateProgress, 500);
            } else {
                setTimeout(() => {
                    jdbOverlay.style.display = "none";
                }, 500);
            }
        }

        updateProgress();
    }

    // Hide Kong overlay
    function hideKongOverlay() {
        kongOverlay.style.display = "none";
        // Try to play background music (will be blocked by browsers until user interaction)
        backgroundMusic.play().catch(e => console.log("Audio play failed:", e));
    }

    // Preload all symbol images
    function preloadImages() {
        SYMBOLS.forEach(symbol => {
            const img = new Image();
            img.crossOrigin = "anonymous"; // Avoid CORS issues
            img.onload = () => {
                imagesLoaded++;
                if (imagesLoaded === totalImages) {
                    // All images loaded, start the game
                    initGame();
                }
            };
            img.onerror = (err) => {
                console.error(`Error loading image for ${symbol.name}:`, err);
                // Create a fallback image with just the symbol color
            };
            
            img.src = symbol.image;
            symbolImages[symbol.name] = img;
        });
    }

    function preloadWildFrames() {
        for (let i = 0; i <= wildFrameCount; i++) {
            const img = new Image();
            img.crossOrigin = "anonymous";
            img.onload = () => {
                loadedWildFrames++;
            };
            img.src = `wildframes3/frame_${i}.png`;
            wildFrameImages.push(img);
        }
    }
    
    // Initialize the game
    function initGame() {
        // Resize canvas to fit container
        resizeCanvas();
        
        // In the initGame function, modify the part where initial reels are created
        for (let i = 0; i < REEL_COUNT; i++) {
            // Initialize each reel
            reels[i] = {
                position: 0,
                symbols: [],
                finalSymbols: [],
                isSpinning: false, // Track if this reel is currently spinning
                specialSymbols: {} // Track which symbols are special (larger with higher z-index)
            };
            
            // Generate initial symbols (visible + extra for scrolling)
            const totalSymbols = SYMBOLS_PER_REEL + EXTRA_SYMBOLS * 2;
            for (let j = 0; j < totalSymbols; j++) {
                // For first reel (i === 0), exclude Wild from possible symbols
                let availableSymbols = i === 0 
                    ? SYMBOLS.filter(s => s.name !== 'Wild')
                    : SYMBOLS;
                
                const randomIndex = Math.floor(Math.random() * availableSymbols.length);
                const random_symbol_name = availableSymbols[randomIndex].name;
                reels[i].symbols.push({
                    name: random_symbol_name,
                    isSpecial: true,
                    scale: SYMBOL_SCALE_MAP[random_symbol_name] // Random scale between 1.1 and 1.6
                });
            }
            
            // Set initial final symbols (what will be shown when not spinning)
            reels[i].finalSymbols = reels[i].symbols.slice(EXTRA_SYMBOLS, EXTRA_SYMBOLS + SYMBOLS_PER_REEL);
        }
        
        // Draw initial state
        drawGame();
        
        // Update balance display
        displayBalance(balance);


        setTimeout(() => {
            if (gameMode.mode === "live") {
                initialBalance = parseFloat(playerInfo.wallet_balance).toFixed(2);
                balance = parseFloat(playerInfo.wallet_balance).toFixed(2);
                displayBalance(balance)
            } else if (gameMode.mode === "demo") {
                balance = 1000;
                initialBalance = 1000;
                displayBalance(balance)
            } else {
                balance = undefined;
            }

            // You can use initialBalance here or call another function with it
            console.log("Balance:", balance);
        }, 5000);
        
        // Add event listeners
        spinButton.addEventListener('click', spin);
        autoPlayButton.addEventListener('click', toggleAutoPlay);
        settingsButton.addEventListener('click', displaySettingsOverlay);
        featuresButton.addEventListener('click', showFeaturesOverlay);
        infoButton.addEventListener('click', showInfoOverlay);
        closeInfoButton.addEventListener('click', hideInfoOverlay);
        // startFreeSpinsButton.addEventListener('click', startFreeSpins);
        quickspinToggleImg.addEventListener('click', toggleQuickSpin);
        
        // Add event listeners for overlays
        cancelStakeButton.addEventListener('click', hideStakeOverlay);
        cancelAutoSpinButton.addEventListener('click', hideAutoSpinOverlay);
        confirmAutoSpinButton.addEventListener('click', confirmAutoSpin);

        // Cancel settings
        function hideSettingsOverlay() {
            settingsOverlay.style.display = 'none';
            // Revert to previous settings (don't apply changes)
        };

        // Confirm settings
        function confirmSettings() {
            // Apply the temporary settings
            soundEffectsEnabled = tempSoundEffectsEnabled;
            backgroundMusicEnabled = tempBackgroundMusicEnabled;
            
            // Update background music based on new setting
            if (backgroundMusicEnabled) {
                backgroundMusic.play().catch(e => console.log("Audio play failed:", e));
            } else {
                backgroundMusic.pause();
            }
            
            settingsOverlay.style.display = 'none';
        };

        stakeOptions.addEventListener('click', (e) => {
            if (e.target.classList.contains('option-button')) {
                // Remove selected class from all options
                const options = stakeOptions.querySelectorAll('.option-button');
                options.forEach(option => option.classList.remove('selected'));
                
                // Add selected class to clicked option
                e.target.classList.add('selected');
                
                // Update selected stake value
                selectedStake = parseFloat(e.target.dataset.value);
            }
        });


        // Handle auto spin option selection
        autoSpinOptions.addEventListener('click', (e) => {
            if (e.target.classList.contains('option-button')) {
                // Remove selected class from all options
                const options = autoSpinOptions.querySelectorAll('.option-button');
                options.forEach(option => option.classList.remove('selected'));
                
                // Add selected class to clicked option
                e.target.classList.add('selected');
                
                // Update selected auto spins value
                selectedAutoSpins = parseInt(e.target.dataset.value);
        
                // Check if any loss limit option is currently selected
                const hasSelectedLossLimit = Array.from(
                    lossLimitOptions.querySelectorAll('.option-button')
                ).some(option => option.classList.contains('selected'));
                
                // If no loss limit is selected, automatically select the "Infinity" option
                if (!hasSelectedLossLimit) {
                    const infinityOption = lossLimitOptions.querySelector('.option-button[data-value="Infinity"]');
                    if (infinityOption) {
                        infinityOption.classList.add('selected');
                        selectedLossLimit = Infinity;
                    }
                }
            }
        });

// Handle loss limit option selection
const lossLimitOptions = document.getElementById('lossLimitOptions');
lossLimitOptions.addEventListener('click', (e) => {
    if (e.target.classList.contains('option-button')) {
        // Remove selected class from all options
        const options = lossLimitOptions.querySelectorAll('.option-button');
        options.forEach(option => option.classList.remove('selected'));
        
        // Add selected class to clicked option
        e.target.classList.add('selected');
        
        // Update selected loss limit value
        const value = e.target.dataset.value;
        selectedLossLimit = value === "Infinity" ? Infinity : parseInt(value);
    }
});



        // Add event listeners for settings
        backgroundMusicOption.addEventListener('click', toggleBackgroundMusic);
        
        // Add event listener for win overlay close button
        document.getElementById('closeBtn').addEventListener('click', closeWinAnimation);
        
        // Add window resize event listener
        window.addEventListener('resize', resizeCanvas);
        
        // Check if device is desktop
        if (window.innerWidth >= 900) {
            deviceOverlay.style.display = "none";
        }
    }

    confirmStakeButton.addEventListener('click', () => {
        stake = selectedStake;
        currentStakeElement.textContent = stake.toFixed(1);
        stakeOverlay.style.display = 'none';
    });

     
    // Function to close the win animation
    function closeWinAnimation() {
        const winOverlay = document.getElementById('winOverlay');
        winOverlay.style.display = 'none';
        
        // Stop big win sound and resume background music
        if (soundEffectsEnabled) {
            bigWinSound.pause();
            bigWinSound.currentTime = 0;
            
            if (backgroundMusicEnabled) {
                if (isFreeSpinMode) {
                    freeSpinSound.play().catch(e => console.log("Audio play failed:", e));
                } else {
                    backgroundMusic.play().catch(e => console.log("Audio play failed:", e));
                }
            }
        }
        
        // Clear all coins
        const coinsContainer = document.getElementById('coinsContainer');
        coinsContainer.innerHTML = '';
    }


    // Stake button and overlay
    stakeButton.addEventListener('click', () => {
        if (!spinning && !isFreeSpinMode) {
            stakeOverlay.style.display = 'block';
            
            // Highlight the currently selected stake
            const stakeOptionButtons = stakeOptions.querySelectorAll('.option-button');
            stakeOptionButtons.forEach(button => {
                const value = parseFloat(button.dataset.value);
                if (value === stake) {
                    button.classList.add('selected');
                } else {
                    button.classList.remove('selected');
                }
            });
        }
    });



    // Display balance
    function displayBalance(amount) {
        balanceText.innerHTML = parseFloat(amount).toFixed(2);
    }

    // Show features overlay
    function showFeaturesOverlay() {
        featuresOverlay.style.display = "block";
    }

    // Set demo feature
    function setDemoFeature(feature) {
        isFirstSpin = true; // Set first spin to trigger the passed feature
        currentDemoFeature.feature = feature;
        featuresOverlay.style.display = "none";
        spin();
    }

    // Show info overlay
    function showInfoOverlay() {
        hideSettingsOverlay();
        if (!spinning && !isFreeSpinMode) {
            infoOverlay.style.display = 'block';
        }
    }

    // Hide info overlay
    function hideInfoOverlay() {
        infoOverlay.style.display = 'none';
    }

    // Show stake overlay
    function showStakeOverlay() {
        if (!spinning && !isFreeSpinMode) {
            stakeOverlay.style.display = 'block';
            
            // Highlight the currently selected stake
            const stakeOptionButtons = stakeOptions.querySelectorAll('.option-button');
            stakeOptionButtons.forEach(button => {
                const value = parseFloat(button.dataset.value);
                if (value === stake) {
                    button.classList.add('selected');
                } else {
                    button.classList.remove('selected');
                }
            });
        }
    }

    // Hide stake overlay
    function hideStakeOverlay() {
        stakeOverlay.style.display = 'none';
    }

    // Confirm stake selection
    function confirmStake() {
        stake = selectedStake;
        currentStakeElement.textContent = stake.toFixed(1);
        stakeOverlay.style.display = 'none';
    }

    // Toggle auto play
    function toggleAutoPlay() {
        if (spinning && !isFreeSpinMode) {
            if (autoSpins > 0) {
                autoSpinsStopped = true;
                updateAutoSpinStatus();
                remainingAutoSpins.innerHTML = '';
                autoSpins = 0;
            }
        }
        else if (!spinning && !isFreeSpinMode) {
            if (autoSpins > 0) {
                // Cancel auto spins
                autoSpinsStopped = true;
                updateAutoSpinStatus();
                autoSpins = 0;
            } else {
                autoSpinOverlay.style.display = 'block';
                
                // Highlight the currently selected auto spins
                const autoSpinOptionButtons = autoSpinOptions.querySelectorAll('.option-button');
                autoSpinOptionButtons.forEach(button => {
                    const value = parseInt(button.dataset.value);
                    if (value === selectedAutoSpins) {
                        button.classList.add('selected');
                    } else {
                        button.classList.remove('selected');
                    }
                });
            }
        }
    }

    // Hide auto spin overlay
    function hideAutoSpinOverlay() {
        autoSpinOverlay.style.display = 'none';
    }

    // Confirm auto spin selection
    function confirmAutoSpin() {
        if (selectedAutoSpins > 0) {
            autoSpins = selectedAutoSpins;
            lossLimit = selectedLossLimit;
            initialBalance = balance; // Store initial balance to track losses
            autoSpinOverlay.style.display = 'none';
            autoSpinsStopped = false;
            updateAutoSpinStatus();
            spin();
        }
        else {
            updateAutoSpinStatus();
            autoSpinOverlay.style.display = 'none';
        }
    }

    // Update auto spin status
    function updateAutoSpinStatus() {
        if (autoSpinsStopped) {
            selectedAutoSpins = 0;
            const autoSpinOptionButtons = autoSpinOptions.querySelectorAll('.option-button');
            autoSpinOptionButtons.forEach(button => {
                if (button.classList.contains('selected')) {
                    button.classList.remove('selected');
                }
            });
            autoPlayButton.innerHTML = `<img src="autospininnerimg.png" class="autospininner-img" alt="">`;
        }
        else {
            autoPlayButton.innerHTML = `<img src="autospininnerimgstop.png" class="autospininnerimgstop"  alt="">`
        }
    }


    // Auto play button and overlay functionality
        autoPlayButton.addEventListener('click', () => {
            if (spinning && !isFreeSpinMode) {
                if (autoSpins > 0) {
                    autoSpinsStopped = true;
                    updateAutoSpinStatus();
                    remainingAutoSpins.innerHTML = '';
                    autoSpins = 0;
                }
            }
            else if (!spinning && !isFreeSpinMode) {
                if (autoSpins > 0) {
                    // Cancel auto spins
                    autoSpinsStopped = true;
                    updateAutoSpinStatus();
                    autoSpins = 0;
                } else {
                    autoSpinOverlay.style.display = 'block';
                    
                    // Highlight the currently selected auto spins
                    const autoSpinOptionButtons = autoSpinOptions.querySelectorAll('.option-button');
                    autoSpinOptionButtons.forEach(button => {
                        const value = parseInt(button.dataset.value);
                        if (value === selectedAutoSpins) {
                            button.classList.add('selected');
                        } else {
                            button.classList.remove('selected');
                        }
                    });
                }
            }
        });

        

    // Toggle quick spin
    function toggleQuickSpin() {
        isQuickSpinMode = !isQuickSpinMode;
        quickspinToggleImg.src = isQuickSpinMode ? 
            "quickspin-b.png" : 
            "quickspin-a.png";
    }

    // Display settings overlay

    function displaySettingsOverlay() {
        settingsOverlay.style.display = 'block';
    }

    // Hide settings overlay
    function hideSettingsOverlay() {
        settingsOverlay.style.display = 'none';
    }

    // Toggle background music
    function toggleBackgroundMusic() {
        backgroundMusicEnabled = !backgroundMusicEnabled;
        
        if (backgroundMusicEnabled) {
            backgroundMusicIcon.innerHTML = `<i class="fa fa-volume-up" style="color: #e4d594; font-size: 1.4rem;"></i>`;
            backgroundMusic.play();
        } else {
            backgroundMusicIcon.innerHTML = `<i class="fas fa-volume-mute" style="color: #e4d594; font-size: 1.4rem;"></i>`;
            backgroundMusic.pause();
        }
        
        settingsOverlay.style.display = 'none';
    }

    // Start free spins
    function startFreeSpins() {
        startFreeSpinsOverlay.style.display = "none";
        spin();
    }

    // Rotate spin button image
    function rotateSpinButtonImage() {
        spinButtonInnerImage.style.transition = 'transform 0.5s ease';
        spinButtonInnerImage.style.transform = 'rotate(180deg)';
    }

    // Reset spin button image
    function resetSpinButtonImage() {
        spinButtonInnerImage.style.transition = 'transform 0.5s ease';
        spinButtonInnerImage.style.transform = 'rotate(360deg)';
    }

    // Draw the game
    function drawGame() {
        // Clear canvas
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        
        // Draw the game in layers:
        // 1. Background
        drawBackground();
        
        // 2. All walls (drawn first, symbols will appear on top)
        drawWalls();
        
        // 3. Reel backgrounds
        drawReelBackgrounds();
        
        // 4. Draw spinning reels (these will appear to go under the bottom wall)
        drawSpinningReels();
        
        // 5. Draw stopped reels (these will appear on top of all walls)
        drawStoppedReels();
        
        // 6. Win display (if there's a win)
        if (winAmount > 0 && !spinning) {
            drawWinDisplay();
        }
    }

    // Draw background
    function drawBackground() {
        ctx.fillStyle = isFreeSpinMode ? '#1a237e' : '#222222';
        ctx.fillRect(0, 0, canvas.width, canvas.height);
    }

    // Define and load wall background images
const normalWallImages = [
    new Image(), // Top wall
    new Image(), // Right wall
    new Image(), // Bottom wall
    new Image()  // Left wall
];

const freeSpinWallImages = [
    new Image(), // Top wall
    new Image(), // Right wall
    new Image(), // Bottom wall
    new Image()  // Left wall
];

// Set image sources for normal walls
normalWallImages[0].src = 'wall-top.png';
normalWallImages[1].src = 'wall.png';
normalWallImages[2].src = 'resultsbcg3.png';
normalWallImages[3].src = 'wall.png';

// Set image sources for free spin walls (use different images)
freeSpinWallImages[0].src = 'freespin-wall-top.png'; // Replace with your free spin wall images
freeSpinWallImages[1].src = 'freespin-wall-right.png';
freeSpinWallImages[2].src = 'resultsbcg4.png';
freeSpinWallImages[3].src = 'freespin-wall-left.png';

// Preload all images before drawing walls
let normalWallImagesLoaded = 0;
let freeSpinWallImagesLoaded = 0;

normalWallImages.forEach((img) => {
    img.onload = () => {
        normalWallImagesLoaded++;
        if (normalWallImagesLoaded === normalWallImages.length) {
            drawWalls(); // Draw walls once all images are loaded
        }
    };
});

freeSpinWallImages.forEach((img) => {
    img.onload = () => {
        freeSpinWallImagesLoaded++;
    };
});

// Full drawWalls function using individual wall thicknesses
function drawWalls() {
    // Define positions and sizes for each wall
    const wallPositions = [
        { x: 0, y: 0, width: canvas.width, height: WALL_THICKNESS.top }, // Top - full width
        { x: canvas.width - WALL_THICKNESS.right, y: WALL_THICKNESS.top, width: WALL_THICKNESS.right, height: canvas.height - WALL_THICKNESS.top - WALL_THICKNESS.bottom }, // Right - between top and bottom
        { x: 0, y: canvas.height - WALL_THICKNESS.bottom, width: canvas.width, height: WALL_THICKNESS.bottom }, // Bottom - full width
        { x: 0, y: WALL_THICKNESS.top, width: WALL_THICKNESS.left, height: canvas.height - WALL_THICKNESS.top - WALL_THICKNESS.bottom }  // Left - between top and bottom
    ];

    // Select the appropriate wall images based on game mode
    const wallImages = isFreeSpinMode ? freeSpinWallImages : normalWallImages;
    const wallImagesLoaded = isFreeSpinMode ? freeSpinWallImagesLoaded : normalWallImagesLoaded;

    // Draw each wall using its corresponding color or image
    for (let i = 0; i < 4; i++) {
        const wall = wallPositions[i];
        ctx.fillStyle = WALL_BACKGROUNDS[i];
        ctx.fillRect(wall.x, wall.y, wall.width, wall.height);
        
        // If wall images are loaded, draw them instead
        if (wallImagesLoaded === wallImages.length) {
            const image = wallImages[i];
            // Draw the image stretched to fit the wall area
            ctx.drawImage(image, wall.x, wall.y, wall.width, wall.height);
        }
    }
}

// Draw reel backgrounds
function drawReelBackgrounds() {
    const reelWidth = (canvas.width - WALL_THICKNESS.left - WALL_THICKNESS.right) / REEL_COUNT;
    const reelHeight = canvas.height - WALL_THICKNESS.top - WALL_THICKNESS.bottom;
    const symbolHeight = reelHeight / SYMBOLS_PER_REEL;

    // Draw background for reels area
    ctx.fillStyle = isFreeSpinMode ? '#1a237e' : '#000000';
    ctx.fillRect(
        WALL_THICKNESS.left, 
        WALL_THICKNESS.top, 
        reelWidth * REEL_COUNT, 
        reelHeight
    );

    // Draw individual reel backgrounds and side borders
    for (let i = 0; i < REEL_COUNT; i++) {
        const reelX = WALL_THICKNESS.left + i * reelWidth;
        const reelY = WALL_THICKNESS.top;

        // Draw reel background
        ctx.fillStyle = isFreeSpinMode ? '#3e3424' : '#333333';
        ctx.fillRect(reelX, reelY, reelWidth, reelHeight);

        // Draw left and right borders only
        ctx.strokeStyle = isFreeSpinMode ? '#d97800' : '#666666';
        ctx.lineWidth = 4;
        ctx.beginPath();
        ctx.moveTo(reelX, reelY);                       // Left border start
        ctx.lineTo(reelX, reelY + reelHeight);          // Left border end
        ctx.moveTo(reelX + reelWidth, reelY);           // Right border start
        ctx.lineTo(reelX + reelWidth, reelY + reelHeight); // Right border end
        ctx.stroke();
    }

    // Optional: Draw dividing lines between symbols
    // for (let i = 1; i < SYMBOLS_PER_REEL; i++) {
    //     ctx.beginPath();
    //     ctx.moveTo(WALL_THICKNESS.left, WALL_THICKNESS.top + i * symbolHeight);
    //     ctx.lineTo(WALL_THICKNESS.left + reelWidth * REEL_COUNT, WALL_THICKNESS.top + i * symbolHeight);
    //     ctx.strokeStyle = 'rgba(255, 255, 255, 0.2)';
    //     ctx.lineWidth = 1;
    //     ctx.stroke();
    // }
}

// Draw spinning reels
function drawSpinningReels() {
    const reelWidth = (canvas.width - WALL_THICKNESS.left - WALL_THICKNESS.right) / REEL_COUNT;
    const reelHeight = canvas.height - WALL_THICKNESS.top - WALL_THICKNESS.bottom;
    const symbolHeight = reelHeight / SYMBOLS_PER_REEL;
    
    // Create clipping region for spinning reels
    ctx.save();
    ctx.beginPath();
    ctx.rect(
        WALL_THICKNESS.left, 
        WALL_THICKNESS.top, 
        reelWidth * REEL_COUNT, 
        reelHeight
    );
    ctx.clip();
    
    // Draw spinning reels
    for (let i = 0; i < REEL_COUNT; i++) {
        // Only draw if this reel is still spinning
        if (!reels[i].isSpinning) continue;
        
        const reelX = WALL_THICKNESS.left + i * reelWidth;
        const reelY = WALL_THICKNESS.top;
        
        // Draw symbols
        for (let j = 0; j < reels[i].symbols.length; j++) {
            const symbol = reels[i].symbols[j];
            const symbolData = SYMBOLS.find(s => s.name === symbol.name);
            
            // Calculate position with scrolling offset
            const symbolX = reelX;
            const symbolY = reelY - symbolHeight * EXTRA_SYMBOLS + j * symbolHeight + reels[i].position;
            
            // Only draw if near the visible area
            if (symbolY > reelY - symbolHeight && symbolY < reelY + reelHeight + symbolHeight) {
                // Draw symbol
                drawSymbol(symbolX, symbolY, reelWidth, symbolHeight, symbolData, symbol.isSpecial, symbol.scale);
            }
        }
    }
    
    ctx.restore();
}
    // Draw stopped reels
function drawStoppedReels() {
    const reelWidth = (canvas.width - WALL_THICKNESS.left - WALL_THICKNESS.right) / REEL_COUNT;
    const reelHeight = canvas.height - WALL_THICKNESS.top - WALL_THICKNESS.bottom;
    const symbolHeight = reelHeight / SYMBOLS_PER_REEL;
    
    // Draw stopped reels
    for (let i = 0; i < REEL_COUNT; i++) {
        // Only draw if this reel has stopped spinning
        if (reels[i].isSpinning) continue;
        
        const reelX = WALL_THICKNESS.left + i * reelWidth;
        const reelY = WALL_THICKNESS.top;
        
        // Draw symbols
        for (let j = 0; j < reels[i].finalSymbols.length; j++) {
            const symbol = reels[i].finalSymbols[j];
            const symbolData = SYMBOLS.find(s => s.name === symbol.name);
            
            // Calculate position
            const symbolX = reelX;
            const symbolY = reelY + j * symbolHeight;
            
            // Draw symbol
            drawSymbol(symbolX, symbolY, reelWidth, symbolHeight, symbolData, symbol.isSpecial, symbol.scale);
        }
    }
}

    // Draw a symbol
    function drawSymbol(x, y, width, height, symbol, isSpecial, scale = 1.2) {
        // Calculate center position
        const centerX = x + width / 2;
        const centerY = y + height / 2;

        // Save context for transformations
        ctx.save();
        
        // Check if symbol is defined, if not use a fallback
        if (!symbol) {
            console.warn('Undefined symbol encountered in drawSymbol');
            // Draw a fallback rectangle
            ctx.fillStyle = '#666666';
            ctx.fillRect(x, y, width, height);
            ctx.restore();
            return;
        }
        
        // Apply scaling transformation for special symbols
        if (2 > 1) {
            // Scale from center
            ctx.translate(centerX, centerY);
            // Use a fallback scale if normal_scale is not defined
            const normalScale = symbol.normal_scale || scale || 1.2;
            ctx.scale(normalScale, normalScale);
            ctx.translate(-centerX, -centerY);
        }
        
        // Draw the symbol image
        // Draw the symbol image
        const img = symbolImages[symbol.name];
        if (img) {
            // Calculate image dimensions to fit within the symbol area
            const imgPadding = width * 0.05;
            const imgWidth = width - imgPadding * 2;
            const imgHeight = imgWidth * 1.1; // Make height 1.3 times the width
            
            // Draw the image
            ctx.drawImage(
                img, 
                x + (width - imgWidth) / 2, 
                y + (height - imgHeight) / 2, 
                imgWidth, 
                imgHeight
            );
        } else {
            // Fallback if image is not found
            ctx.fillStyle = symbol.color || '#999999';
            ctx.fillRect(
                x + width * 0.1, 
                y + height * 0.1, 
                width * 0.8, 
                height * 0.8
            );
            
            // Draw symbol name as text
            ctx.fillStyle = '#ffffff';
            ctx.font = '14px Arial';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillText(symbol.name || 'Unknown', centerX, centerY);
        }
        
        // Restore context
        ctx.restore();
    }

// Update the highlightWinningSymbols function to handle the new winning positions format
function highlightWinningSymbols(reelSymbols, winningPositions) {
    // If no winning positions are passed, initialize it as an empty array
    winningPositions = winningPositions || [];
    
    console.log('------------Highlighting winning symbols----------------');
    console.log(winningPositions);
    
    // Track animation frames for scatter symbols
    const scatterFrames = {};
    const spriteScales = {};
    
    // Preload scatter animation frames
    const scatterFrameCount = 61;
    const scatterFrameImages = [];
    let loadedScatterFrames = 0;
    
    for (let i = 0; i <= scatterFrameCount; i++) {
        const img = new Image();
        img.crossOrigin = "anonymous";
        img.onload = () => {
            loadedScatterFrames++;
        };
        img.src = `freespinframes/item_${i}.png`;
        scatterFrameImages.push(img);
    }
    
    // Clear previous animations when starting new ones
    activeAnimations = {};
    
    // Loop through winning positions and set up animations
    // The server response format has different structure
    winningPositions.forEach(pos => {
        // Create a unique key for this position
        const key = `${pos.reel}-${pos.row}`;
        
        activeAnimations[key] = {
            symbol: pos.symbol,
            reel: pos.reel,
            row: pos.row,
            startTime: Date.now(),
            active: true,
            // For scatter animations
            currentFrame: 0,
            direction: 1,
            lastUpdateTime: 0,
            frameRate: 25
        };
        
        // Initialize scale tracking for this symbol
        const spriteId = key;
        spriteScales[spriteId] = {
            originalScale: 1.0,
            currentScaleFactor: 1.0
        };
    });
    
    // Create animation frame function
    function animateWinningSymbols() {
        // Check if we have any active animations
        const hasActiveAnimations = Object.values(activeAnimations).some(anim => anim.active);
        
        if (!hasActiveAnimations) {
            return; // Stop animation loop if no active animations
        }
        
        // Redraw the game
        drawGame();
        
        // Request next frame
        requestAnimationFrame(animateWinningSymbols);
    }
    
    // Start animation loop
    if (Object.keys(activeAnimations).length > 0) {
        animateWinningSymbols();
    }
    
    // Override drawStoppedReels to include animations
    const originalDrawStoppedReels = drawStoppedReels;
    drawStoppedReels = function() {
        const reelWidth = (canvas.width - WALL_THICKNESS.left - WALL_THICKNESS.right) / REEL_COUNT;
        const reelHeight = canvas.height - WALL_THICKNESS.top - WALL_THICKNESS.bottom;
        const symbolHeight = reelHeight / SYMBOLS_PER_REEL;
        
        // Draw stopped reels
        for (let i = 0; i < REEL_COUNT; i++) {
            // Only draw if this reel has stopped spinning
            if (reels[i].isSpinning) continue;
            
            const reelX = WALL_THICKNESS.left + i * reelWidth;
            const reelY = WALL_THICKNESS.top;
            
            // Draw symbols
            for (let j = 0; j < reels[i].finalSymbols.length; j++) {
                const symbol = reels[i].finalSymbols[j];
                const symbolData = SYMBOLS.find(s => s.name === symbol.name);
                
                // Calculate position
                const symbolX = reelX;
                const symbolY = reelY + j * symbolHeight;
                
                // Check if this symbol is being animated
                const animKey = `${i}-${j}`;
                const anim = activeAnimations[animKey];
                
                if (anim && anim.active) {
                    // Apply different animations based on symbol type
                    ctx.save();
                    
                    switch (anim.symbol) {
                        case "Scatter":
                            // Frame animation for scatter symbols
                            const now = Date.now();
                            if (now - anim.lastUpdateTime >= anim.frameRate) {
                                anim.lastUpdateTime = now;
                                
                                // Update frame
                                anim.currentFrame += anim.direction;
                                
                                // Reverse direction at the ends
                                if (anim.currentFrame >= scatterFrameCount) {
                                    anim.currentFrame = scatterFrameCount - 2;
                                    anim.direction = -1;
                                } else if (anim.currentFrame < 0) {
                                    anim.currentFrame = 1;
                                    anim.direction = 1;
                                }
                            }
                            
                            // Calculate scale based on current frame position
                            const frameProgress = anim.currentFrame / scatterFrameCount;
                            const maxScaleFactor = 1.4;
                            const scaleFactor = 1.15 + (maxScaleFactor - 1.0) * frameProgress;
                            
                            // Draw the current frame if it's loaded
                            if (loadedScatterFrames > anim.currentFrame) {
                                const frameImg = scatterFrameImages[anim.currentFrame];
                                
                                // Calculate center position for scaling
                                const centerX = symbolX + reelWidth / 2;
                                const centerY = symbolY + symbolHeight / 2;
                                
                                // Apply scaling from center
                                ctx.translate(centerX, centerY);
                                ctx.scale(scaleFactor, scaleFactor);
                                ctx.translate(-centerX, -centerY);
                                
                                // Draw the frame
                                const imgPadding = reelWidth * 0.05;
                                const imgSize = Math.min(reelWidth, symbolHeight) - imgPadding * 2;
                                ctx.drawImage(
                                    frameImg,
                                    symbolX + (reelWidth - imgSize) / 2,
                                    symbolY + (symbolHeight - imgSize) / 2,
                                    imgSize,
                                    imgSize * 1.1
                                );
                            } else {
                                // Fallback to normal symbol if frames aren't loaded
                                drawSymbol(symbolX, symbolY, reelWidth, symbolHeight, symbolData, true, 1.3);
                            }
                            break;
                            
                        // Other symbol animations remain the same...
                        case "Treasure Chest":
                            // Blinking effect
                            if (Math.floor(Date.now() / 600) % 2 === 0) {
                                drawSymbol(symbolX, symbolY, reelWidth, symbolHeight, symbolData, true, 1.3);
                            }
                            break;
                            
                        case "Wild":
                            // Frame animation for Wild symbols
                            const wildNow = Date.now();
                            if (wildNow - anim.lastUpdateTime >= 100) { // 100ms frame rate
                                anim.lastUpdateTime = wildNow;
                                
                                // Update frame
                                anim.currentFrame += anim.direction;
                                
                                // Reverse direction at the ends
                                if (anim.currentFrame >= wildFrameCount) {
                                    anim.currentFrame = wildFrameCount - 2;
                                    anim.direction = -1;
                                } else if (anim.currentFrame < 0) {
                                    anim.currentFrame = 1;
                                    anim.direction = 1;
                                }
                            }
                            
                            // Calculate scale based on current frame position
                            const wildFrameProgress = anim.currentFrame / wildFrameCount;
                            const wildMaxScaleFactor = 1.75;
                            const wildScaleFactor = 1.5 + (wildMaxScaleFactor - 1.0) * wildFrameProgress;
                            
                            // Draw the current frame if it's loaded
                            if (loadedWildFrames > anim.currentFrame) {
                                const frameImg = wildFrameImages[anim.currentFrame];
                                
                                // Calculate center position for scaling
                                const centerX = symbolX + reelWidth / 2;
                                const centerY = symbolY + symbolHeight / 2;
                                
                                // Apply scaling from center
                                ctx.translate(centerX, centerY);
                                ctx.scale(wildScaleFactor, wildScaleFactor);
                                ctx.translate(-centerX, -centerY);
                                
                                // Draw the frame
                                const imgPadding = reelWidth * 0.05;
                                const imgSize = Math.min(reelWidth, symbolHeight) - imgPadding * 2;
                                ctx.drawImage(
                                    frameImg,
                                    symbolX + (reelWidth - imgSize) / 2,
                                    symbolY + (symbolHeight - imgSize) / 2,
                                    imgSize,
                                    imgSize
                                );
                            } else {
                                // Fallback to normal symbol if frames aren't loaded
                                drawSymbol(symbolX, symbolY, reelWidth, symbolHeight, symbolData, true, 1.3);
                            }
                            break;
                            
                        case "Explorer":
                        case "Compass":
                        case "Binoculars":
                            //blinking effect
                            if (Math.floor(Date.now() / 600) % 2 === 0) {
                                drawSymbol(symbolX, symbolY, reelWidth, symbolHeight, symbolData, true, 1.15);
                            }
                            break;
                            
                        case "A":
                        case "K":
                        case "Q":
                        case "J":
                            // Blinking effect
                            if (Math.floor(Date.now() / 600) % 2 === 0) {
                                drawSymbol(symbolX, symbolY, reelWidth, symbolHeight, symbolData, true, 1.15);
                            }
                            break;
                            
                        default:
                            // Default animation - pulsing
                            const defaultScale = 1.1 + 0.1 * Math.sin(Date.now() / 200);
                            drawSymbol(symbolX, symbolY, reelWidth, symbolHeight, symbolData, true, defaultScale);
                    }
                    
                    ctx.restore();
                } else {
                    // Draw normal symbol
                    drawSymbol(symbolX, symbolY, reelWidth, symbolHeight, symbolData, symbol.isSpecial, symbol.scale);
                }
            }
        }
    };
}


function generateMockResults() {
    const newResults = [];
    
    // Check if we should trigger free spins (10% chance if not already in free spin mode)
    const triggerFreeSpins = !isFreeSpinMode && (currentDemoFeature.feature === "free spins" || Math.random() < 0.1);
    
    // Check if we should generate a big win
    const generateBigWin = currentDemoFeature.feature === "big win" || Math.random() < 0.2;
    
    // If triggering free spins, ensure at least one scatter on each reel
    if (triggerFreeSpins) {
        for (let i = 0; i < REEL_COUNT; i++) {
            const reelSymbols = [];
            
            // Add one scatter symbol
            const scatterPosition = Math.floor(Math.random() * SYMBOLS_PER_REEL);
            
            for (let j = 0; j < SYMBOLS_PER_REEL; j++) {
                if (j === scatterPosition) {
                    reelSymbols.push({
                        name: 'Scatter',
                        isSpecial: true,
                        scale: 1.3
                    });
                } else {
                    // For first reel (i === 0), exclude Wild from possible symbols
                    let availableSymbols = i === 0 
                        ? SYMBOLS.filter(s => s.name !== 'Wild' && s.name !== 'Scatter')
                        : SYMBOLS.filter(s => s.name !== 'Scatter');
                    
                    const randomIndex = Math.floor(Math.random() * availableSymbols.length);
                    reelSymbols.push({
                        name: availableSymbols[randomIndex].name,
                        isSpecial: Math.random() < 0.3,
                        scale: Math.random() * 0.5 + 1.1
                    });
                }
            }
            newResults.push(reelSymbols);
        }
    } 
    // If generating a big win, create a line of high-value symbols
    else if (generateBigWin) {
        // Choose a high-value symbol
        const highValueSymbols = ['Treasure Chest', 'Explorer', 'Compass', 'Binoculars'];
        const selectedSymbol = highValueSymbols[Math.floor(Math.random() * highValueSymbols.length)];
        
        // Create a line of matching symbols
        for (let i = 0; i < REEL_COUNT; i++) {
            const reelSymbols = [];
            
            for (let j = 0; j < SYMBOLS_PER_REEL; j++) {
                if (j === 1) { // Middle row for the winning line
                    if (i === 0) {
                        // First reel must have the selected symbol, not Wild
                        reelSymbols.push({
                            name: selectedSymbol,
                            isSpecial: true,
                            scale: 1.2
                        });
                    } else {
                        // Other reels can have Wild or the selected symbol
                        reelSymbols.push({
                            name: Math.random() < 0.7 ? selectedSymbol : 'Wild',
                            isSpecial: true,
                            scale: 1.2
                        });
                    }
                } else {
                    // For first reel (i === 0), exclude Wild from possible symbols
                    let availableSymbols = i === 0 
                        ? SYMBOLS.filter(s => s.name !== 'Wild')
                        : SYMBOLS;
                    
                    const randomIndex = Math.floor(Math.random() * availableSymbols.length);
                    reelSymbols.push({
                        name: availableSymbols[randomIndex].name,
                        isSpecial: Math.random() < 0.3,
                        scale: Math.random() * 0.5 + 1.1
                    });
                }
            }
            newResults.push(reelSymbols);
        }
    }
    // Normal results
    else {
        for (let i = 0; i < REEL_COUNT; i++) {
            const reelSymbols = [];
            for (let j = 0; j < SYMBOLS_PER_REEL; j++) {
                // For first reel (i === 0), exclude Wild from possible symbols
                let availableSymbols = i === 0 
                    ? SYMBOLS.filter(s => s.name !== 'Wild')
                    : SYMBOLS;
                
                const randomIndex = Math.floor(Math.random() * availableSymbols.length);
                reelSymbols.push({
                    name: availableSymbols[randomIndex].name,
                    isSpecial: Math.random() < 0.3,
                    scale: Math.random() * 0.5 + 1.1
                });
            }
            newResults.push(reelSymbols);
        }
    }
    
    return {
        reels: newResults,
        triggerFreeSpins: triggerFreeSpins,
        generateBigWin: generateBigWin
    };
}

    // Add a new function to send requests to the server for spin results
// Add this after the calculateWinAmount function
// Update the fetchSpinResultsFromServer function to use the transformServerResponse function

function fetchSpinResultsFromServer(payload) {
    console.log(payload)
    // Create the request payload
    const API_BASE_URL = "https://b.api.ibibe.africa";
    
    // Return a promise that resolves with the spin results
    return fetch(`${API_BASE_URL}/spin/kong`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(payload)
    })
    .then(response => {
        if (!response.ok) {
            throw new Error('Network response was not ok');
        }
        return response.json();
    })
    .then(data => {
        console.log("Server response:", data);
        
        // Use the transformServerResponse function to format the data
        const transformedData = transformServerResponse(data);
        
        if (!transformedData) {
            throw new Error('Failed to transform server response');
        }
        
        return transformedData;
    })
    .catch(error => {
        console.error('Error fetching spin results:', error);
        // Fallback to local generation in case of error
        const mockResults = generateMockResults();
        const winResult = calculateWinAmount(mockResults, isFreeSpinMode, bonusMultiplier);
        return {
            reels: mockResults.reels,
            win: winResult.amount,
            winningPositions: winResult.positions,
            triggerFreeSpins: mockResults.triggerFreeSpins
        };
    });
}

// Add a function to show a loading indicator if the server response takes too long
function showLoadingIndicator() {
    const loadingIndicator = document.createElement('div');
    loadingIndicator.id = 'server-loading-indicator';
    loadingIndicator.style.position = 'absolute';
    loadingIndicator.style.top = '50%';
    loadingIndicator.style.left = '50%';
    loadingIndicator.style.transform = 'translate(-50%, -50%)';
    loadingIndicator.style.backgroundColor = 'rgba(0, 0, 0, 0.7)';
    loadingIndicator.style.color = 'white';
    loadingIndicator.style.padding = '10px 20px';
    loadingIndicator.style.borderRadius = '5px';
    loadingIndicator.style.zIndex = '1000';
    loadingIndicator.style.display = 'none';
    loadingIndicator.innerHTML = 'Waiting for server...';
    
    document.querySelector('.game-canvas-container').appendChild(loadingIndicator);
    
    // Show the indicator after a delay if the server hasn't responded
    setTimeout(() => {
        const indicator = document.getElementById('server-loading-indicator');
        if (indicator) {
            indicator.style.display = 'block';
        }
    }, 3000); // Show after 3 seconds
}

function hideLoadingIndicator() {
    const indicator = document.getElementById('server-loading-indicator');
    if (indicator) {
        indicator.remove();
    }
}


function calculateWinAmount(results, isFreeSpinMode, bonusMultiplier) {
    // Extract symbol names from results for easier processing
    const symbolNames = results.reels.map(reel => 
        reel.map(symbol => symbol.name)
    );
    
    // Check for winning combinations
    let totalWin = 0;
    let winningPositions = [];
    
    // Check for matching symbols on each row
    for (let row = 0; row < SYMBOLS_PER_REEL; row++) {
        // Check each symbol (except Scatter which pays anywhere)
        for (let symbolObj of SYMBOLS) {
            if (symbolObj.name === 'Scatter') continue;
            
            let count = 0;
            let positions = [];
            
            // Count consecutive matching symbols from left to right
            for (let reel = 0; reel < REEL_COUNT; reel++) {
                const currentSymbol = symbolNames[reel][row];
                
                // Match if same symbol or Wild (except first reel)
                if (currentSymbol === symbolObj.name || (currentSymbol === 'Wild' && reel > 0)) {
                    count++;
                    positions.push({ reel, row, symbol: currentSymbol });
                } else {
                    break;
                }
            }
            
            // Check if we have a win (3 or more matching symbols)
            if (count >= 3) {
                // Get payout for this symbol and count
                const payout = symbolObj.payouts[count];
                
                // Calculate win amount
                let win = payout * stake;
                
                // Apply bonus multiplier in free spin mode
                if (isFreeSpinMode && bonusMultiplier > 0) {
                    win *= bonusMultiplier;
                }
                
                totalWin += win;
                winningPositions = winningPositions.concat(positions);
            }
        }
    }
    
    // Check for Scatter wins - only if in free spin mode
    if (isFreeSpinMode) {
        let scatterCount = 0;
        let scatterPositions = [];
        
        for (let reel = 0; reel < REEL_COUNT; reel++) {
            for (let row = 0; row < SYMBOLS_PER_REEL; row++) {
                if (symbolNames[reel][row] === 'Scatter') {
                    scatterCount++;
                    scatterPositions.push({ reel, row, symbol: 'Scatter' });
                }
            }
        }
        
        // Scatter pays anywhere if in free spin mode
        if (scatterCount >= 3) {
            const scatterObj = SYMBOLS.find(s => s.name === 'Scatter');
            const payout = scatterObj.payouts[scatterCount] || 0;
            
            let win = payout * stake;
            
            // Apply bonus multiplier
            if (bonusMultiplier > 0) {
                win *= bonusMultiplier;
            }
            
            totalWin += win;
            winningPositions = winningPositions.concat(scatterPositions);
        }
    } else {
        // If not in free spin mode, still count scatters for triggering free spins
        // but don't add them to winning positions for animation
        let scatterCount = 0;
        
        for (let reel = 0; reel < REEL_COUNT; reel++) {
            for (let row = 0; row < SYMBOLS_PER_REEL; row++) {
                if (symbolNames[reel][row] === 'Scatter') {
                    scatterCount++;
                }
            }
        }
        
        // Check if we should trigger free spins (at least one scatter on each reel)
        if (scatterCount >= REEL_COUNT) {
            results.triggerFreeSpins = true;
            
            // Add scatter positions for animation when triggering free spins
            let scatterPositions = [];
            for (let reel = 0; reel < REEL_COUNT; reel++) {
                for (let row = 0; row < SYMBOLS_PER_REEL; row++) {
                    if (symbolNames[reel][row] === 'Scatter') {
                        scatterPositions.push({ reel, row, symbol: 'Scatter' });
                    }
                }
            }
            
            // Add scatter positions to winning positions for animation
            winningPositions = winningPositions.concat(scatterPositions);
        }
    }
    
    // If it's a big win demo, ensure a big win
    if (results.generateBigWin && totalWin < 100) {
        totalWin = 100 + Math.floor(Math.random() * 400);
    }
    
    // If we have winning positions, highlight them
    if (winningPositions.length > 0) {
        highlightWinningSymbols(results.reels, winningPositions);
    }
    
    return {
        amount: totalWin,
        positions: winningPositions
    };
}

// Modify the spin function to handle live mode
// Replace the entire spin function with this updated version
async function spin() {
    if (spinning || (balance < stake && !isFreeSpinMode)) return;

    // Check if loss limit has been reached
    if (autoSpins > 0 && !isFreeSpinMode) {
        const currentLoss = initialBalance - balance;
        const maxAllowedLoss = lossLimit === Infinity ? Infinity : stake * lossLimit;
        
        if (currentLoss >= maxAllowedLoss && maxAllowedLoss !== Infinity) {
            autoSpinsStopped = true;
            updateAutoSpinStatus();
            remainingAutoSpins.innerHTML = '';
            autoSpins = 0;
            alert(`Auto-spins stopped: Loss limit of ${maxAllowedLoss.toFixed(2)} reached.`);
            return;
        }
    } 
    
    if (stake <= 0 || (stake > balance && !isFreeSpinMode)) {
        alert("Invalid stake amount!");
        return;
    }

    // Stop any active animations by clearing the activeAnimations object
    activeAnimations = {};
    
    // Restore original drawStoppedReels function if it was overridden
    if (typeof originalDrawStoppedReels === 'function') {
        drawStoppedReels = originalDrawStoppedReels;
    }

    // Rotate the spin button image before spinning
    rotateSpinButtonImage();

    // Deduct bet amount if not in free spin mode


    if (!isFreeSpinMode) {
        async function placeAndHandleBet(stake) {
            try {
                const place_bet_response = await placeBet(stake);
                console.log(place_bet_response);
                balance -= stake;
                displayBalance(balance);
            } catch (error) {
                console.error("Error placing bet:", error);
            }
        }

        await placeAndHandleBet(stake)

    }

    // Play spin sound if enabled
    if (soundEffectsEnabled) {
        spinSound.play().catch(e => console.log("Audio play failed:", e));
    }
    
    spinning = true;
    featuresButton.disabled = true;

    // Hide win message
    winMessageElement.style.display = 'none';
    document.getElementById('update_winnings').innerHTML = '0.00';

    // Prepare reels for spinning
    for (let i = 0; i < REEL_COUNT; i++) {
        // Reset position
        reels[i].position = 0;
        
        // Set spinning state
        reels[i].isSpinning = true;
        
        // Generate new symbols for spinning
        const totalSymbols = SYMBOLS_PER_REEL + EXTRA_SYMBOLS * 2;
        reels[i].symbols = [];
        
        // Add random symbols for the spinning effect
        for (let j = 0; j < totalSymbols; j++) {
            const randomIndex = Math.floor(Math.random() * SYMBOLS.length);
            reels[i].symbols.push({
                name: SYMBOLS[randomIndex].name,
                isSpecial: Math.random() < 0.3,
                scale: Math.random() * 0.5 + 1.1
            });
        }
    }

    // Get spin results based on game mode
    let apiResult;

    
    
    if (gameMode.mode === 'live') {
        // In live mode, fetch results from server
        showLoadingIndicator(); // Show loading indicator if server takes too long

        const payload = {
            client_id: gameInfo.client_id,
            game_id: gameInfo.game_id,
            player_id: playerInfo.id,
            bet_id: lastPlacedBetData.bet_id,
            bet_amount: isFreeSpinMode ? 0 : stake,
            is_free_spin: isFreeSpinMode,
            free_spin_count: freeSpinCount,
            bonus_multiplier: bonusMultiplier,
            original_bet_amount: isFreeSpinMode ? originalBetAmount : 0
        };
        
        try {
            // Start spinning animation while waiting for server response
            const spinPromise = new Promise(resolve => {
                spinAnimation(() => {
                    // This callback won't be called until we have results
                    resolve();
                }, null); // Pass null to indicate we're waiting for results
            });
            
            // Fetch results from server
            apiResult = await fetchSpinResultsFromServer(payload);
            hideLoadingIndicator();
            
            // Update the spinning animation with the actual results
            updateSpinningReelsWithResults(apiResult);
            
            // Wait for spinning animation to complete
            await spinPromise;
        } catch (error) {
            console.error('Error in live mode spin:', error);
            hideLoadingIndicator();
            
            // Fallback to local generation
            const mockResults = generateMockResults();
            const winResult = calculateWinAmount(mockResults, isFreeSpinMode, bonusMultiplier);
            apiResult = {
                reels: mockResults.reels,
                win: winResult.amount,
                winningPositions: winResult.positions,
                triggerFreeSpins: mockResults.triggerFreeSpins
            };
        }
    } else {
        // In demo mode, generate results locally
        const mockResults = generateMockResults();
        const winResult = calculateWinAmount(mockResults, isFreeSpinMode, bonusMultiplier);
        apiResult = {
            reels: mockResults.reels,
            win: winResult.amount,
            winningPositions: winResult.positions,
            triggerFreeSpins: mockResults.triggerFreeSpins
        };
        
        // Start spin animation with local results
        spinAnimation(() => {
            handleSpinCompletion(apiResult);
        }, apiResult);
    }
}

// Add a function to update spinning reels with server results
function updateSpinningReelsWithResults(results) {
    // Make sure we have valid results
    if (!results || !results.reels) {
        console.error("Invalid results in updateSpinningReelsWithResults:", results);
        return;
    }
    
    // Process each reel
    for (let i = 0; i < Math.min(REEL_COUNT, results.reels.length); i++) {
        // Make sure the reel exists
        if (!reels[i]) {
            console.warn(`Reel ${i} does not exist`);
            continue;
        }
        
        // Update the final symbols for this reel
        reels[i].finalSymbols = results.reels[i];
    }
    
    // Signal to the spinning animation that we have results
    if (currentInterval) {
        clearInterval(currentInterval);
        
        // Start a new spin animation with the actual results
        spinAnimation(() => {
            handleSpinCompletion(results);
        }, results);
    }
}


function updateWinnings(targetAmount) {
    let element = document.getElementById('update_winnings');
    let currentAmount = parseFloat(element.innerHTML) || 0;
    let increment = (targetAmount - currentAmount) / 50; // Adjust speed

    let counter = setInterval(() => {
        currentAmount += increment;
        element.innerHTML = `${currentAmount.toFixed(2)}`;

        if ((increment > 0 && currentAmount >= targetAmount) || (increment < 0 && currentAmount <= targetAmount)) {
            element.innerHTML = `${targetAmount.toFixed(2)}`;
            clearInterval(counter);
        }
    }, 20); // Update every 20ms
}


// Function to show the win animation
      function showWinAnimation(amount) {
        // do not show big win animation during free spins
        if (autoSpins > 0 || isFreeSpinMode){
            return
        }
        // Reset any existing animations
        clearTimeout(window.autoCloseTimeout);
        
        // Set initial win level
        let currentLevel = 'big';
        document.getElementById('winImg').src = "winlevels/bigwin.png";
        updateWinLevel(currentLevel);
        
        // Show the overlay
        const winOverlay = document.getElementById('winOverlay');
        winOverlay.style.display = 'flex';

        bigWinSound.play()
        
        // Start with $0
        let currentAmount = 0;
        const winAmount = document.getElementById('winAmount');
        winAmount.textContent = '$' + currentAmount.toLocaleString();
        
        // Create the coin fountain
        setTimeout(() => {
          createCoinFountain(winLevels[currentLevel].coinCount);
        }, 200);
        
        // Animate the counter
        const duration = 7000; // 7 seconds for the counter
        const fps = 60;
        const increment = amount / (duration / 1000 * fps);
        const startTime = performance.now();
        
        function updateCounter(timestamp) {
          const elapsed = timestamp - startTime;
          const progress = Math.min(elapsed / duration, 1);
          
          currentAmount = progress * amount;
          winAmount.textContent = '$' + Math.floor(currentAmount).toLocaleString();
          
          // Check if we need to upgrade the win level
          const newLevel = getWinLevel(currentAmount);
          if (newLevel !== currentLevel) {
            currentLevel = newLevel;
            updateWinLevel(currentLevel);
            
            // Add more coins for the new level
            createCoinFountain(winLevels[currentLevel].coinCount);
          }
          
          if (progress < 1) {
            requestAnimationFrame(updateCounter);
          } else {
            // Counter finished
            winAmount.textContent = '$' + amount.toLocaleString();
            
            // Auto close after 3 seconds
            window.autoCloseTimeout = setTimeout(() => {
              closeWinAnimation();
            }, 7000);
          }
        }
        
        requestAnimationFrame(updateCounter);
      }
      
      


// Extract the spin completion handling to a separate function
function handleSpinCompletion(apiResult) {
    // Reset the spin button image after animation completes
    resetSpinButtonImage();

    // Update win amount
    if (apiResult.win > 0) {
        updateWinnings(apiResult.win);
        
        // Update balance with winnings
        balance += apiResult.win;
        displayBalance(balance);

        // Play win sound
        if (soundEffectsEnabled) {
            winSound.play().catch(e => console.log("Audio play failed:", e));
        }
        
        // Show big win animation for large wins
        if (apiResult.win >= 100 && !isFreeSpinMode && autoSpins === 0) {
            setTimeout(() => {
                showWinAnimation(apiResult.win);
            }, 1000);
        }
    } else {
        document.getElementById('update_winnings').innerHTML = '0.00';
    }

    // Handle free spins
    if (apiResult.triggerFreeSpins && !isFreeSpinMode) {
        freeSpinTriggeredRecently = true;

        startfreespinsoverlay.style.display = 'block'
        
        // Change background image to volcano
        document.getElementById('img_top').src = 'volcano.gif'
        
        // Show free spins overlay
            function delayMs(milliseconds) {
                return new Promise(resolve => setTimeout(resolve, milliseconds));
            }

            async function showImageTemporarily() {
                freeSpinsOverlay.style.display = 'block';  
                backgroundMusic.pause()
                freeSpinSound.play()   // Show image
                await delayMs(4000);               // Wait 4 seconds
                freeSpinsOverlay.style.display = 'none';      // Hide image
            }

            // Run the async function
            showImageTemporarily();


            async function fetchGifAsBuffer(url) {
                const response = await fetch(url);
                const buffer = await response.arrayBuffer();
                return new Uint8Array(buffer); // omggif needs Uint8Array
            }

            function getGifDuration(buffer) {
                const reader = new GifReader(buffer);
                const frameCount = reader.numFrames();
                let duration = 0;

                for (let i = 0; i < frameCount; i++) {
                const info = {};
                reader.frameInfo(i, info);
                // Delay is in hundredths of a second (1/100 s)
                const delay = info.delay || 10;
                duration += delay * 10; // Convert to milliseconds
                }

                return duration;
            }

            async function onGifFinish(url, callback) {
                // const buffer = await fetchGifAsBuffer(url);
                // const duration = getGifDuration(buffer);
                // console.log(`GIF duration: ${duration}ms`);
                setTimeout(callback, 4500);
            }

            const gifElement = document.getElementById("img_top");
            const gifUrl = gifElement.src;

            onGifFinish(gifUrl, () => {
                // console.log("GIF finished playing once.");
                document.getElementById('img_top').src = 'volcano-part-2-complete.gif'
                // Add your custom logic here
            });


            isFreeSpinMode = true;
            freeSpinCount = freeSpinCount + 13;
            if (gameMode.mode === "live"){
                bonusMultiplier = result.bonus_multiplier;
            }
            originalBetAmount = stake;


            document.getElementById('freespins_display').style.display = "flex";
            document.getElementById('normalspins_display').style.display = "none";

            // remainingFreeSpinCount += 1
            document.getElementById('remaining_fs_holder').innerHTML = remainingFreeSpinCount;
            document.getElementById('total_fs_holder').innerHTML = freeSpinCount;


            // Update free spins indicator
            // freeSpinsIndicator.style.display = 'block';
            freeSpinsCountElement.textContent = freeSpinCount;
            bonusMultiplierElement.textContent = bonusMultiplier;
            
            
    } 
    else if (apiResult.triggerFreeSpins && isFreeSpinMode) {
        // Additional free spins during free spin mode
        setTimeout(() => {
            freeSpinsOverlayImg.style.display = "none";
            freeSpinsOverlayImg2.style.display = "block";
            freeSpinsOverlay.style.display = 'block';
            
            // Hide overlay after 3 seconds
            setTimeout(() => {
                freeSpinsOverlay.style.display = 'none';
                
                // Add more free spins
                freeSpinCount += 13;
                
                // Update displays
                document.getElementById('remaining_fs_holder').innerHTML = remainingFreeSpinCount;
                document.getElementById('total_fs_holder').innerHTML = freeSpinCount;
                
                // Update free spins indicator
                freeSpinsCountElement.textContent = freeSpinCount;
                
                // Continue free spins
                setTimeout(() => {
                    if (!spinning) {
                        spin();
                    }
                }, 1000);
            }, 3000);
        }, 1000);
    }
    else if (isFreeSpinMode) {
        // Already in free spin mode
        remainingFreeSpinCount += 1;
        
        // Update displays
        document.getElementById('remaining_fs_holder').innerHTML = remainingFreeSpinCount;
        
        // Check if free spins are over
        if (remainingFreeSpinCount >= freeSpinCount) {
            // End free spins
            if (soundEffectsEnabled) {
                freeSpinSound.pause();
                backgroundMusic.play().catch(e => console.log("Audio play failed:", e));
            }
            
            remainingFreeSpinCount = 0;
            isFreeSpinMode = false;
            bonusMultiplier = 0;
            originalBetAmount = 0;
            freeSpinsIndicator.style.display = 'none';
            
            // Reset displays
            freeSpinsOverlayImg.style.display = "block";
            freeSpinsOverlayImg2.style.display = "none";
            document.getElementById('freespins_display').style.display = "none";
            document.getElementById('normalspins_display').style.display = "flex";
            
            document.getElementById('remaining_fs_holder').innerHTML = 0;
            document.getElementById('total_fs_holder').innerHTML = 0;
            
            // Reset background
            document.getElementById('img_top').src = 'bg-top6.gif'
        } else {
            // Continue free spins
            setTimeout(() => {
                if (!spinning) {
                    spin();
                }
            }, 1500);
        }
    }

    // Update auto spins
    if (autoSpins > 0 && !isFreeSpinMode) {
        if (autoSpinsStopped) {
            autoSpins = 0;
            updateAutoSpinStatus();
            remainingAutoSpins.innerHTML = ' ';
        }
        else {
            autoSpins--;
            if (autoSpins == 0) {
                autoSpinsStopped = true;
                updateAutoSpinStatus();
                remainingAutoSpins.innerHTML = ``;
            } else {
                remainingAutoSpins.innerHTML = `${autoSpins}`;
                if (autoSpins > 0 && balance >= stake) {
                    setTimeout(() => spin(), 1000);
                }
            }
        }
    }
    else if (!isFreeSpinMode) {
        autoSpinsStopped = true;
        updateAutoSpinStatus();
        remainingAutoSpins.innerHTML = ' ';
    }

    // Inside the spinAnimation callback, after all reels have stopped
    if (apiResult.winningPositions && apiResult.winningPositions.length > 0) {
        // Highlight winning symbols after a short delay
        setTimeout(() => {
            highlightWinningSymbols(apiResult.reels, apiResult.winningPositions);
        }, 500);
    }
}

// Modify the spinAnimation function to handle waiting for server results
// Replace the entire spinAnimation function with this updated version
function spinAnimation(callback, apiResult) {
    if (currentInterval) clearInterval(currentInterval);
    
    // If apiResult is null, we're waiting for server results
    const waitingForResults = apiResult === null;
    
    // Normal spin counts for each reel
    let spinCounts = [50, 57, 64, 71, 78]; 
    
    // If waiting for results, set higher spin counts to keep spinning longer
    if (waitingForResults) {
        spinCounts = [200, 220, 240, 260, 280]; // Much higher counts to keep spinning
    }
    // If it's a big win, make the last reel spin longer for dramatic effect
    else if (apiResult && apiResult.win > 100) {
        spinCounts[4] = 90; // Increase the spin count for the last reel
    }
    
    const remainingSpins = [...spinCounts];
    let reelsStoppedCount = 0;
    let isLastReelSlowedDown = false;
    let lastReelInterval = null;
    
    // Calculate dimensions
    const wallThickness = Math.min(canvas.width, canvas.height) * 0.1;
    const reelWidth = (canvas.width - wallThickness * 2) / REEL_COUNT;
    const reelHeight = canvas.height - wallThickness * 2;
    const symbolHeight = reelHeight / SYMBOLS_PER_REEL;
    
    // Speed of symbol movement (pixels per frame)
    const scrollSpeed = isQuickSpinMode ? 40 : 30;
    
    currentInterval = setInterval(() => {
        let allStopped = true;
        
        for (let i = 0; i < REEL_COUNT; i++) {
            // If waiting for results, keep spinning indefinitely
            if (waitingForResults) {
                allStopped = false;
                
                // Move symbols downward
                reels[i].position += scrollSpeed;
                
                // If position exceeds one symbol height, reset and cycle symbols
                if (reels[i].position >= symbolHeight) {
                    reels[i].position = 0;
                    
                    // Move the first symbol to the end
                    const firstSymbol = reels[i].symbols.shift();
                    reels[i].symbols.push(firstSymbol);
                }
                
                continue; // Skip the rest of the loop for this reel
            }
            
            if (remainingSpins[i] > 0) {
                // Move symbols downward
                reels[i].position += scrollSpeed;
                
                // If position exceeds one symbol height, reset and cycle symbols
                if (reels[i].position >= symbolHeight) {
                    reels[i].position = 0;
                    
                    // Move the first symbol to the end
                    const firstSymbol = reels[i].symbols.shift();
                    reels[i].symbols.push(firstSymbol);
                }
                
                // For the last reel, check if we should slow down
                if (i === 4 && reelsStoppedCount >= 4 && !isLastReelSlowedDown && apiResult.win > 100) {
                    // Slow down the last reel by reducing the speed of updates
                    isLastReelSlowedDown = true;
                    clearInterval(currentInterval);
                    
                    // Play reel speed up sound
                    if (soundEffectsEnabled) {
                        reelSpeedUpSound.play().catch(e => console.log("Audio play failed:", e));
                    }
                    
                    // Create a new slower interval just for the last reel
                    lastReelInterval = setInterval(() => {
                        // Move symbols downward at half speed
                        reels[4].position += scrollSpeed / 2;
                        
                        // If position exceeds one symbol height, reset and cycle symbols
                        if (reels[4].position >= symbolHeight) {
                            reels[4].position = 0;
                            
                            // Move the first symbol to the end
                            const firstSymbol = reels[4].symbols.shift();
                            reels[4].symbols.push(firstSymbol);
                        }
                        
                        remainingSpins[4]--;
                        
                        // Redraw the game
                        drawGame();
                        
                        if (remainingSpins[4] <= 0) {
                            // When the last reel is ready to stop, display final symbols
                            reels[4].finalSymbols = apiResult.reels[4];
                            reels[4].isSpinning = false;
                            
                            clearInterval(lastReelInterval);
                            
                            // Stop reel speed up sound
                            if (soundEffectsEnabled) {
                                reelSpeedUpSound.pause();
                                reelSpeedUpSound.currentTime = 0;
                            }
                            
                            spinning = false;
                            featuresButton.disabled = false;
                            callback();
                        }
                    }, isQuickSpinMode ? 40 : 60); // Slower interval for dramatic effect
                    
                    return;
                }
                
                remainingSpins[i]--;
                allStopped = false;
            } else if (remainingSpins[i] === 0) {
                // When a reel is ready to stop, add oscillation effect before displaying final symbols
                const oscillationDuration = isQuickSpinMode ? 75 : 150; // Duration of oscillation in ms
                const startTime = Date.now();
                const oscillationInterval = setInterval(() => {
                    const elapsed = Date.now() - startTime;
                    const progress = Math.min(elapsed / oscillationDuration, 1);
                    
                    // Calculate oscillation amplitude that decreases over time
                    const amplitude = (1 - progress) * symbolHeight * 0.2;
                    
                    // Oscillate position with decreasing amplitude
                    const oscillation = Math.sin(progress * Math.PI * 6) * amplitude;
                    reels[i].position = oscillation;
                    
                    // Redraw the game
                    drawGame();
                    
                    // End oscillation
                    if (progress >= 1) {
                        clearInterval(oscillationInterval);
                        reels[i].position = 0;
                        reels[i].finalSymbols = apiResult.reels[i];
                        reels[i].isSpinning = false;
                        remainingSpins[i] = -1; // Mark as completely stopped
                        reelsStoppedCount++;
                        
                        // Play stop sound for each reel
                        if (soundEffectsEnabled) {
                            // const stopSound = new Audio();
                            // stopSound.src = 'sounds/reel_stop.mp3';
                            // stopSound.volume = 0.3;
                            // stopSound.play().catch(e => console.log("Audio play failed:", e));
                            nothing = 'nothing' //instead of console.log
                        }
                        
                        drawGame();
                    }
                }, 16); // ~60fps for smooth animation
            }
        }
        
        // Redraw the game
        drawGame();
        
        if (allStopped && !waitingForResults) {
            clearInterval(currentInterval);
            spinning = false;
            featuresButton.disabled = false;
            currentInterval = null;
            
            callback();
        }
    }, isQuickSpinMode ? 20 : 30);
}

// Add a function to toggle between demo and live modes
function toggleGameMode() {
    gameMode.mode = gameMode.mode === 'demo' ? 'live' : 'demo';
    
    // Update UI to show current mode
    const modeText = document.querySelector('.text-white.text-center span');
    if (modeText) {
        modeText.textContent = gameMode.mode.toUpperCase() + ' GAME';
    }
    
    console.log('Game mode switched to:', gameMode.mode);
}

// Add a button to toggle game mode in the settings overlay
// Add this to the settingsOverlay div, inside the first div of the overlay-content
// const settingsContent = document.querySelector('#settingsOverlay .overlay-content > div');
// if (settingsContent) {
//     const modeToggleDiv = document.createElement('div');
//     modeToggleDiv.className = 'd-flex justify-content-center my-4';
//     modeToggleDiv.innerHTML = `
//         <button id="toggleModeButton" class="btn btn-gold px-4 py-2">
//             Switch to LIVE Mode
//         </button>
//     `;
//     settingsContent.appendChild(modeToggleDiv);
    
//     // Add event listener to the button
//     document.getElementById('toggleModeButton').addEventListener('click', function() {
//         toggleGameMode();
//         this.textContent = `Switch to ${gameMode.mode === 'demo' ? 'LIVE' : 'DEMO'} Mode`;
//         settingsOverlay.style.display = 'none';
//     });
// }

    // Initialize loading screen
    initLoading();
    
    // Preload images
    preloadImages();
    preloadWildFrames();

    

    // New variables
    
</script>
</body>
</html>
